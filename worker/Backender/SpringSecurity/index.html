<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>Spring Security 5.X | Ada</title><meta name="author" content="Ada"><meta name="copyright" content="Ada"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="Spring Security 5.X"><meta name="application-name" content="Spring Security 5.X"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="Spring Security 5.X"><meta property="og:url" content="https://adalucky.github.io/worker/Backender/SpringSecurity/index.html"><meta property="og:site_name" content="Ada"><meta property="og:description" content="简介Spring Security是一个功能强大且可高度自定义的身份验证和访问控制框架。它是保护基于Spring的应用程序的事实上的标准。 Spring Security是一个专注于为Java应用程序提供身份验证和授权的框架。与所有Spring项目一样，Spring Security的真正强大之处在"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://automation-manage.oss-cn-shanghai.aliyuncs.com/blog/auto/SpringSecurity.jpg"><meta property="article:author" content="Ada"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://automation-manage.oss-cn-shanghai.aliyuncs.com/blog/auto/SpringSecurity.jpg"><link rel="shortcut icon" href="https://image.3001.net/images/20210606/16229390604952.png"><link rel="canonical" href="https://adalucky.github.io/worker/Backender/SpringSecurity/"><link rel="preconnect" href="//npm.elemecdn.com"/><link rel="preconnect" href="//npm.onmicrosoft.cn"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.20/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: false,
  mainTone: {"mode":"both","api":"https://img2color-go.vercel.app/api?img=","cover_change":true},
  authorStatus: undefined,
  algolia: {"appId":"Y7A93ZJERO","apiKey":"c032c0266df92b8e1e7f23f484b1992a","indexName":"hexo","hits":{"per_page":6},"languages":{"input_placeholder":"键入后按下回车搜索！","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#3b70fc","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Spring Security 5.X',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-09-15 12:42:30',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/assets/css/webpushr.css?1"><meta name="generator" content="Hexo 6.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://image.3001.net/images/20210606/16229390604952.png"/><div class="loading-image-dot"></div><div id="loading-percentage">0%</div></div></div><script>if (GLOBAL_CONFIG.preloader.source == "2" || GLOBAL_CONFIG.preloader.source == "3") {
  const loadingPercentage = document.getElementById("loading-percentage");
  let loadingPercentageTimer = setInterval(function() {
    var progressBar = document.querySelector(".pace-progress");
    if (!progressBar) return
    var currentValue = progressBar.getAttribute("data-progress-text");
    if (currentValue !== loadingPercentage.textContent) {
      loadingPercentage.textContent = currentValue;
      if (currentValue === "100%") {
        clearInterval(loadingPercentageTimer);
      }
    }
  }, 100);
}

const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div id="web_box"><div id="web_container"><div id="menu-mask"></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="https://adalucky.github.io/" title="博客" target="_blank"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" href="https://gitee.com/automatex/automate/" title="测试平台" target="_blank"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="测试平台"/><span class="back-menu-item-text">测试平台</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">Ada</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/archives/"><span> 总览</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/categories/"><span> 分类</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/tags/"><span> 标签</span></a></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://automation-manage.oss-cn-shanghai.aliyuncs.com/blog/wechat.png" target="_blank"><img class="post-qr-code-img" alt="wechat" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://automation-manage.oss-cn-shanghai.aliyuncs.com/blog/wechat.png"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="https://automation-manage.oss-cn-shanghai.aliyuncs.com/blog/alipay.png" target="_blank"><img class="post-qr-code-img" alt="alipay" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://automation-manage.oss-cn-shanghai.aliyuncs.com/blog/alipay.png"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> <span>最新评论</span></span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Appium/" style="font-size: 1.05rem;">Appium<sup>1</sup></a><a href="/tags/Axios/" style="font-size: 1.05rem;">Axios<sup>1</sup></a><a href="/tags/Centos/" style="font-size: 1.05rem;">Centos<sup>1</sup></a><a href="/tags/Docker/" style="font-size: 1.05rem;">Docker<sup>2</sup></a><a href="/tags/ES6/" style="font-size: 1.05rem;">ES6<sup>1</sup></a><a href="/tags/Fiddler/" style="font-size: 1.05rem;">Fiddler<sup>1</sup></a><a href="/tags/Gradle/" style="font-size: 1.05rem;">Gradle<sup>1</sup></a><a href="/tags/Hexo/" style="font-size: 1.05rem;">Hexo<sup>2</sup></a><a href="/tags/JDK17/" style="font-size: 1.05rem;">JDK17<sup>1</sup></a><a href="/tags/Java/" style="font-size: 1.05rem;">Java<sup>3</sup></a><a href="/tags/Kafka/" style="font-size: 1.05rem;">Kafka<sup>1</sup></a><a href="/tags/Linux/" style="font-size: 1.05rem;">Linux<sup>1</sup></a><a href="/tags/MQ/" style="font-size: 1.05rem;">MQ<sup>1</sup></a><a href="/tags/MongoDB/" style="font-size: 1.05rem;">MongoDB<sup>1</sup></a><a href="/tags/NPM/" style="font-size: 1.05rem;">NPM<sup>1</sup></a><a href="/tags/NeoVim/" style="font-size: 1.05rem;">NeoVim<sup>1</sup></a><a href="/tags/Nginx/" style="font-size: 1.05rem;">Nginx<sup>2</sup></a><a href="/tags/OSS/" style="font-size: 1.05rem;">OSS<sup>1</sup></a><a href="/tags/Obsidian/" style="font-size: 1.05rem;">Obsidian<sup>1</sup></a><a href="/tags/SpringBoot/" style="font-size: 1.05rem;">SpringBoot<sup>3</sup></a><a href="/tags/TS/" style="font-size: 1.05rem;">TS<sup>3</sup></a><a href="/tags/Tmux/" style="font-size: 1.05rem;">Tmux<sup>1</sup></a><a href="/tags/Vite/" style="font-size: 1.05rem;">Vite<sup>1</sup></a><a href="/tags/Vue3/" style="font-size: 1.05rem;">Vue3<sup>1</sup></a><a href="/tags/Webpack/" style="font-size: 1.05rem;">Webpack<sup>1</sup></a><a href="/tags/Yarn/" style="font-size: 1.05rem;">Yarn<sup>1</sup></a><a href="/tags/asdf/" style="font-size: 1.05rem;">asdf<sup>1</sup></a><a href="/tags/css/" style="font-size: 1.05rem;">css<sup>1</sup></a><a href="/tags/docker/" style="font-size: 1.05rem;">docker<sup>1</sup></a><a href="/tags/docker-compose/" style="font-size: 1.05rem;">docker-compose<sup>1</sup></a><a href="/tags/eslint/" style="font-size: 1.05rem;">eslint<sup>1</sup></a><a href="/tags/html/" style="font-size: 1.05rem;">html<sup>1</sup></a><a href="/tags/jenkins/" style="font-size: 1.05rem;">jenkins<sup>1</sup></a><a href="/tags/pinia/" style="font-size: 1.05rem;">pinia<sup>1</sup></a><a href="/tags/setting/" style="font-size: 1.05rem;">setting<sup>1</sup></a><a href="/tags/%E5%89%8D%E7%AB%AF%E5%9F%BA%E7%A1%80/" style="font-size: 1.05rem;">前端基础<sup>6</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 1.05rem;">数据库<sup>1</sup></a><a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" style="font-size: 1.05rem;">消息队列<sup>1</sup></a><a href="/tags/%E7%8E%AF%E5%A2%83%E7%AE%A1%E7%90%86/" style="font-size: 1.05rem;">环境管理<sup>1</sup></a><a href="/tags/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B/" style="font-size: 1.05rem;">非关系型<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/08/"><span class="card-archive-list-date">八月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/07/"><span class="card-archive-list-date">七月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/06/"><span class="card-archive-list-date">六月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">3</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/05/"><span class="card-archive-list-date">五月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2022/08/"><span class="card-archive-list-date">八月 2022</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">3</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2022/06/"><span class="card-archive-list-date">六月 2022</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2022/05/"><span class="card-archive-list-date">五月 2022</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">3</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2022/04/"><span class="card-archive-list-date">四月 2022</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" onclick="anzhiyu.switchDarkMode()" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item on" id="consoleCommentBarrage" onclick="anzhiyu.switchCommentBarrage()" title="热评开关"><a class="commentBarrage"><i class="anzhiyufont anzhiyu-icon-message"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/Backend/">Backend</a></span><span class="article-meta tags"></span></div></div><h1 class="post-title">Spring Security 5.X</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-04-20T13:42:15.000Z" title="发表于 2022-04-20 21:42:15">2022-04-20</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-09-15T04:42:30.127Z" title="更新于 2023-09-15 12:42:30">2023-09-15</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">15k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>61分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="Spring Security 5.X"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为成都"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>成都</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/worker/Backender/SpringSecurity/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/worker/Backender/SpringSecurity/" itemprop="commentCount"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://automation-manage.oss-cn-shanghai.aliyuncs.com/blog/auto/SpringSecurity.jpg"></div></header><main class="layout" id="content-inner"><div id="post"><div class="post-ai-description"><div class="ai-title"><i class="anzhiyufont anzhiyu-icon-bilibili"></i><div class="ai-title-text">AI-摘要</div><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right"></i><div id="ai-tag">Tianli GPT</div></div><div class="ai-explanation">AI初始化中...</div><div class="ai-btn-box"><div class="ai-btn-item">介绍自己</div><div class="ai-btn-item">生成本文简介</div><div class="ai-btn-item">推荐相关文章</div><div class="ai-btn-item">前往主页</div><div class="ai-btn-item" id="go-tianli-blog">前往tianli博客</div></div><script data-pjax>(function(){
  // 当前随机到的ai摘要到index
  let lastAiRandomIndex = -1;
  let animationRunning = true; // 标志变量，控制动画函数的运行
  // 当前gpt模式
  let mode = "tianli"
  // 刷新点击次数
  let refreshNum = 0
  // 记录上一次传递给aiAbstract的参数
  let prevParam;
  const aiTitleRefreshIcon = document.querySelector(".ai-title .anzhiyufont.anzhiyu-icon-arrow-rotate-right")
  const explanation = document.querySelector(".ai-explanation");
  const post_ai = document.querySelector(".post-ai-description");
  let ai_str = "";
  let ai_str_length = "";
  let delay_init = 600;
  let i = 0;
  let j = 0;
  let sto = [];
  let elapsed = 0;
  const animate = timestamp => {
    if (!animationRunning) {
      return; // 动画函数停止运行
    }
    if (!animate.start) animate.start = timestamp;
    elapsed = timestamp - animate.start;
    if (elapsed >= 20) {
      animate.start = timestamp;
      if (i < ai_str_length - 1) {
        let char = ai_str.charAt(i + 1);
        let delay = /[,.，。!?！？]/.test(char) ? 150 : 20;
        if (explanation.firstElementChild) {
          explanation.removeChild(explanation.firstElementChild);
        }
        explanation.innerHTML += char;
        let div = document.createElement("div");
        div.className = "ai-cursor";
        explanation.appendChild(div);
        i++;
        if (delay === 150) {
          document.querySelector(".ai-explanation .ai-cursor").style.opacity = "0";
        }
        if (i === ai_str_length - 1) {
          observer.disconnect(); // 暂停监听
          explanation.removeChild(explanation.firstElementChild);
        }
        sto[0] = setTimeout(() => {
          requestAnimationFrame(animate);
        }, delay);
      }
    } else {
      requestAnimationFrame(animate);
    }
  };
  const observer = new IntersectionObserver(
    entries => {
      let isVisible = entries[0].isIntersecting;
      animationRunning = isVisible; // 标志变量更新
      if (animationRunning) {
        delay_init = i === 0 ? 200 : 20;
        sto[1] = setTimeout(() => {
          if (j) {
            i = 0;
            j = 0;
          }
          if (i === 0) {
            explanation.innerHTML = ai_str.charAt(0);
          }
          requestAnimationFrame(animate);
        }, delay_init);
      }
    },
    { threshold: 0 }
  );
  function clearSTO() {
    if (sto.length) {
      sto.forEach(item => {
        if (item) {
          clearTimeout(item);
        }
      });
    }
  }
  function startAI(str, df = true) {
    i = 0; //重置计数器
    j = 1;
    clearSTO();
    animationRunning = false;
    elapsed = 0;
    observer.disconnect(); // 暂停上一次监听
    explanation.innerHTML = df ? "生成中. . ." : "请等待. . .";
    ai_str = str;
    ai_str_length = ai_str.length;
    observer.observe(post_ai); //启动新监听
  }

  async function aiAbstract(num = 1000) {
    i = 0; //重置计数器
    j = 1;
    clearSTO();
    animationRunning = false;
    elapsed = 0;
    observer.disconnect(); // 暂停上一次监听
    if (mode === "tianli") {
      num = Math.max(10, Math.min(2000, num));
      const options = {
        key: "4e3ea06311f19e3442c0",
        Referer: "https://adalucky.github.io/"
      };
      const truncateDescription = ("Spring Security 5.X" + "简介, 参考视频, 总览, 认证, 准备工作, 依赖准备, 配置类, 工具类, 数据库配置, 核心代码实现, 库表创建, 重写接口的方法, 启动, 测试, 问题分析, 解决方案, 登录接口实现, 分析, 配置类, 实现, JWT认证过滤器, 创建认证过滤器, 添加JWT 认证过滤器, 验证, 登出操作, 配置项简介, 权限, 权限系统的作用, 授权基本流程, 授权实现, 接口限制访问权限, 封装权限信息, RBAC权限模型, 简介, 建表, 实现, 异常处理, 简介, 自定义实现, 配置类, 跨域, 简介, SpringBoot跨域配置, Spring Security跨域开启, 其它权限认证方式, 简介, hasAnyAuthority, hasRole, hasAnyRole, 自定义认证方法, 思路, 方法实现, 引用, 配置文件认证, 其它, CSRF, 自定义处理器, 认证成功处理器, 认证失败处理器, 登出成功处理器简介是一个功能强大且可高度自定义的身份验证和访问控制框架它是保护基于的应用程序的事实上的标准是一个专注于为应用程序提供身份验证和授权的框架与所有项目一样的真正强大之处在于它可以轻松扩展以满足自定义要求参考视频总览需求环境说明介绍对比快速入门实现前后端分离按钮级权限控制接口权限控制围绕权限模型进行设计是一个功能强大且可高度自定义的身份验证和访问控制框架它是保护基于的应用程序的事实上的标准是一个专注于为应用程序提供身份验证和授权的框架与所有项目一样的真正强大之处在于它可以轻松扩展以满足自定义要求一般来说中大型的项目都是使用来做安全框架小项目有的比较多因为相比与的上手更加的简单一般应用的需要进行认证和授权认证验证当前访问系统的是不是本系统的用户并且要确认具体是哪个用户授权经过认证后判断当前用户是否有权限进行某个操作而认证和授权也是作为安全架的核心功能是家族中的一个安全管理框架相比与另外一个安全框架它提供了更丰富的功能社区资源也比丰富以简单而闻名但讽刺的是很多人发现安装很难有更好的社区支持在处理密码学方面有一个额外的模块对结合较好如果项目用的使用起来很方便但是如果项目中没有用到那就不要考虑它了在工程快速整合在项目中使用我们只需要引入启动器的依赖后重启项目访问进行登录用户名默认为密码在启动的控制台有打印可以自行实现一下访问一个接口如果没有登录会自动重定向到页面也就是说没有登录就无法访问接口认证登陆校验流程原理初探思路分析总结想要知道如何实现自己的登陆流程就必须要先知道入门案例中的流程完整流程的原理其实就是一个过滤器链内部包含了提供各种功能的过滤器这里我们可以看看入门案例中的过滤器过滤器链多个过滤器组成一个过滤器链图中只展示了快速入门中的核心过滤器其它的非核心过滤器并没有在图中展示负责处理我们在登陆页面填写了用户名密码后的登陆请求入门案例的认证工作主要有它负责处理过滤器链中抛出的任何和也就是说在处理中捕获到了异常都可以可以用它处理负责权限校验的过滤器完整的过滤器通过查看当前系统中过滤器链中有哪些过滤器及它们的顺序登录认证流程详解概念速查接口它的实现类表示当前访问系统的用户封装了用户相关信息接口定义了认证的方法接口加载用户特定数据的核心接口里面定义了一个根据用户名查询用户信息的方法接口提供核心用户信息通过根据用户名获取处理的用户信息要封装成对象返回然后将这些信息封装到对象中登录改造思路上面的流程对我们前后端分离的项目有两个地方需要改造步骤我们需要去数据库中查询而不是在内存中查询因此我们要实现接口重新一个实现类步骤步骤我们应该让前端来掉我们自己的然后我们去掉对应的认证最后这个返回的时候需要封装一个回去换成我们自己的登录接口换成我们自己实现了接口的实现了去数据查询用户认证思路上面只是改造了登录登录后请求接口时我们怎么去判断是否已经登录呢是当前用户是谁呢其实我们在上面返回的生成的用了用户去生成所以解析一下就知道是谁了用户详情获取登录返回认证如何获取用户的详情比如权限简单粗暴登录后每次都带有一解析就知道用户然后根据用户去数据库查询对应的权限这种方式就是每次请求都需要去查询用户的权限对数据库来说并不友好现实实践如果能在我们每次登录成功以后就把我们的用户信息写到缓存里面就好了缓存的就是用户就是用户详情会不会刚好有那么一个东西叫做登录自定义登录接口调用的方法进行认证如果认证通过生成把用户信息存入中自定义在这个实现类中去查询数据库校验定义认证过滤器获取解析获取其中的从中获取用户信息存入准备工作依赖准备集成完整的环境配置类创建配置类配置类使用来序列化和反序列化的值的也采用的序列化方式工具类创建一些工具类工具类序列化工具类工具类工具类工具类有效期为一个小时设置秘钥明文生成中要存放的数据格式设置过期时间生成中要存放的数据格式超时时间设置过期时间唯一的主题可以是数据签发者签发时间使用对称加密算法签名第二个参数为秘钥创建设置过期时间生成加密后的秘钥解析序列化序列化工具类工具类通过注入即可完成调用缓存基本的对象实体类等缓存的键值缓存的值缓存基本的对象实体类等缓存的键值缓存的值时间时间颗粒度设置有效时间键超时时间设置成功设置失败设置有效时间键超时时间时间单位设置成功设置失败获得缓存的基本对象缓存键值缓存键值对应的数据删除单个对象删除集合对象多个对象缓存数据缓存的键值待缓存的数据缓存的对象获得缓存的对象缓存的键值缓存键值对应的数据缓存缓存键值缓存的数据缓存数据的对象获得缓存的缓存获得缓存的往中存入数据键键值获取中的数据键键中的对象删除中的数据获取多个中的数据键键集合对象集合获得缓存的基本对象列表字符串前缀对象列表工具类工具类往响应中快速写内容将字符串渲染到客户端渲染对象待渲染的字符串数据库配置相关集成配置数据源配置本地服务器地址注意要开启服务服务器端口默认为若有改动按改动后的来服务器连接密码默认为空若有设置按设置的来连接池最大连接数若为负数则表示没有任何限制连接池最大阻塞等待时间若为负数则表示没有任何限制连接池中的最大空闲连接核心代码实现库表创建建立表密码前先展示用重写接口的方法实现接口重写里面的方法重写接口下的方法因为这个方法默认是从内存中查的用户信息我们需要改为去数据库查询实现接口将用户封装成对象获取权限返回权限资源获取密码返回密码获取账号返回登录账户判断账户是否未过期未过期返回过期返回方法用于判断账户是否未锁定未锁定返回锁定返回用于判断用户凭证是否没过期即密码是否未过期没过期返回过期返回方法用于判断用户是否可用可用返回不可用返回重写方法重新方法实现去数据库查询查询用户信息如果参数无效抛出自定义异常查询用户权限查询成功后封装到对象启动测试重写了上面的方法后我们可以启动一下进行测试这个时候就需要输入我们数据的用户名和密码了如果数据库直接是明文存储的话这里就会抛出问题分析的用户认证流程把前端传过来的用户名去数据查询对应的用户也就是调用我们重写的方法查询到以后通过封装用户信息到会自动调用的实现类也就是我们这里的的获取用户的密码按照默认或者我们指定的加密方式去和获取用户的密码比对比对通过登录成功默认返回用户名或密码错误提示解决方案方案一方案二启动验证注册时密码加密告诉我就是要用明文存你就用明文比对就行了其它的安全不安全泄露不泄露与你不相干这种方式比较粗暴直接直接再数据库的密码前面加上例如简介实际项目中我们不会把密码明文存储在数据库中采用密码加密存储方式也就是在我们注册用户的时候把明文密码以的加密方式进行加密存储在数据库里面验证的时候就把前端的明文再按照之前的加密方式加密一般和数据库返回的用户密码比较一次一样的话密码就是正确的校验通过默认使用的要求数据库中的密码格式为它会根据去判断密码的加密方式但是我们一般不会采用这种方式所以就需要替换也就是要像上面写成我们一般使用为我们提供的我们只需要使用把对象注入容器中就会使用该来进行密码校验我们可以定义一个的配置类要求这个配置类要继承配置类创建注入到容器中让默认以该方式进行加密代码测试加密从下面图片可以看出来同一个明文通过同一种方式最后加密的结果不一样究其原因就是每次使用的盐值不一样位盐值加密后的密文是的版本是次哈希认证密码密码认证结果返回布尔值找一个刚才加密后密文替换数据库之前的重启项目用明文进行登录即可其实很简单就是在实体类的构造方法中对密码进行一次加密即可登录接口实现注意登录登出的接口地址不要用默认的会和的重合防止出现一些意向不到的错误可以命名为这种分析再理一下思路上面我们的登录认证流程详解图中前端请求登录默认用的实现类会去封装前端的账户和密码调用的方法认证调用重写的接口下的去数据库查询用户封装到的实现类返回给在接口中我们通过的方法来进行用户认证所以需要在中配置把注入容器登录接口实现类注入调用方法进行认证调用认证时需要传入对象所以我们用把前端传过来的数据封装成对象调用方法进行认证时候就传这个对象认证返回的结果不是空的就表示有用户信息认证写进去了这个写入和返回给前端即可即可如果认证通过生成写入那么我们只要重写实现类在接口登录的时候调用即可在登录接口需要放行包括注册接口主要涉及到一些不需要用户进行登录就能操作的接口都需要进行放行接下我们需要自定义登陆接口然后让对这个接口放行让用户访问这个接口的时候不用登录也能访问认证成功的话要生成一个放入响应中返回并且为了让用户下回请求时能通过识别出具体的是哪个用户我们需要把用户信息存入可以把用户作为配置类重写这个认证方法注入到容器中配置请求放行等操作自动配置类创建注入到容器中让默认以该方式进行加密重写这个认证方法返回父类的认证方法也就是逻辑还是原来的逻辑目的是为了注入到后我们可以在登录的时候去调用这个对象的认证方法关闭不通过获取对于登录接口注册接口允许匿名访问除上面外的所有请求全部需要鉴权认证实现登录接口实现封装前端的传参调用注入容器中的认证返回的结果不为空后写入缓存和生成返回给前端分别注入登录前端传入的账号和密码封装的统一返回把前端传过来的用户名和密码封装成认证时候需要的对象继承了又实现了调用方法认证就会去调用后面的后面会走到我们自己重写的方法去数据库查询用户信息进行认证方法里面会把用户信息封装到我们自己重写的的实现类认证方法的返回对象就会包含这个的信息认证失败用户名或密码错误登录成功认证过滤器上面的我们已经生成了返回给前端了那么前端请求未放行的接口我们就要去解析是否是正确有效的请求的用户是谁根据解析的用户去中查询用户的信息存入为什么叫认证过滤器呢因为框架有自带的过滤器链然后我们在某个过滤器前面或者后面加入一个自己的过滤器组成一个新的过滤器链创建认证过滤器这个过滤器的作用是为了拦截请求校验用户的身份如果为空的话就放行因为可能是登录接口或者注册接口这里放行了后面拦截器中发现不是登录或者注册接口又没有用户信息传过来就认证失败如果解析失败证明就是非法的请求抛出异常用户未登录解析成功了的话就去根据用户在中取数据注意事项登录成功那个接口写入的和这里取时候的要一致登录成功写入的数据类型和这里取时候接收的数据类型要兼容最好一致过滤器尽量不要用实现因为这种方式可能在不同得版本中一个请求过来过滤器会被调用多次用自定义的认证过滤器插入到的过滤器链一般的过滤器可能会去实现但是这种方式可能在不同得版本中一个请求过来过滤器会被调用多次获取前端头必须要有这个这个参数如果为空就放行不去做解析读写入这里的放行只是当前拦截器放行后面的拦截器还是会去走对应的逻辑解析非法取数据用户未登录存入获取权限信息封装到第三个参数就是权限放行到下一个过滤器添加认证过滤器将我们写的过滤器添加到的过滤器链里面添加的位置根据具体的业务逻辑而定我们这里就需要在最前面添加之前在这个配置类中关闭不通过获取对于登录接口注册接口允许匿名访问除上面外的所有请求全部需要鉴权认证在过滤器前添加我们的自己写的认证过滤器验证到这里为止我们的期望是当前端传过有效后我们去解析然后去中获取用户的信息并把查询存到中写入的时候需要用构造对应的对象对象这个构造函数用两个参数和三个参数的两个参数是用来构造账号密码用于认证的我们用的三个参数的登出操作注意接口命名之前也提过了不要和自带的重名了这一步当我们登出的时候需要做的事情删里面的用户信息注意调用这个接口不需要传参只需要前端传前端调用这个接口时候最先会走我们的认证过滤器这个时候认证通过会把我们的用户信息存在没认证通过的话接口根本访问不到这里直接就会抛出或者其它异常删除缓存的时候也就是从获取到用户然后拼接以后删除登出封装的退出登录的接口不需要传参因为会携带没带的话过滤器会拦截中获取到里面有用户信息来源就是认证过滤器存进去的删除中的缓存退出登录成功配置项简介我们之前重写了配置类这里做一个配置项的一些粗浅简介重写这个不需要注入到中我估摸这这个配置类重写以后就会调用我们自己的配置类算是一种多态吧上层调用会传入一个对象那么我们就可以对用对用的方法进行设置了具体还有那些配置需要用的时候再一下下列示例中的没一行表示一个配置项的结束返回的还是一个所以还是可以继续调用设置方法可以理解为一组设置结束返回的还是一个对象可以继续设置这是我们常见的链式编程设置对于登录接口注册接口允许匿名访问注意不带才能正常访问带了反而会抛异常这就匿名访问下面这种带不带都可以访问关闭不通过获取对于登录接口注册接口允许匿名访问其它的请求任意用户认证通过后都可访问在过滤器前添加我们的自己写的认证过滤器权限权限系统的作用例如一个学校图书馆的管理系统如果是普通学生登录就能看到借书还书相关的功能不可能让他看到并且去使用添加书籍信息删除书籍信息等功能但是如果是一个图书馆管理员的账号登录了应该就能看到并使用添加书籍信息删除书籍信息等功能总结起来就是不同的用户可以使用不同的功能这就是权限系统要去实现的效果我们不能只依赖前端去判断用户的权限来选择显示哪些菜单哪些按钮因为如果只是这样如果有人知道了对应功能的接口地址就可以不通过前端直接去发送请求来实现相关功能操作所以我们还需要在后台进行用户权限的判断判断当前用户是否有相应的权限必须具有所需权限才能进行相应的操作授权基本流程在中会使用默认的来进行权限校验在中会从获取其中的然后获取其中的权限信息然后确认当前用户是否拥有访问当前资源所需的权限如果有权限的话才会放行所以我们项目在登录的时候需要把用户的权限信息也存入对象最后写入到中其它接口进行请求时经过认证锅炉器去取用户信息和和拥有的资源权限并写入到授权实现这里记录一下授权的实现采用自顶向下编写代码这里先采用写死权限的方式快速体验下后面用权限模型优化代码接口限制访问权限就是对我们的接口做权限校验当你需要有某个权限的时候我才让你访问我的接口没有这个权限的话不好意思你谁啊拜拜这里所谓的权限我们就是采用一个字符串来标识当你有这个标识的时候那我就给你放行让你请求我的接口一般实现的方式有两种基于配置的方案这种一般是针对静态资源也就是项目下的静态资源基于注解的方案现在前后端分离的项目都是用这种具体实现在的配置类上添加一个注解开启对应的功能在接口上添加注解你的权限关键字在运行的时候会去读取这个注解里面的参数当做一个表达式读取到了后就会去调用这个方法然后传入你自己的权限关键字去的权限里面比对有没有一模一样的关键字最后返回一个布尔值确定你是否能访问这个接口配置类中开启注解接口上添加权限访问控制注解写入表达式和关键字这个关键字只要是一个字符串都行封装权限信息思路在登录的时候我们就需要去数据库查询出来一些封装给用户对象然后写入这里先写死不去数据查询注意事项我们是用一个集合来接受最好是用一个不能重复的集合并且在数据查询的时候也需要去重双重保障吧后面查数据库权限的时候会再记录涉及变动之前我的代码往中存的都是的对象现在加了一个权限对象所以存的时候只能把拥有这两个对象的存进去了和都是这个对象的属性重新方法实现去数据库查询查询用户信息如果参数无效抛出自定义异常限制数据库只能有一条因为手机号唯一如果不止一条就会抛异常捕获了就抛出自定义异常查询数据不为空后构造到中也就是封装到的对象登录前端传入的账号和密码封装的统一返回把前端传过来的用户名和密码封装成认证时候需要的对象继承了又实现了调用方法认证就会去调用后面的后面会走到我们自己重写的方法去数据库查询用户信息进行认证方法里面会把用户信息封装到我们自己重写的的实现类认证方法的返回对象就会包含这个的信息认证失败用户名或密码错误写入时必须要有对应的方法登录成功将用户封装成对象存储权限集合构造对象用户的权限资源集合的注解不进行序列化因为这个是提供的序列化会报错我们存在中存对象获取权限返回权限资源集合将集合中的标识存入后返回只有第一次为空的时候才会写不为空直接返回权限集合如果修改了用户权限需要删除重新登录一次或者重写写一次权限不然这里权限不为空就获取不到最新的权限了这里优化一些代码加个判断当权限为空的时候先去把权限写入到中如果不为空直接返回这个权限不然每次认证权限的时候调用一次方法都会重复写同样的东西函数式编程先把转换成一个流然后里面的值到一个里里面的每一个对象调用一次的构造方法最后再调用方法收集成一个集合把中类型的权限信息封装成对象获取密码返回密码获取账号返回登录账户判断账户是否未过期未过期返回过期返回方法用于判断账户是否未锁定未锁定返回锁定返回用于判断用户凭证是否没过期即密码是否未过期没过期返回过期返回方法用于判断用户是否可用可用返回不可用返回权限模型简介权限模型即基于角色的权限控制这是目前最常被开发者使用也是相对易用通用权限模型建表按照简介所示图一个我们需要张表进行组成一个基本的的模型创建用户表用户部门登录账号用户昵称用户类型系统用户用户邮箱手机号码用户性别女男保密头像路径密码帐号状态启用禁用删除标志代表未删除代表已删除默认项目最后登陆最后登陆时间创建者创建时间更新者更新时间乐观锁标记备注用户信息表创建权限表菜单名路由地址组件路径菜单状态显示隐藏菜单状态正常停用权限标识菜单图标删除标志代表未删除代表已删除备注菜单表创建角色表角色权限字符串角色状态正常停用备注角色表创建角色权限中间表角色菜单角色权限中间表创建用户角色中间表用户角色用户角色中间表实现实现思路新建一个的实体类接口编写查询用户权限的放在中中声明对应的方法传入的参数类型需要和实体类中的兼容生成文件和自定义可在类上合方法上进行提示填充插件最后把我们写死的权限换成查询的的要注入菜单表实体类对象菜单表菜单名路由地址组件路径菜单状态显示隐藏菜单状态正常停用权限标识菜单图标删除标志代表未删除代表已删除备注菜单表接口异常处理简介我们还希望在认证失败或者是授权失败的情况下也能和我们的接口一样返回相同结构的这样可以让前端能对响应进行统一的处理要实现这个功能我们需要知道的异常处理机制在中如果我们在认证或者授权的过程中出现了异常会被捕获到在中会去判断是认证失败还是授权失败出现的异常如果是认证过程中出现的异常会被封装成然后调用对象的方法去进行异常处理如果是授权过程中出现的异常会被封装成然后调用对象的方法去进行异常处理所以如果我们需要自定义异常处理我们只需要自定义和然后配置给即可自定义实现需要重写两个实现类注意如果有全局异常处理并且捕获的异常类型为或者包含了下面实现类抛出的异常全局的异常捕获会覆盖掉当前的自定义给你的感觉就像是没有生效记得要注入到容器自定义用户认证失败异常用户认证失败请重新登录处理异常自定义权限认证失败异常您的权限不足请联系管理员开通权限处理异常配置类在之前的配置类中加入配置容器中要注入接口然后调用下对应的配置项自动配置类创建注入到容器中让默认以该方式进行加密重写这个认证方法返回父类的认证方法也就是逻辑还是原来的逻辑目的是为了注入到后我们可以在登录的时候去调用这个对象的认证方法关闭不通过获取开始设置请求认证规则对于登录接口注册接口允许匿名访问其它的请求任意用户认证通过后都可访问在过滤器前添加我们的自己写的认证过滤器配置异常处理器配置认证失败授权失败处理器跨域简介浏览器出于安全的考虑使用对象发起请求时必须遵守同源策略否则就是跨域的请求默认情况下是被禁止的同源策略要求源相同才能正常进行通信即协议域名端口号都完全一致前后端分离项目前端项目和后端项目一般都不是同源的所以肯定会存在跨域请求的问题所以我们就要处理一下让前端能进行跨域请求总体分两步配置的跨域策略配置开启允许跨域由于我们的资源都会收到的保护所以想要跨域访问还要让允许跨域访问跨域配置当前我的版本为新跨域配置方案不然访问会有一些报错跨域开启实际发现我上面的配置以后这里不开启也是能跨域的估计和版本以及我上面注入了那个允许跨域其它权限认证方式简介在上面我们想认证一个用户是否有接口的访问权限我们的方式是在入的配置类上添加一个注解然后在接口上添加注解你的权限关键字来进行实现的这里的本质是一种的表达式我们前面都是使用注解然后在在其中使用的是方法进行校验还为我们提供了其它方法例如等可以通过去理解的原理方法实际是执行到了的大家只要断点调试既可知道它内部的校验原理它内部其实是调用的方法获取用户的权限列表然后判断我们存入的方法参数数据在权限列表中还是最好用的方法可以传入多个权限只有用户有其中任意一个权限都可以访问对应资源要求有对应的角色才可以访问但是它内部会把我们传入的参数拼接上后再去比较所以这种情况下要用用户对应的权限也要有这个前缀才可以也就是说如果使用这个方法做权限校验那么在我们数据库存储的权限标识符有任意的角色就可以访问它内部也会把我们传入的参数拼接上后再去比较所以这种情况下要用用户对应的权限也要有这个前缀才可以自定义认证方法思路上面的原理就是在注解中加入自带的认证方法然后传入一个或者多个参数那么我们也可以定义自己的权限校验方法在注解中使用我们的方法方法实现需要起一个别名到时候获取这个的时候就通过这个别名来引用这个里面只是一个简单的示例可以以把集合是否包含换成模糊匹配最终返回一个布尔值比如接口中定义调用的时候传入的是那么就表示这个用户有下的所有权限大概就是这种有可能会用到我这里暂时不涉及就不实现了获取当前用户的权限判断用户权限集合中是否存在引用在表达式中使用相当于获取容器中的名字为的对象然后再调用这个对象的方法配置文件认证上面我们都是通过注解来实现之前也提到过认证一般有两种一种是注解一种是配置配置一般用于对静态文件但是也可以对接口进行这样的权限认证示例如下这里可以把所有需要权限校验的接口都配上看个人喜好可以在这里全配上或者在接口加注解其它是指跨站请求伪造是常见的攻击之一去防止攻击的方式就是通过后端会生成一个前端发起请求的时候需要携带这个后端会有过滤器进行校验如果没有携带或者是伪造的就不允许访问我们可以发现攻击依靠的是中所携带的认证信息但是在前后端分离的项目中我们的认证信息其实是而并不是存储中中并且需要前端代码去把设置到请求头中才可以所以攻击也就不用担心了所以我们就关掉了因为我们请求的时候也没带不关闭反而认证不通过自定义处理器以下的这些方案的前是不采用我们上面哪一套设计方案因为我们上面那一套方案重新了很多过滤器的方法调用的和默认的不一样所以在这里可能就无效了没有去执行父类的默认配置项认证成功处理器实际上在进行登录认证的时候如果登录成功了是会调用的方法进行认证成功后的处理的就是登录成功处理器我们也可以自己去自定义成功处理器进行成功后的相应处理认证成功了认证失败处理器实际上在进行登录认证的时候如果认证失败了是会调用的方法进行认证失败后的处理的就是登录失败处理器我们也可以自己去自定义失败处理器进行失败后的相应处理认证失败了配置认证成功处理器配置认证失败处理器登出成功处理器注销成功配置认证成功处理器配置认证失败处理器配置注销成功处理器").trim().substring(0, num)

      const queryParams = `key=${options.key}&content=${truncateDescription}`;
      const requestOptions = {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
          Referer: options.Referer
        },
      };
      try {
        let animationInterval = null
        if (animationInterval) clearInterval(animationInterval);
        animationInterval = setInterval(() => {
          const animationText = "生成中" + ".".repeat(j);
          explanation.innerHTML = animationText;
          j = (j % 3) + 1; // 在 1、2、3 之间循环
        }, 500);
        const response = await fetch(`https://summary.tianli0.top/?${queryParams}`, requestOptions);
        let result;
        if (response.status === 403) {
          result = {
            summary: "403 refer与key不匹配，本地无法显示。"
          }
        } else if (response.status === 500) {
          result = {
            summary: "500 系统内部错误"
          }
        } else {
          result = await response.json();
        }
        const summary = result.summary.trim();
        setTimeout(() => {
          aiTitleRefreshIcon.style.opacity = "1";
        }, 300)
        startAI(summary);
        clearInterval(animationInterval)
      } catch (error) {
        console.error(error);
        explanation.innerHTML = "发生异常" + error;
      }
    } else {
      const strArr = "true".split(",").map(item => item.trim()); // 将字符串转换为数组，去除每个字符串前后的空格
      if (strArr.length !== 1) {
        let randomIndex = Math.floor(Math.random() * strArr.length); // 随机生成一个索引
        while (randomIndex === lastAiRandomIndex) { // 如果随机到了上次的索引
          randomIndex = Math.floor(Math.random() * strArr.length); // 再次随机
        }
        lastAiRandomIndex = randomIndex; // 更新上次随机到的索引
        startAI(strArr[randomIndex]);
      } else {
        startAI(strArr[0])
      }
      setTimeout(() => {
        aiTitleRefreshIcon.style.opacity = "1";
      }, 600)
    }
  }

  function aiRecommend() {
    i = 0; //重置计数器
    j = 1;
    clearSTO();
    animationRunning = false;
    elapsed = 0;
    explanation.innerHTML = "生成中. . .";
    ai_str = "";
    ai_str_length = "";
    observer.disconnect(); // 暂停上一次监听
    sto[2] = setTimeout(() => {
      explanation.innerHTML = recommendList();
    }, 600);
  }
  function aiGoHome() {
    startAI("正在前往博客主页...", false);
    sto[2] = setTimeout(() => {
      pjax.loadUrl("/");
    }, 1000);
  }
  const ai_btn_item = document.querySelectorAll(".ai-btn-item");
  function Introduce() {
    if (mode == "tianli") {
      startAI("我是文章辅助AI: TianliGPT，点击下方的按钮，让我生成本文简介、推荐相关文章等。")
    } else {
      startAI("我是文章辅助AI: AnZhiYu GPT，点击下方的按钮，让我生成本文简介、推荐相关文章等。")
    }
  }
  function aiTitleRefreshIconClick() {
    aiTitleRefreshIcon.click()
  }
  const aiFunctions = [Introduce, aiTitleRefreshIconClick, aiRecommend, aiGoHome];
  ai_btn_item.forEach((item, index) => {
    item.addEventListener("click", () => {
      aiFunctions[index]();
    });
  });

  function recommendList() {
    let thumbnail = document.querySelectorAll('.relatedPosts-list a');
    if (!thumbnail.length) {
      const cardRecentPost = document.querySelector('.card-widget.card-recent-post'); 
      if (!cardRecentPost) return '';

      thumbnail = cardRecentPost.querySelectorAll('.aside-list-item a');

      let list = '';
      for (let i = 0; i < thumbnail.length; i++) {
        const item = thumbnail[i];
        list += `<div class="ai-recommend-item"><span class="index">${i + 1}：</span><a href="javascript:;" onclick="pjax.loadUrl('${item.href}')" title="${item.title}" data-pjax-state="">${item.title}</a></div>`;
      }
      
      return `很抱歉，无法找到类似的文章，你也可以看看本站最新发布的文章：<br /><div class="ai-recommend">${list}</div>`;
    }

    let list = '';
    for (let i = 0; i < thumbnail.length; i++) {
      const item = thumbnail[i];
      list += `<div class="ai-recommend-item"><span>推荐${i + 1}：</span><a href="javascript:;" onclick="pjax.loadUrl('${item.href}')" title="${item.title}" data-pjax-state="">${item.title}</a></div>`;
    }

    return `推荐文章：<br /><div class="ai-recommend">${list}</div>`;
  }


  function changeShowMode() {
    if (mode === "tianli") {
      mode = "local";
      document.getElementById("ai-tag").innerHTML = "AnZhiYu GPT";
      aiAbstract(1000);
    } else {
      mode = "tianli";
      document.getElementById("ai-tag").innerHTML = "Tianli GPT";

      const truncateDescription = ("" + "简介, 参考视频, 总览, 认证, 准备工作, 依赖准备, 配置类, 工具类, 数据库配置, 核心代码实现, 库表创建, 重写接口的方法, 启动, 测试, 问题分析, 解决方案, 登录接口实现, 分析, 配置类, 实现, JWT认证过滤器, 创建认证过滤器, 添加JWT 认证过滤器, 验证, 登出操作, 配置项简介, 权限, 权限系统的作用, 授权基本流程, 授权实现, 接口限制访问权限, 封装权限信息, RBAC权限模型, 简介, 建表, 实现, 异常处理, 简介, 自定义实现, 配置类, 跨域, 简介, SpringBoot跨域配置, Spring Security跨域开启, 其它权限认证方式, 简介, hasAnyAuthority, hasRole, hasAnyRole, 自定义认证方法, 思路, 方法实现, 引用, 配置文件认证, 其它, CSRF, 自定义处理器, 认证成功处理器, 认证失败处理器, 登出成功处理器简介是一个功能强大且可高度自定义的身份验证和访问控制框架它是保护基于的应用程序的事实上的标准是一个专注于为应用程序提供身份验证和授权的框架与所有项目一样的真正强大之处在于它可以轻松扩展以满足自定义要求参考视频总览需求环境说明介绍对比快速入门实现前后端分离按钮级权限控制接口权限控制围绕权限模型进行设计是一个功能强大且可高度自定义的身份验证和访问控制框架它是保护基于的应用程序的事实上的标准是一个专注于为应用程序提供身份验证和授权的框架与所有项目一样的真正强大之处在于它可以轻松扩展以满足自定义要求一般来说中大型的项目都是使用来做安全框架小项目有的比较多因为相比与的上手更加的简单一般应用的需要进行认证和授权认证验证当前访问系统的是不是本系统的用户并且要确认具体是哪个用户授权经过认证后判断当前用户是否有权限进行某个操作而认证和授权也是作为安全架的核心功能是家族中的一个安全管理框架相比与另外一个安全框架它提供了更丰富的功能社区资源也比丰富以简单而闻名但讽刺的是很多人发现安装很难有更好的社区支持在处理密码学方面有一个额外的模块对结合较好如果项目用的使用起来很方便但是如果项目中没有用到那就不要考虑它了在工程快速整合在项目中使用我们只需要引入启动器的依赖后重启项目访问进行登录用户名默认为密码在启动的控制台有打印可以自行实现一下访问一个接口如果没有登录会自动重定向到页面也就是说没有登录就无法访问接口认证登陆校验流程原理初探思路分析总结想要知道如何实现自己的登陆流程就必须要先知道入门案例中的流程完整流程的原理其实就是一个过滤器链内部包含了提供各种功能的过滤器这里我们可以看看入门案例中的过滤器过滤器链多个过滤器组成一个过滤器链图中只展示了快速入门中的核心过滤器其它的非核心过滤器并没有在图中展示负责处理我们在登陆页面填写了用户名密码后的登陆请求入门案例的认证工作主要有它负责处理过滤器链中抛出的任何和也就是说在处理中捕获到了异常都可以可以用它处理负责权限校验的过滤器完整的过滤器通过查看当前系统中过滤器链中有哪些过滤器及它们的顺序登录认证流程详解概念速查接口它的实现类表示当前访问系统的用户封装了用户相关信息接口定义了认证的方法接口加载用户特定数据的核心接口里面定义了一个根据用户名查询用户信息的方法接口提供核心用户信息通过根据用户名获取处理的用户信息要封装成对象返回然后将这些信息封装到对象中登录改造思路上面的流程对我们前后端分离的项目有两个地方需要改造步骤我们需要去数据库中查询而不是在内存中查询因此我们要实现接口重新一个实现类步骤步骤我们应该让前端来掉我们自己的然后我们去掉对应的认证最后这个返回的时候需要封装一个回去换成我们自己的登录接口换成我们自己实现了接口的实现了去数据查询用户认证思路上面只是改造了登录登录后请求接口时我们怎么去判断是否已经登录呢是当前用户是谁呢其实我们在上面返回的生成的用了用户去生成所以解析一下就知道是谁了用户详情获取登录返回认证如何获取用户的详情比如权限简单粗暴登录后每次都带有一解析就知道用户然后根据用户去数据库查询对应的权限这种方式就是每次请求都需要去查询用户的权限对数据库来说并不友好现实实践如果能在我们每次登录成功以后就把我们的用户信息写到缓存里面就好了缓存的就是用户就是用户详情会不会刚好有那么一个东西叫做登录自定义登录接口调用的方法进行认证如果认证通过生成把用户信息存入中自定义在这个实现类中去查询数据库校验定义认证过滤器获取解析获取其中的从中获取用户信息存入准备工作依赖准备集成完整的环境配置类创建配置类配置类使用来序列化和反序列化的值的也采用的序列化方式工具类创建一些工具类工具类序列化工具类工具类工具类工具类有效期为一个小时设置秘钥明文生成中要存放的数据格式设置过期时间生成中要存放的数据格式超时时间设置过期时间唯一的主题可以是数据签发者签发时间使用对称加密算法签名第二个参数为秘钥创建设置过期时间生成加密后的秘钥解析序列化序列化工具类工具类通过注入即可完成调用缓存基本的对象实体类等缓存的键值缓存的值缓存基本的对象实体类等缓存的键值缓存的值时间时间颗粒度设置有效时间键超时时间设置成功设置失败设置有效时间键超时时间时间单位设置成功设置失败获得缓存的基本对象缓存键值缓存键值对应的数据删除单个对象删除集合对象多个对象缓存数据缓存的键值待缓存的数据缓存的对象获得缓存的对象缓存的键值缓存键值对应的数据缓存缓存键值缓存的数据缓存数据的对象获得缓存的缓存获得缓存的往中存入数据键键值获取中的数据键键中的对象删除中的数据获取多个中的数据键键集合对象集合获得缓存的基本对象列表字符串前缀对象列表工具类工具类往响应中快速写内容将字符串渲染到客户端渲染对象待渲染的字符串数据库配置相关集成配置数据源配置本地服务器地址注意要开启服务服务器端口默认为若有改动按改动后的来服务器连接密码默认为空若有设置按设置的来连接池最大连接数若为负数则表示没有任何限制连接池最大阻塞等待时间若为负数则表示没有任何限制连接池中的最大空闲连接核心代码实现库表创建建立表密码前先展示用重写接口的方法实现接口重写里面的方法重写接口下的方法因为这个方法默认是从内存中查的用户信息我们需要改为去数据库查询实现接口将用户封装成对象获取权限返回权限资源获取密码返回密码获取账号返回登录账户判断账户是否未过期未过期返回过期返回方法用于判断账户是否未锁定未锁定返回锁定返回用于判断用户凭证是否没过期即密码是否未过期没过期返回过期返回方法用于判断用户是否可用可用返回不可用返回重写方法重新方法实现去数据库查询查询用户信息如果参数无效抛出自定义异常查询用户权限查询成功后封装到对象启动测试重写了上面的方法后我们可以启动一下进行测试这个时候就需要输入我们数据的用户名和密码了如果数据库直接是明文存储的话这里就会抛出问题分析的用户认证流程把前端传过来的用户名去数据查询对应的用户也就是调用我们重写的方法查询到以后通过封装用户信息到会自动调用的实现类也就是我们这里的的获取用户的密码按照默认或者我们指定的加密方式去和获取用户的密码比对比对通过登录成功默认返回用户名或密码错误提示解决方案方案一方案二启动验证注册时密码加密告诉我就是要用明文存你就用明文比对就行了其它的安全不安全泄露不泄露与你不相干这种方式比较粗暴直接直接再数据库的密码前面加上例如简介实际项目中我们不会把密码明文存储在数据库中采用密码加密存储方式也就是在我们注册用户的时候把明文密码以的加密方式进行加密存储在数据库里面验证的时候就把前端的明文再按照之前的加密方式加密一般和数据库返回的用户密码比较一次一样的话密码就是正确的校验通过默认使用的要求数据库中的密码格式为它会根据去判断密码的加密方式但是我们一般不会采用这种方式所以就需要替换也就是要像上面写成我们一般使用为我们提供的我们只需要使用把对象注入容器中就会使用该来进行密码校验我们可以定义一个的配置类要求这个配置类要继承配置类创建注入到容器中让默认以该方式进行加密代码测试加密从下面图片可以看出来同一个明文通过同一种方式最后加密的结果不一样究其原因就是每次使用的盐值不一样位盐值加密后的密文是的版本是次哈希认证密码密码认证结果返回布尔值找一个刚才加密后密文替换数据库之前的重启项目用明文进行登录即可其实很简单就是在实体类的构造方法中对密码进行一次加密即可登录接口实现注意登录登出的接口地址不要用默认的会和的重合防止出现一些意向不到的错误可以命名为这种分析再理一下思路上面我们的登录认证流程详解图中前端请求登录默认用的实现类会去封装前端的账户和密码调用的方法认证调用重写的接口下的去数据库查询用户封装到的实现类返回给在接口中我们通过的方法来进行用户认证所以需要在中配置把注入容器登录接口实现类注入调用方法进行认证调用认证时需要传入对象所以我们用把前端传过来的数据封装成对象调用方法进行认证时候就传这个对象认证返回的结果不是空的就表示有用户信息认证写进去了这个写入和返回给前端即可即可如果认证通过生成写入那么我们只要重写实现类在接口登录的时候调用即可在登录接口需要放行包括注册接口主要涉及到一些不需要用户进行登录就能操作的接口都需要进行放行接下我们需要自定义登陆接口然后让对这个接口放行让用户访问这个接口的时候不用登录也能访问认证成功的话要生成一个放入响应中返回并且为了让用户下回请求时能通过识别出具体的是哪个用户我们需要把用户信息存入可以把用户作为配置类重写这个认证方法注入到容器中配置请求放行等操作自动配置类创建注入到容器中让默认以该方式进行加密重写这个认证方法返回父类的认证方法也就是逻辑还是原来的逻辑目的是为了注入到后我们可以在登录的时候去调用这个对象的认证方法关闭不通过获取对于登录接口注册接口允许匿名访问除上面外的所有请求全部需要鉴权认证实现登录接口实现封装前端的传参调用注入容器中的认证返回的结果不为空后写入缓存和生成返回给前端分别注入登录前端传入的账号和密码封装的统一返回把前端传过来的用户名和密码封装成认证时候需要的对象继承了又实现了调用方法认证就会去调用后面的后面会走到我们自己重写的方法去数据库查询用户信息进行认证方法里面会把用户信息封装到我们自己重写的的实现类认证方法的返回对象就会包含这个的信息认证失败用户名或密码错误登录成功认证过滤器上面的我们已经生成了返回给前端了那么前端请求未放行的接口我们就要去解析是否是正确有效的请求的用户是谁根据解析的用户去中查询用户的信息存入为什么叫认证过滤器呢因为框架有自带的过滤器链然后我们在某个过滤器前面或者后面加入一个自己的过滤器组成一个新的过滤器链创建认证过滤器这个过滤器的作用是为了拦截请求校验用户的身份如果为空的话就放行因为可能是登录接口或者注册接口这里放行了后面拦截器中发现不是登录或者注册接口又没有用户信息传过来就认证失败如果解析失败证明就是非法的请求抛出异常用户未登录解析成功了的话就去根据用户在中取数据注意事项登录成功那个接口写入的和这里取时候的要一致登录成功写入的数据类型和这里取时候接收的数据类型要兼容最好一致过滤器尽量不要用实现因为这种方式可能在不同得版本中一个请求过来过滤器会被调用多次用自定义的认证过滤器插入到的过滤器链一般的过滤器可能会去实现但是这种方式可能在不同得版本中一个请求过来过滤器会被调用多次获取前端头必须要有这个这个参数如果为空就放行不去做解析读写入这里的放行只是当前拦截器放行后面的拦截器还是会去走对应的逻辑解析非法取数据用户未登录存入获取权限信息封装到第三个参数就是权限放行到下一个过滤器添加认证过滤器将我们写的过滤器添加到的过滤器链里面添加的位置根据具体的业务逻辑而定我们这里就需要在最前面添加之前在这个配置类中关闭不通过获取对于登录接口注册接口允许匿名访问除上面外的所有请求全部需要鉴权认证在过滤器前添加我们的自己写的认证过滤器验证到这里为止我们的期望是当前端传过有效后我们去解析然后去中获取用户的信息并把查询存到中写入的时候需要用构造对应的对象对象这个构造函数用两个参数和三个参数的两个参数是用来构造账号密码用于认证的我们用的三个参数的登出操作注意接口命名之前也提过了不要和自带的重名了这一步当我们登出的时候需要做的事情删里面的用户信息注意调用这个接口不需要传参只需要前端传前端调用这个接口时候最先会走我们的认证过滤器这个时候认证通过会把我们的用户信息存在没认证通过的话接口根本访问不到这里直接就会抛出或者其它异常删除缓存的时候也就是从获取到用户然后拼接以后删除登出封装的退出登录的接口不需要传参因为会携带没带的话过滤器会拦截中获取到里面有用户信息来源就是认证过滤器存进去的删除中的缓存退出登录成功配置项简介我们之前重写了配置类这里做一个配置项的一些粗浅简介重写这个不需要注入到中我估摸这这个配置类重写以后就会调用我们自己的配置类算是一种多态吧上层调用会传入一个对象那么我们就可以对用对用的方法进行设置了具体还有那些配置需要用的时候再一下下列示例中的没一行表示一个配置项的结束返回的还是一个所以还是可以继续调用设置方法可以理解为一组设置结束返回的还是一个对象可以继续设置这是我们常见的链式编程设置对于登录接口注册接口允许匿名访问注意不带才能正常访问带了反而会抛异常这就匿名访问下面这种带不带都可以访问关闭不通过获取对于登录接口注册接口允许匿名访问其它的请求任意用户认证通过后都可访问在过滤器前添加我们的自己写的认证过滤器权限权限系统的作用例如一个学校图书馆的管理系统如果是普通学生登录就能看到借书还书相关的功能不可能让他看到并且去使用添加书籍信息删除书籍信息等功能但是如果是一个图书馆管理员的账号登录了应该就能看到并使用添加书籍信息删除书籍信息等功能总结起来就是不同的用户可以使用不同的功能这就是权限系统要去实现的效果我们不能只依赖前端去判断用户的权限来选择显示哪些菜单哪些按钮因为如果只是这样如果有人知道了对应功能的接口地址就可以不通过前端直接去发送请求来实现相关功能操作所以我们还需要在后台进行用户权限的判断判断当前用户是否有相应的权限必须具有所需权限才能进行相应的操作授权基本流程在中会使用默认的来进行权限校验在中会从获取其中的然后获取其中的权限信息然后确认当前用户是否拥有访问当前资源所需的权限如果有权限的话才会放行所以我们项目在登录的时候需要把用户的权限信息也存入对象最后写入到中其它接口进行请求时经过认证锅炉器去取用户信息和和拥有的资源权限并写入到授权实现这里记录一下授权的实现采用自顶向下编写代码这里先采用写死权限的方式快速体验下后面用权限模型优化代码接口限制访问权限就是对我们的接口做权限校验当你需要有某个权限的时候我才让你访问我的接口没有这个权限的话不好意思你谁啊拜拜这里所谓的权限我们就是采用一个字符串来标识当你有这个标识的时候那我就给你放行让你请求我的接口一般实现的方式有两种基于配置的方案这种一般是针对静态资源也就是项目下的静态资源基于注解的方案现在前后端分离的项目都是用这种具体实现在的配置类上添加一个注解开启对应的功能在接口上添加注解你的权限关键字在运行的时候会去读取这个注解里面的参数当做一个表达式读取到了后就会去调用这个方法然后传入你自己的权限关键字去的权限里面比对有没有一模一样的关键字最后返回一个布尔值确定你是否能访问这个接口配置类中开启注解接口上添加权限访问控制注解写入表达式和关键字这个关键字只要是一个字符串都行封装权限信息思路在登录的时候我们就需要去数据库查询出来一些封装给用户对象然后写入这里先写死不去数据查询注意事项我们是用一个集合来接受最好是用一个不能重复的集合并且在数据查询的时候也需要去重双重保障吧后面查数据库权限的时候会再记录涉及变动之前我的代码往中存的都是的对象现在加了一个权限对象所以存的时候只能把拥有这两个对象的存进去了和都是这个对象的属性重新方法实现去数据库查询查询用户信息如果参数无效抛出自定义异常限制数据库只能有一条因为手机号唯一如果不止一条就会抛异常捕获了就抛出自定义异常查询数据不为空后构造到中也就是封装到的对象登录前端传入的账号和密码封装的统一返回把前端传过来的用户名和密码封装成认证时候需要的对象继承了又实现了调用方法认证就会去调用后面的后面会走到我们自己重写的方法去数据库查询用户信息进行认证方法里面会把用户信息封装到我们自己重写的的实现类认证方法的返回对象就会包含这个的信息认证失败用户名或密码错误写入时必须要有对应的方法登录成功将用户封装成对象存储权限集合构造对象用户的权限资源集合的注解不进行序列化因为这个是提供的序列化会报错我们存在中存对象获取权限返回权限资源集合将集合中的标识存入后返回只有第一次为空的时候才会写不为空直接返回权限集合如果修改了用户权限需要删除重新登录一次或者重写写一次权限不然这里权限不为空就获取不到最新的权限了这里优化一些代码加个判断当权限为空的时候先去把权限写入到中如果不为空直接返回这个权限不然每次认证权限的时候调用一次方法都会重复写同样的东西函数式编程先把转换成一个流然后里面的值到一个里里面的每一个对象调用一次的构造方法最后再调用方法收集成一个集合把中类型的权限信息封装成对象获取密码返回密码获取账号返回登录账户判断账户是否未过期未过期返回过期返回方法用于判断账户是否未锁定未锁定返回锁定返回用于判断用户凭证是否没过期即密码是否未过期没过期返回过期返回方法用于判断用户是否可用可用返回不可用返回权限模型简介权限模型即基于角色的权限控制这是目前最常被开发者使用也是相对易用通用权限模型建表按照简介所示图一个我们需要张表进行组成一个基本的的模型创建用户表用户部门登录账号用户昵称用户类型系统用户用户邮箱手机号码用户性别女男保密头像路径密码帐号状态启用禁用删除标志代表未删除代表已删除默认项目最后登陆最后登陆时间创建者创建时间更新者更新时间乐观锁标记备注用户信息表创建权限表菜单名路由地址组件路径菜单状态显示隐藏菜单状态正常停用权限标识菜单图标删除标志代表未删除代表已删除备注菜单表创建角色表角色权限字符串角色状态正常停用备注角色表创建角色权限中间表角色菜单角色权限中间表创建用户角色中间表用户角色用户角色中间表实现实现思路新建一个的实体类接口编写查询用户权限的放在中中声明对应的方法传入的参数类型需要和实体类中的兼容生成文件和自定义可在类上合方法上进行提示填充插件最后把我们写死的权限换成查询的的要注入菜单表实体类对象菜单表菜单名路由地址组件路径菜单状态显示隐藏菜单状态正常停用权限标识菜单图标删除标志代表未删除代表已删除备注菜单表接口异常处理简介我们还希望在认证失败或者是授权失败的情况下也能和我们的接口一样返回相同结构的这样可以让前端能对响应进行统一的处理要实现这个功能我们需要知道的异常处理机制在中如果我们在认证或者授权的过程中出现了异常会被捕获到在中会去判断是认证失败还是授权失败出现的异常如果是认证过程中出现的异常会被封装成然后调用对象的方法去进行异常处理如果是授权过程中出现的异常会被封装成然后调用对象的方法去进行异常处理所以如果我们需要自定义异常处理我们只需要自定义和然后配置给即可自定义实现需要重写两个实现类注意如果有全局异常处理并且捕获的异常类型为或者包含了下面实现类抛出的异常全局的异常捕获会覆盖掉当前的自定义给你的感觉就像是没有生效记得要注入到容器自定义用户认证失败异常用户认证失败请重新登录处理异常自定义权限认证失败异常您的权限不足请联系管理员开通权限处理异常配置类在之前的配置类中加入配置容器中要注入接口然后调用下对应的配置项自动配置类创建注入到容器中让默认以该方式进行加密重写这个认证方法返回父类的认证方法也就是逻辑还是原来的逻辑目的是为了注入到后我们可以在登录的时候去调用这个对象的认证方法关闭不通过获取开始设置请求认证规则对于登录接口注册接口允许匿名访问其它的请求任意用户认证通过后都可访问在过滤器前添加我们的自己写的认证过滤器配置异常处理器配置认证失败授权失败处理器跨域简介浏览器出于安全的考虑使用对象发起请求时必须遵守同源策略否则就是跨域的请求默认情况下是被禁止的同源策略要求源相同才能正常进行通信即协议域名端口号都完全一致前后端分离项目前端项目和后端项目一般都不是同源的所以肯定会存在跨域请求的问题所以我们就要处理一下让前端能进行跨域请求总体分两步配置的跨域策略配置开启允许跨域由于我们的资源都会收到的保护所以想要跨域访问还要让允许跨域访问跨域配置当前我的版本为新跨域配置方案不然访问会有一些报错跨域开启实际发现我上面的配置以后这里不开启也是能跨域的估计和版本以及我上面注入了那个允许跨域其它权限认证方式简介在上面我们想认证一个用户是否有接口的访问权限我们的方式是在入的配置类上添加一个注解然后在接口上添加注解你的权限关键字来进行实现的这里的本质是一种的表达式我们前面都是使用注解然后在在其中使用的是方法进行校验还为我们提供了其它方法例如等可以通过去理解的原理方法实际是执行到了的大家只要断点调试既可知道它内部的校验原理它内部其实是调用的方法获取用户的权限列表然后判断我们存入的方法参数数据在权限列表中还是最好用的方法可以传入多个权限只有用户有其中任意一个权限都可以访问对应资源要求有对应的角色才可以访问但是它内部会把我们传入的参数拼接上后再去比较所以这种情况下要用用户对应的权限也要有这个前缀才可以也就是说如果使用这个方法做权限校验那么在我们数据库存储的权限标识符有任意的角色就可以访问它内部也会把我们传入的参数拼接上后再去比较所以这种情况下要用用户对应的权限也要有这个前缀才可以自定义认证方法思路上面的原理就是在注解中加入自带的认证方法然后传入一个或者多个参数那么我们也可以定义自己的权限校验方法在注解中使用我们的方法方法实现需要起一个别名到时候获取这个的时候就通过这个别名来引用这个里面只是一个简单的示例可以以把集合是否包含换成模糊匹配最终返回一个布尔值比如接口中定义调用的时候传入的是那么就表示这个用户有下的所有权限大概就是这种有可能会用到我这里暂时不涉及就不实现了获取当前用户的权限判断用户权限集合中是否存在引用在表达式中使用相当于获取容器中的名字为的对象然后再调用这个对象的方法配置文件认证上面我们都是通过注解来实现之前也提到过认证一般有两种一种是注解一种是配置配置一般用于对静态文件但是也可以对接口进行这样的权限认证示例如下这里可以把所有需要权限校验的接口都配上看个人喜好可以在这里全配上或者在接口加注解其它是指跨站请求伪造是常见的攻击之一去防止攻击的方式就是通过后端会生成一个前端发起请求的时候需要携带这个后端会有过滤器进行校验如果没有携带或者是伪造的就不允许访问我们可以发现攻击依靠的是中所携带的认证信息但是在前后端分离的项目中我们的认证信息其实是而并不是存储中中并且需要前端代码去把设置到请求头中才可以所以攻击也就不用担心了所以我们就关掉了因为我们请求的时候也没带不关闭反而认证不通过自定义处理器以下的这些方案的前是不采用我们上面哪一套设计方案因为我们上面那一套方案重新了很多过滤器的方法调用的和默认的不一样所以在这里可能就无效了没有去执行父类的默认配置项认证成功处理器实际上在进行登录认证的时候如果登录成功了是会调用的方法进行认证成功后的处理的就是登录成功处理器我们也可以自己去自定义成功处理器进行成功后的相应处理认证成功了认证失败处理器实际上在进行登录认证的时候如果认证失败了是会调用的方法进行认证失败后的处理的就是登录失败处理器我们也可以自己去自定义失败处理器进行失败后的相应处理认证失败了配置认证成功处理器配置认证失败处理器登出成功处理器注销成功配置认证成功处理器配置认证失败处理器配置注销成功处理器").trim().substring(0, 1000);
      let value = Math.floor(Math.random() * 3) + 1000;
      while (value === prevParam || truncateDescription.length - value === prevParam) {
        value = Math.floor(Math.random() * 3) + 1000;
      }
      aiTitleRefreshIcon.style.opacity = "0.2";
      aiTitleRefreshIcon.style.transitionDuration = "0.3s";
      aiTitleRefreshIcon.style.transform = "rotate(" + 360 * refreshNum + "deg)";
      if (truncateDescription.length <= 1000) {
        let param = truncateDescription.length - Math.floor(Math.random() * 3);
        while (param === prevParam) {
          param = truncateDescription.length - Math.floor(Math.random() * 3);
        }
        aiAbstract(param);
        prevParam = param;
      } else {
        aiAbstract(value);
        prevParam = value;
      }
      refreshNum++;
    }
  }

  //- 监听tag点击事件
  document.getElementById("ai-tag").addEventListener("click", () => {
    if (mode === "tianli") {
      document.querySelectorAll(".ai-btn-item").forEach(item => item.style.display = "none");
      document.getElementById("go-tianli-blog").style.display = "block";
      startAI("你好，我是Tianli开发的摘要生成助理TianliGPT，是一个基于GPT-4的生成式AI。我在这里只负责摘要的预生成和显示，你无法与我直接沟通，如果你也需要一个这样的AI摘要接口，可以在下方购买。（暂未开放购买，敬请期待）")
    } else {
      document.getElementById("go-tianli-blog").style.display = "none";
      startAI("你好，我是本站摘要生成助理AnZhiYu GPT，是一个基于GPT-4的生成式AI。我在这里只负责摘要的预生成和显示，你无法与我直接沟通。")
    }

  });

  aiTitleRefreshIcon.addEventListener("click", () => {
    const truncateDescription = ("" + "简介, 参考视频, 总览, 认证, 准备工作, 依赖准备, 配置类, 工具类, 数据库配置, 核心代码实现, 库表创建, 重写接口的方法, 启动, 测试, 问题分析, 解决方案, 登录接口实现, 分析, 配置类, 实现, JWT认证过滤器, 创建认证过滤器, 添加JWT 认证过滤器, 验证, 登出操作, 配置项简介, 权限, 权限系统的作用, 授权基本流程, 授权实现, 接口限制访问权限, 封装权限信息, RBAC权限模型, 简介, 建表, 实现, 异常处理, 简介, 自定义实现, 配置类, 跨域, 简介, SpringBoot跨域配置, Spring Security跨域开启, 其它权限认证方式, 简介, hasAnyAuthority, hasRole, hasAnyRole, 自定义认证方法, 思路, 方法实现, 引用, 配置文件认证, 其它, CSRF, 自定义处理器, 认证成功处理器, 认证失败处理器, 登出成功处理器简介是一个功能强大且可高度自定义的身份验证和访问控制框架它是保护基于的应用程序的事实上的标准是一个专注于为应用程序提供身份验证和授权的框架与所有项目一样的真正强大之处在于它可以轻松扩展以满足自定义要求参考视频总览需求环境说明介绍对比快速入门实现前后端分离按钮级权限控制接口权限控制围绕权限模型进行设计是一个功能强大且可高度自定义的身份验证和访问控制框架它是保护基于的应用程序的事实上的标准是一个专注于为应用程序提供身份验证和授权的框架与所有项目一样的真正强大之处在于它可以轻松扩展以满足自定义要求一般来说中大型的项目都是使用来做安全框架小项目有的比较多因为相比与的上手更加的简单一般应用的需要进行认证和授权认证验证当前访问系统的是不是本系统的用户并且要确认具体是哪个用户授权经过认证后判断当前用户是否有权限进行某个操作而认证和授权也是作为安全架的核心功能是家族中的一个安全管理框架相比与另外一个安全框架它提供了更丰富的功能社区资源也比丰富以简单而闻名但讽刺的是很多人发现安装很难有更好的社区支持在处理密码学方面有一个额外的模块对结合较好如果项目用的使用起来很方便但是如果项目中没有用到那就不要考虑它了在工程快速整合在项目中使用我们只需要引入启动器的依赖后重启项目访问进行登录用户名默认为密码在启动的控制台有打印可以自行实现一下访问一个接口如果没有登录会自动重定向到页面也就是说没有登录就无法访问接口认证登陆校验流程原理初探思路分析总结想要知道如何实现自己的登陆流程就必须要先知道入门案例中的流程完整流程的原理其实就是一个过滤器链内部包含了提供各种功能的过滤器这里我们可以看看入门案例中的过滤器过滤器链多个过滤器组成一个过滤器链图中只展示了快速入门中的核心过滤器其它的非核心过滤器并没有在图中展示负责处理我们在登陆页面填写了用户名密码后的登陆请求入门案例的认证工作主要有它负责处理过滤器链中抛出的任何和也就是说在处理中捕获到了异常都可以可以用它处理负责权限校验的过滤器完整的过滤器通过查看当前系统中过滤器链中有哪些过滤器及它们的顺序登录认证流程详解概念速查接口它的实现类表示当前访问系统的用户封装了用户相关信息接口定义了认证的方法接口加载用户特定数据的核心接口里面定义了一个根据用户名查询用户信息的方法接口提供核心用户信息通过根据用户名获取处理的用户信息要封装成对象返回然后将这些信息封装到对象中登录改造思路上面的流程对我们前后端分离的项目有两个地方需要改造步骤我们需要去数据库中查询而不是在内存中查询因此我们要实现接口重新一个实现类步骤步骤我们应该让前端来掉我们自己的然后我们去掉对应的认证最后这个返回的时候需要封装一个回去换成我们自己的登录接口换成我们自己实现了接口的实现了去数据查询用户认证思路上面只是改造了登录登录后请求接口时我们怎么去判断是否已经登录呢是当前用户是谁呢其实我们在上面返回的生成的用了用户去生成所以解析一下就知道是谁了用户详情获取登录返回认证如何获取用户的详情比如权限简单粗暴登录后每次都带有一解析就知道用户然后根据用户去数据库查询对应的权限这种方式就是每次请求都需要去查询用户的权限对数据库来说并不友好现实实践如果能在我们每次登录成功以后就把我们的用户信息写到缓存里面就好了缓存的就是用户就是用户详情会不会刚好有那么一个东西叫做登录自定义登录接口调用的方法进行认证如果认证通过生成把用户信息存入中自定义在这个实现类中去查询数据库校验定义认证过滤器获取解析获取其中的从中获取用户信息存入准备工作依赖准备集成完整的环境配置类创建配置类配置类使用来序列化和反序列化的值的也采用的序列化方式工具类创建一些工具类工具类序列化工具类工具类工具类工具类有效期为一个小时设置秘钥明文生成中要存放的数据格式设置过期时间生成中要存放的数据格式超时时间设置过期时间唯一的主题可以是数据签发者签发时间使用对称加密算法签名第二个参数为秘钥创建设置过期时间生成加密后的秘钥解析序列化序列化工具类工具类通过注入即可完成调用缓存基本的对象实体类等缓存的键值缓存的值缓存基本的对象实体类等缓存的键值缓存的值时间时间颗粒度设置有效时间键超时时间设置成功设置失败设置有效时间键超时时间时间单位设置成功设置失败获得缓存的基本对象缓存键值缓存键值对应的数据删除单个对象删除集合对象多个对象缓存数据缓存的键值待缓存的数据缓存的对象获得缓存的对象缓存的键值缓存键值对应的数据缓存缓存键值缓存的数据缓存数据的对象获得缓存的缓存获得缓存的往中存入数据键键值获取中的数据键键中的对象删除中的数据获取多个中的数据键键集合对象集合获得缓存的基本对象列表字符串前缀对象列表工具类工具类往响应中快速写内容将字符串渲染到客户端渲染对象待渲染的字符串数据库配置相关集成配置数据源配置本地服务器地址注意要开启服务服务器端口默认为若有改动按改动后的来服务器连接密码默认为空若有设置按设置的来连接池最大连接数若为负数则表示没有任何限制连接池最大阻塞等待时间若为负数则表示没有任何限制连接池中的最大空闲连接核心代码实现库表创建建立表密码前先展示用重写接口的方法实现接口重写里面的方法重写接口下的方法因为这个方法默认是从内存中查的用户信息我们需要改为去数据库查询实现接口将用户封装成对象获取权限返回权限资源获取密码返回密码获取账号返回登录账户判断账户是否未过期未过期返回过期返回方法用于判断账户是否未锁定未锁定返回锁定返回用于判断用户凭证是否没过期即密码是否未过期没过期返回过期返回方法用于判断用户是否可用可用返回不可用返回重写方法重新方法实现去数据库查询查询用户信息如果参数无效抛出自定义异常查询用户权限查询成功后封装到对象启动测试重写了上面的方法后我们可以启动一下进行测试这个时候就需要输入我们数据的用户名和密码了如果数据库直接是明文存储的话这里就会抛出问题分析的用户认证流程把前端传过来的用户名去数据查询对应的用户也就是调用我们重写的方法查询到以后通过封装用户信息到会自动调用的实现类也就是我们这里的的获取用户的密码按照默认或者我们指定的加密方式去和获取用户的密码比对比对通过登录成功默认返回用户名或密码错误提示解决方案方案一方案二启动验证注册时密码加密告诉我就是要用明文存你就用明文比对就行了其它的安全不安全泄露不泄露与你不相干这种方式比较粗暴直接直接再数据库的密码前面加上例如简介实际项目中我们不会把密码明文存储在数据库中采用密码加密存储方式也就是在我们注册用户的时候把明文密码以的加密方式进行加密存储在数据库里面验证的时候就把前端的明文再按照之前的加密方式加密一般和数据库返回的用户密码比较一次一样的话密码就是正确的校验通过默认使用的要求数据库中的密码格式为它会根据去判断密码的加密方式但是我们一般不会采用这种方式所以就需要替换也就是要像上面写成我们一般使用为我们提供的我们只需要使用把对象注入容器中就会使用该来进行密码校验我们可以定义一个的配置类要求这个配置类要继承配置类创建注入到容器中让默认以该方式进行加密代码测试加密从下面图片可以看出来同一个明文通过同一种方式最后加密的结果不一样究其原因就是每次使用的盐值不一样位盐值加密后的密文是的版本是次哈希认证密码密码认证结果返回布尔值找一个刚才加密后密文替换数据库之前的重启项目用明文进行登录即可其实很简单就是在实体类的构造方法中对密码进行一次加密即可登录接口实现注意登录登出的接口地址不要用默认的会和的重合防止出现一些意向不到的错误可以命名为这种分析再理一下思路上面我们的登录认证流程详解图中前端请求登录默认用的实现类会去封装前端的账户和密码调用的方法认证调用重写的接口下的去数据库查询用户封装到的实现类返回给在接口中我们通过的方法来进行用户认证所以需要在中配置把注入容器登录接口实现类注入调用方法进行认证调用认证时需要传入对象所以我们用把前端传过来的数据封装成对象调用方法进行认证时候就传这个对象认证返回的结果不是空的就表示有用户信息认证写进去了这个写入和返回给前端即可即可如果认证通过生成写入那么我们只要重写实现类在接口登录的时候调用即可在登录接口需要放行包括注册接口主要涉及到一些不需要用户进行登录就能操作的接口都需要进行放行接下我们需要自定义登陆接口然后让对这个接口放行让用户访问这个接口的时候不用登录也能访问认证成功的话要生成一个放入响应中返回并且为了让用户下回请求时能通过识别出具体的是哪个用户我们需要把用户信息存入可以把用户作为配置类重写这个认证方法注入到容器中配置请求放行等操作自动配置类创建注入到容器中让默认以该方式进行加密重写这个认证方法返回父类的认证方法也就是逻辑还是原来的逻辑目的是为了注入到后我们可以在登录的时候去调用这个对象的认证方法关闭不通过获取对于登录接口注册接口允许匿名访问除上面外的所有请求全部需要鉴权认证实现登录接口实现封装前端的传参调用注入容器中的认证返回的结果不为空后写入缓存和生成返回给前端分别注入登录前端传入的账号和密码封装的统一返回把前端传过来的用户名和密码封装成认证时候需要的对象继承了又实现了调用方法认证就会去调用后面的后面会走到我们自己重写的方法去数据库查询用户信息进行认证方法里面会把用户信息封装到我们自己重写的的实现类认证方法的返回对象就会包含这个的信息认证失败用户名或密码错误登录成功认证过滤器上面的我们已经生成了返回给前端了那么前端请求未放行的接口我们就要去解析是否是正确有效的请求的用户是谁根据解析的用户去中查询用户的信息存入为什么叫认证过滤器呢因为框架有自带的过滤器链然后我们在某个过滤器前面或者后面加入一个自己的过滤器组成一个新的过滤器链创建认证过滤器这个过滤器的作用是为了拦截请求校验用户的身份如果为空的话就放行因为可能是登录接口或者注册接口这里放行了后面拦截器中发现不是登录或者注册接口又没有用户信息传过来就认证失败如果解析失败证明就是非法的请求抛出异常用户未登录解析成功了的话就去根据用户在中取数据注意事项登录成功那个接口写入的和这里取时候的要一致登录成功写入的数据类型和这里取时候接收的数据类型要兼容最好一致过滤器尽量不要用实现因为这种方式可能在不同得版本中一个请求过来过滤器会被调用多次用自定义的认证过滤器插入到的过滤器链一般的过滤器可能会去实现但是这种方式可能在不同得版本中一个请求过来过滤器会被调用多次获取前端头必须要有这个这个参数如果为空就放行不去做解析读写入这里的放行只是当前拦截器放行后面的拦截器还是会去走对应的逻辑解析非法取数据用户未登录存入获取权限信息封装到第三个参数就是权限放行到下一个过滤器添加认证过滤器将我们写的过滤器添加到的过滤器链里面添加的位置根据具体的业务逻辑而定我们这里就需要在最前面添加之前在这个配置类中关闭不通过获取对于登录接口注册接口允许匿名访问除上面外的所有请求全部需要鉴权认证在过滤器前添加我们的自己写的认证过滤器验证到这里为止我们的期望是当前端传过有效后我们去解析然后去中获取用户的信息并把查询存到中写入的时候需要用构造对应的对象对象这个构造函数用两个参数和三个参数的两个参数是用来构造账号密码用于认证的我们用的三个参数的登出操作注意接口命名之前也提过了不要和自带的重名了这一步当我们登出的时候需要做的事情删里面的用户信息注意调用这个接口不需要传参只需要前端传前端调用这个接口时候最先会走我们的认证过滤器这个时候认证通过会把我们的用户信息存在没认证通过的话接口根本访问不到这里直接就会抛出或者其它异常删除缓存的时候也就是从获取到用户然后拼接以后删除登出封装的退出登录的接口不需要传参因为会携带没带的话过滤器会拦截中获取到里面有用户信息来源就是认证过滤器存进去的删除中的缓存退出登录成功配置项简介我们之前重写了配置类这里做一个配置项的一些粗浅简介重写这个不需要注入到中我估摸这这个配置类重写以后就会调用我们自己的配置类算是一种多态吧上层调用会传入一个对象那么我们就可以对用对用的方法进行设置了具体还有那些配置需要用的时候再一下下列示例中的没一行表示一个配置项的结束返回的还是一个所以还是可以继续调用设置方法可以理解为一组设置结束返回的还是一个对象可以继续设置这是我们常见的链式编程设置对于登录接口注册接口允许匿名访问注意不带才能正常访问带了反而会抛异常这就匿名访问下面这种带不带都可以访问关闭不通过获取对于登录接口注册接口允许匿名访问其它的请求任意用户认证通过后都可访问在过滤器前添加我们的自己写的认证过滤器权限权限系统的作用例如一个学校图书馆的管理系统如果是普通学生登录就能看到借书还书相关的功能不可能让他看到并且去使用添加书籍信息删除书籍信息等功能但是如果是一个图书馆管理员的账号登录了应该就能看到并使用添加书籍信息删除书籍信息等功能总结起来就是不同的用户可以使用不同的功能这就是权限系统要去实现的效果我们不能只依赖前端去判断用户的权限来选择显示哪些菜单哪些按钮因为如果只是这样如果有人知道了对应功能的接口地址就可以不通过前端直接去发送请求来实现相关功能操作所以我们还需要在后台进行用户权限的判断判断当前用户是否有相应的权限必须具有所需权限才能进行相应的操作授权基本流程在中会使用默认的来进行权限校验在中会从获取其中的然后获取其中的权限信息然后确认当前用户是否拥有访问当前资源所需的权限如果有权限的话才会放行所以我们项目在登录的时候需要把用户的权限信息也存入对象最后写入到中其它接口进行请求时经过认证锅炉器去取用户信息和和拥有的资源权限并写入到授权实现这里记录一下授权的实现采用自顶向下编写代码这里先采用写死权限的方式快速体验下后面用权限模型优化代码接口限制访问权限就是对我们的接口做权限校验当你需要有某个权限的时候我才让你访问我的接口没有这个权限的话不好意思你谁啊拜拜这里所谓的权限我们就是采用一个字符串来标识当你有这个标识的时候那我就给你放行让你请求我的接口一般实现的方式有两种基于配置的方案这种一般是针对静态资源也就是项目下的静态资源基于注解的方案现在前后端分离的项目都是用这种具体实现在的配置类上添加一个注解开启对应的功能在接口上添加注解你的权限关键字在运行的时候会去读取这个注解里面的参数当做一个表达式读取到了后就会去调用这个方法然后传入你自己的权限关键字去的权限里面比对有没有一模一样的关键字最后返回一个布尔值确定你是否能访问这个接口配置类中开启注解接口上添加权限访问控制注解写入表达式和关键字这个关键字只要是一个字符串都行封装权限信息思路在登录的时候我们就需要去数据库查询出来一些封装给用户对象然后写入这里先写死不去数据查询注意事项我们是用一个集合来接受最好是用一个不能重复的集合并且在数据查询的时候也需要去重双重保障吧后面查数据库权限的时候会再记录涉及变动之前我的代码往中存的都是的对象现在加了一个权限对象所以存的时候只能把拥有这两个对象的存进去了和都是这个对象的属性重新方法实现去数据库查询查询用户信息如果参数无效抛出自定义异常限制数据库只能有一条因为手机号唯一如果不止一条就会抛异常捕获了就抛出自定义异常查询数据不为空后构造到中也就是封装到的对象登录前端传入的账号和密码封装的统一返回把前端传过来的用户名和密码封装成认证时候需要的对象继承了又实现了调用方法认证就会去调用后面的后面会走到我们自己重写的方法去数据库查询用户信息进行认证方法里面会把用户信息封装到我们自己重写的的实现类认证方法的返回对象就会包含这个的信息认证失败用户名或密码错误写入时必须要有对应的方法登录成功将用户封装成对象存储权限集合构造对象用户的权限资源集合的注解不进行序列化因为这个是提供的序列化会报错我们存在中存对象获取权限返回权限资源集合将集合中的标识存入后返回只有第一次为空的时候才会写不为空直接返回权限集合如果修改了用户权限需要删除重新登录一次或者重写写一次权限不然这里权限不为空就获取不到最新的权限了这里优化一些代码加个判断当权限为空的时候先去把权限写入到中如果不为空直接返回这个权限不然每次认证权限的时候调用一次方法都会重复写同样的东西函数式编程先把转换成一个流然后里面的值到一个里里面的每一个对象调用一次的构造方法最后再调用方法收集成一个集合把中类型的权限信息封装成对象获取密码返回密码获取账号返回登录账户判断账户是否未过期未过期返回过期返回方法用于判断账户是否未锁定未锁定返回锁定返回用于判断用户凭证是否没过期即密码是否未过期没过期返回过期返回方法用于判断用户是否可用可用返回不可用返回权限模型简介权限模型即基于角色的权限控制这是目前最常被开发者使用也是相对易用通用权限模型建表按照简介所示图一个我们需要张表进行组成一个基本的的模型创建用户表用户部门登录账号用户昵称用户类型系统用户用户邮箱手机号码用户性别女男保密头像路径密码帐号状态启用禁用删除标志代表未删除代表已删除默认项目最后登陆最后登陆时间创建者创建时间更新者更新时间乐观锁标记备注用户信息表创建权限表菜单名路由地址组件路径菜单状态显示隐藏菜单状态正常停用权限标识菜单图标删除标志代表未删除代表已删除备注菜单表创建角色表角色权限字符串角色状态正常停用备注角色表创建角色权限中间表角色菜单角色权限中间表创建用户角色中间表用户角色用户角色中间表实现实现思路新建一个的实体类接口编写查询用户权限的放在中中声明对应的方法传入的参数类型需要和实体类中的兼容生成文件和自定义可在类上合方法上进行提示填充插件最后把我们写死的权限换成查询的的要注入菜单表实体类对象菜单表菜单名路由地址组件路径菜单状态显示隐藏菜单状态正常停用权限标识菜单图标删除标志代表未删除代表已删除备注菜单表接口异常处理简介我们还希望在认证失败或者是授权失败的情况下也能和我们的接口一样返回相同结构的这样可以让前端能对响应进行统一的处理要实现这个功能我们需要知道的异常处理机制在中如果我们在认证或者授权的过程中出现了异常会被捕获到在中会去判断是认证失败还是授权失败出现的异常如果是认证过程中出现的异常会被封装成然后调用对象的方法去进行异常处理如果是授权过程中出现的异常会被封装成然后调用对象的方法去进行异常处理所以如果我们需要自定义异常处理我们只需要自定义和然后配置给即可自定义实现需要重写两个实现类注意如果有全局异常处理并且捕获的异常类型为或者包含了下面实现类抛出的异常全局的异常捕获会覆盖掉当前的自定义给你的感觉就像是没有生效记得要注入到容器自定义用户认证失败异常用户认证失败请重新登录处理异常自定义权限认证失败异常您的权限不足请联系管理员开通权限处理异常配置类在之前的配置类中加入配置容器中要注入接口然后调用下对应的配置项自动配置类创建注入到容器中让默认以该方式进行加密重写这个认证方法返回父类的认证方法也就是逻辑还是原来的逻辑目的是为了注入到后我们可以在登录的时候去调用这个对象的认证方法关闭不通过获取开始设置请求认证规则对于登录接口注册接口允许匿名访问其它的请求任意用户认证通过后都可访问在过滤器前添加我们的自己写的认证过滤器配置异常处理器配置认证失败授权失败处理器跨域简介浏览器出于安全的考虑使用对象发起请求时必须遵守同源策略否则就是跨域的请求默认情况下是被禁止的同源策略要求源相同才能正常进行通信即协议域名端口号都完全一致前后端分离项目前端项目和后端项目一般都不是同源的所以肯定会存在跨域请求的问题所以我们就要处理一下让前端能进行跨域请求总体分两步配置的跨域策略配置开启允许跨域由于我们的资源都会收到的保护所以想要跨域访问还要让允许跨域访问跨域配置当前我的版本为新跨域配置方案不然访问会有一些报错跨域开启实际发现我上面的配置以后这里不开启也是能跨域的估计和版本以及我上面注入了那个允许跨域其它权限认证方式简介在上面我们想认证一个用户是否有接口的访问权限我们的方式是在入的配置类上添加一个注解然后在接口上添加注解你的权限关键字来进行实现的这里的本质是一种的表达式我们前面都是使用注解然后在在其中使用的是方法进行校验还为我们提供了其它方法例如等可以通过去理解的原理方法实际是执行到了的大家只要断点调试既可知道它内部的校验原理它内部其实是调用的方法获取用户的权限列表然后判断我们存入的方法参数数据在权限列表中还是最好用的方法可以传入多个权限只有用户有其中任意一个权限都可以访问对应资源要求有对应的角色才可以访问但是它内部会把我们传入的参数拼接上后再去比较所以这种情况下要用用户对应的权限也要有这个前缀才可以也就是说如果使用这个方法做权限校验那么在我们数据库存储的权限标识符有任意的角色就可以访问它内部也会把我们传入的参数拼接上后再去比较所以这种情况下要用用户对应的权限也要有这个前缀才可以自定义认证方法思路上面的原理就是在注解中加入自带的认证方法然后传入一个或者多个参数那么我们也可以定义自己的权限校验方法在注解中使用我们的方法方法实现需要起一个别名到时候获取这个的时候就通过这个别名来引用这个里面只是一个简单的示例可以以把集合是否包含换成模糊匹配最终返回一个布尔值比如接口中定义调用的时候传入的是那么就表示这个用户有下的所有权限大概就是这种有可能会用到我这里暂时不涉及就不实现了获取当前用户的权限判断用户权限集合中是否存在引用在表达式中使用相当于获取容器中的名字为的对象然后再调用这个对象的方法配置文件认证上面我们都是通过注解来实现之前也提到过认证一般有两种一种是注解一种是配置配置一般用于对静态文件但是也可以对接口进行这样的权限认证示例如下这里可以把所有需要权限校验的接口都配上看个人喜好可以在这里全配上或者在接口加注解其它是指跨站请求伪造是常见的攻击之一去防止攻击的方式就是通过后端会生成一个前端发起请求的时候需要携带这个后端会有过滤器进行校验如果没有携带或者是伪造的就不允许访问我们可以发现攻击依靠的是中所携带的认证信息但是在前后端分离的项目中我们的认证信息其实是而并不是存储中中并且需要前端代码去把设置到请求头中才可以所以攻击也就不用担心了所以我们就关掉了因为我们请求的时候也没带不关闭反而认证不通过自定义处理器以下的这些方案的前是不采用我们上面哪一套设计方案因为我们上面那一套方案重新了很多过滤器的方法调用的和默认的不一样所以在这里可能就无效了没有去执行父类的默认配置项认证成功处理器实际上在进行登录认证的时候如果登录成功了是会调用的方法进行认证成功后的处理的就是登录成功处理器我们也可以自己去自定义成功处理器进行成功后的相应处理认证成功了认证失败处理器实际上在进行登录认证的时候如果认证失败了是会调用的方法进行认证失败后的处理的就是登录失败处理器我们也可以自己去自定义失败处理器进行失败后的相应处理认证失败了配置认证成功处理器配置认证失败处理器登出成功处理器注销成功配置认证成功处理器配置认证失败处理器配置注销成功处理器").trim().substring(0, 1000);
    let value = Math.floor(Math.random() * 3) + 1000;
    while (value === prevParam || truncateDescription.length - value === prevParam) {
      value = Math.floor(Math.random() * 3) + 1000;
    }
    aiTitleRefreshIcon.style.opacity = "0.2";
    aiTitleRefreshIcon.style.transitionDuration = "0.3s";
    aiTitleRefreshIcon.style.transform = "rotate(" + 360 * refreshNum + "deg)";
    if (truncateDescription.length <= 1000) {
      let param = truncateDescription.length - Math.floor(Math.random() * 3);
      while (param === prevParam) {
        param = truncateDescription.length - Math.floor(Math.random() * 3);
      }
      aiAbstract(param);
      prevParam = param;
    } else {
      aiAbstract(value);
      prevParam = value;
    }
    showAiBtn();
    refreshNum++;
  });

  document.getElementById("go-tianli-blog").addEventListener("click", () => {
    window.open("https://afdian.net/item/886a79d4db6711eda42a52540025c377", "_blank");
  });
  
  if (false) {
    document.getElementById("ai-Toggle").addEventListener("click", () => {
      changeShowMode()
    });
  }

  function showAiBtn() {
    document.querySelectorAll(".ai-btn-item").forEach(item => {
      if (item.id !== "go-tianli-blog") {
        item.style.display = "block";
      }
      if (item.id === "go-tianli-blog") {
        item.style.display = "none";
      }
    });
  }


  aiAbstract();
  showAiBtn()
})()</script></div><article class="post-content" id="article-container"><h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>Spring Security是一个功能强大且可高度自定义的身份验证和访问控制框架。它是保护基于Spring的应用程序的事实上的标准。</p>
<p>Spring Security是一个专注于为Java应用程序提供身份验证和授权的框架。与所有Spring项目一样，Spring Security的真正强大之处在于它可以轻松扩展以满足自定义要求。</p>
<span id="more"></span>

<h2 id="参考视频"><a href="#参考视频" class="headerlink" title="参考视频"></a>参考视频</h2><div style="position: relative; width: 100%; height: 0; padding-bottom: 75%;"><iframe src="//player.bilibili.com/player.html?aid=677478312&bvid=BV1mm4y1X7Hc&cid=464455500&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" style="position: absolute;width: 100%;height: 100%;left: 0;top: 0;"> </iframe></div>

<h1 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h1><div class="tabs" id="总览"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#总览-1">需求</button></li><li class="tab"><button type="button" data-href="#总览-2">环境说明</button></li><li class="tab"><button type="button" data-href="#总览-3">介绍</button></li><li class="tab"><button type="button" data-href="#总览-4">对比Shiro</button></li><li class="tab"><button type="button" data-href="#总览-5">快速入门</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="总览-1"><ol>
<li>实现前后端分离，按钮级权限控制（接口权限控制）</li>
<li>围绕 RBAC 权限模型进行设计</li>
</ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div><div class="tab-item-content" id="总览-2"><ol>
<li>IDEA 2022.1</li>
<li>JDK 17.0.2</li>
<li>Gradle 7.4.1</li>
<li>SpringBoot 2.6.4</li>
<li>Spring Security 5.6.2</li>
</ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div><div class="tab-item-content" id="总览-3"><ol>
<li><strong>Spring Security</strong> 是一个功能强大且可高度自定义的身份验证和访问控制框架。它是保护基于Spring的应用程序的事实上的标准。</li>
<li><strong>Spring Security</strong> 是一个专注于为Java应用程序提供身份验证和授权的框架。与所有Spring项目一样，Spring Security的真正强大之处在于它可以轻松扩展以满足自定义要求。</li>
<li>一般来说中大型的项目都是使用<strong>SpringSecurity</strong> 来做安全框架。小项目有Shiro的比较多，因为相比与SpringSecurity，Shiro的上手更加的简单。</li>
<li>一般Web应用的需要进行<code>认证</code>和<code>授权</code><br>1️⃣ 认证: 验证当前访问系统的是不是本系统的用户，并且要确认具体是哪个用户<br>2️⃣ 授权: 经过认证后判断当前用户是否有权限进行某个操作<br>3️⃣ 而认证和授权也是SpringSecurity作为安全架的核心功能。</li>
</ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div><div class="tab-item-content" id="总览-4"><ol>
<li><strong>Spring Security</strong> 是 Spring 家族中的一个安全管理框架。相比与另外一个安全框架<strong>Shiro</strong>，它提供了更丰富的功能，社区资源也比Shiro丰富。</li>
<li>Spring 以简单而闻名，但讽刺的是很多人发现安装Spring Security很难</li>
<li>Spring Security有更好的社区支持</li>
<li>Apache Shiro 在 Spring Security 处理密码学方面有一个额外的模块</li>
<li>Spring Security 对 Spring 结合较好，如果项目用的 SpringMVC，使用起来很方便。但是如果项目中没有用到Spring，那就不要考虑它了。</li>
</ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div><div class="tab-item-content" id="总览-5"><ol>
<li>在 SpringBoot 工程快速整合 Security</li>
<li>在 SpringBoot 项目中使用 SpringSecurity 我们只需要引入启动器的依赖后重启项目</li>
<li>访问 <strong><a href="http://localhost:port/login">http://localhost:port/login</a></strong> 进行登录</li>
<li>用户名默认为：<strong>user</strong> </li>
<li>密码在启动的控制台有打印</li>
<li>可以自行实现一下，访问一个接口，如果没有登录会自动重定向到 login 页面，也就是说没有登录就无法访问接口</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation(<span class="string">&quot;org.springframework.boot:spring-boot-starter-security&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://automation-manage.oss-cn-shanghai.aliyuncs.com/blog/image-20220421123331236.png" alt="登录"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div></div>

<h1 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h1><div class="tabs" id="认证"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#认证-1">登陆校验流程</button></li><li class="tab"><button type="button" data-href="#认证-2">原理初探</button></li><li class="tab"><button type="button" data-href="#认证-3">思路分析</button></li><li class="tab"><button type="button" data-href="#认证-4">总结</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="认证-1"><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://automation-manage.oss-cn-shanghai.aliyuncs.com/blog/image-20211215094003288.png" alt="登录校验流程"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div><div class="tab-item-content" id="认证-2"><p>想要知道如何实现自己的登陆流程就必须要先知道入门案例中 Spring Security的流程。</p>
<details class="folding-tag" cyan><summary> SpringSecurity完整流程 </summary>
              <div class='content'>
              <ol><li>Spring Security 的原理其实就是一个过滤器链，内部包含了提供各种功能的过滤器。这里我们可以看看入门案例中的过滤器。</li><li>过滤器链:  多个过滤器组成一个过滤器链</li></ol><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://automation-manage.oss-cn-shanghai.aliyuncs.com/blog/image-20220421182750565.png" alt="SpringSecurity流程"></p><p>图中只展示了快速入门中的核心过滤器，其它的非核心过滤器并没有在图中展示。</p><p><strong>UsernamePasswordAuthenticationFilter</strong>:负责处理我们在登陆页面填写了用户名密码后的登陆请求。入门案例的认证工作主要有它负责。</p><p><strong>ExceptionTranslationFilter：</strong> 处理过滤器链中抛出的任何AccessDeniedException和AuthenticationException,也就是说在处理中捕获到了异常都可以可以用它处理</p><p><strong>FilterSecurityInterceptor：</strong> 负责权限校验的过滤器。</p>
              </div>
            </details>

<details class="folding-tag" cyan><summary> 完整的过滤器 </summary>
              <div class='content'>
              <p>通过Debug查看当前系统中 Spring Security 过滤器链中有哪些过滤器及它们的顺序</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">run.getBean(DefaultSecurityFilterChain.class)</span><br></pre></td></tr></table></figure><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://automation-manage.oss-cn-shanghai.aliyuncs.com/blog/image-20220421213753335.png" alt="过滤器链"></p>
              </div>
            </details><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div><div class="tab-item-content" id="认证-3"><details class="folding-tag" cyan><summary> 登录认证流程详解 </summary>
              <div class='content'>
              <p>概念速查<br>1️⃣ <strong>Authentication接口:</strong>  它的实现类，表示当前访问系统的用户，封装了用户相关信息<br>2️⃣ <strong>AuthenticationManager接口：</strong> 定义了认证Authentication的方法<br>3️⃣ <strong>UserDetailsService接口：</strong> 加载用户特定数据的核心接口。里面定义了一个根据用户名查询用户信息的方法<br>4️⃣ <strong>UserDetails接口：</strong> 提供核心用户信息。通过UserDetailsService根据用户名获取处理的用户信息要封装成UserDetails对象返回。然后将这些信息封装到Authentication对象中</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://automation-manage.oss-cn-shanghai.aliyuncs.com/blog/image-20211214151515385.png" alt="认证流程"></p>
              </div>
            </details>

<details class="folding-tag" cyan><summary> 登录改造思路 </summary>
              <div class='content'>
              <ol><li>上面的流程对我们前后端分离的项目有两个地方需要改造 1️⃣ 5.1 步骤 我们需要去数据库中查询而不是在内存中查询，因此我们要实现接口重新一个实现类 2️⃣ 步骤 1 步骤 10 我们应该让前端来掉我们自己的 controller 然后我们去掉对应的认证，最后这个 controller 返回的时候需要封装一个 token 回去</li><li><strong>UsernamePasswordAuthenticationFilter</strong> 换成我们自己的登录接口</li><li><strong>InMemoryUserDetailManager</strong> 换成我们自己实现了 UserDetailsService 接口的实现了去数据查询用户</li></ol><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://automation-manage.oss-cn-shanghai.aliyuncs.com/blog/image-20211215095331510.png" alt="改造流程图"></p>
              </div>
            </details>

<details class="folding-tag" cyan><summary> 认证思路 </summary>
              <div class='content'>
              <ol><li>上面只是改造了登录，登录后，请求接口时我们怎么去判断是否已经登录呢？是当前用户是谁呢？</li><li>其实我们在上面返回的 jwt 生成的 token 用了用户 id 去生成 所以解析一下 token 就知道是谁了</li></ol><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://automation-manage.oss-cn-shanghai.aliyuncs.com/blog/image-20220421225457468.png" alt="用户认证"></p>
              </div>
            </details>

<details class="folding-tag" cyan><summary> 用户详情获取 </summary>
              <div class='content'>
              <ol><li>登录 –&gt; 返回 token –&gt; JWT 认证 –&gt; 如何获取用户的详情？比如权限？</li><li>简单粗暴：登录后每次都带有 token，token 一解析就知道用户 ID,然后根据用户 ID 去数据库查询对应的权限（这种方式就是每次请求都需要去查询用户的权限，对数据库来说并不友好）</li><li>现实实践：如果能在我们每次登录成功以后就把我们的用户信息写到缓存里面就好了,缓存的 key 就是用户 ID, value 就是用户详情 会不会刚好有那么一个东西叫做 Redis</li></ol><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://automation-manage.oss-cn-shanghai.aliyuncs.com/blog/image-20220421235854789.png" alt="用户详情获取思路"></p>
              </div>
            </details><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div><div class="tab-item-content" id="认证-4"><details class="folding-tag" cyan open><summary> 登录 </summary>
              <div class='content'>
              <ol><li>自定义登录接口: 1️⃣ 调用<strong>ProviderManager</strong>的方法进行认证 如果认证通过生成jwt 2️⃣ 把用户信息存入redis中</li><li>自定义<strong>UserDetailsService</strong>,在这个实现类中去查询数据库</li></ol>
              </div>
            </details>


<details class="folding-tag" cyan open><summary> 校验 </summary>
              <div class='content'>
              <ol><li>定义Jwt认证过滤器</li><li>获取token</li><li>解析token获取其中的userid</li><li>从redis中获取用户信息</li><li>存入SecurityContextHolder</li></ol>
              </div>
            </details><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div></div>


<h1 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1><h2 id="依赖准备"><a href="#依赖准备" class="headerlink" title="依赖准备"></a>依赖准备</h2><p>集成完整的环境 <code>Redis</code> <code>fastjson</code> <code>jwt</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">implementation(<span class="string">&quot;org.springframework.boot:spring-boot-starter-data-redis&quot;</span>)</span><br><span class="line">implementation(<span class="string">&quot;com.alibaba:fastjson:1.2.80&quot;</span>)</span><br><span class="line">implementation(<span class="string">&quot;io.jsonwebtoken:jjwt:0.9.1&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="配置类"><a href="#配置类" class="headerlink" title="配置类"></a>配置类</h2><p>创建 Redis 配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.adalucky.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.adalucky.utils.redis.FastJsonRedisSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ada</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> JDK17</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> Redis 配置类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2022/4/22 00:34</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(value = &#123;&quot;unchecked&quot;, &quot;rawtypes&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;Object, Object&gt; <span class="title function_">redisTemplate</span><span class="params">(RedisConnectionFactory connectionFactory)</span> &#123;</span><br><span class="line">        RedisTemplate&lt;Object, Object&gt; template = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;&gt;();</span><br><span class="line">        template.setConnectionFactory(connectionFactory);</span><br><span class="line">        <span class="type">FastJsonRedisSerializer</span> <span class="variable">serializer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FastJsonRedisSerializer</span>(Object.class);</span><br><span class="line">        <span class="comment">// 使用StringRedisSerializer来序列化和反序列化redis的key值</span></span><br><span class="line">        template.setKeySerializer(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>());</span><br><span class="line">        template.setValueSerializer(serializer);</span><br><span class="line">        <span class="comment">// Hash的key也采用StringRedisSerializer的序列化方式</span></span><br><span class="line">        template.setHashKeySerializer(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>());</span><br><span class="line">        template.setHashValueSerializer(serializer);</span><br><span class="line">        template.afterPropertiesSet();</span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="工具类"><a href="#工具类" class="headerlink" title="工具类"></a>工具类</h2><p>创建一些工具类 <code>JWT工具类</code> <code>FastJson序列化Redis</code> <code>RedisTemplate工具类</code> <code>respons工具类</code></p>
<details class="folding-tag" cyan><summary> JWT工具类 </summary>
              <div class='content'>
              <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.adalucky.utils.jwt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Claims;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.JwtBuilder;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Jwts;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.SignatureAlgorithm;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.crypto.SecretKey;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.spec.SecretKeySpec;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ada</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> JDK17</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> JWT工具类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2022/4/22 00:44</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtUtil</span> &#123;</span><br><span class="line">    <span class="comment">//有效期为</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Long</span> <span class="variable">JWT_TTL</span> <span class="operator">=</span> <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000L</span>;<span class="comment">// 60 * 60 *1000  一个小时</span></span><br><span class="line">    <span class="comment">//设置秘钥明文</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">JWT_KEY</span> <span class="operator">=</span> <span class="string">&quot;sangeng&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getUUID</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> UUID.randomUUID().toString().replaceAll(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成jtw</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subject token中要存放的数据（json格式）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">createJWT</span><span class="params">(String subject)</span> &#123;</span><br><span class="line">        <span class="type">JwtBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> getJwtBuilder(subject, <span class="literal">null</span>, getUUID());<span class="comment">// 设置过期时间</span></span><br><span class="line">        <span class="keyword">return</span> builder.compact();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成jtw</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subject   token中要存放的数据（json格式）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ttlMillis token超时时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">createJWT</span><span class="params">(String subject, Long ttlMillis)</span> &#123;</span><br><span class="line">        <span class="type">JwtBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> getJwtBuilder(subject, ttlMillis, getUUID());<span class="comment">// 设置过期时间</span></span><br><span class="line">        <span class="keyword">return</span> builder.compact();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> JwtBuilder <span class="title function_">getJwtBuilder</span><span class="params">(String subject, Long ttlMillis, String uuid)</span> &#123;</span><br><span class="line">        <span class="type">SignatureAlgorithm</span> <span class="variable">signatureAlgorithm</span> <span class="operator">=</span> SignatureAlgorithm.HS256;</span><br><span class="line">        <span class="type">SecretKey</span> <span class="variable">secretKey</span> <span class="operator">=</span> generalKey();</span><br><span class="line">        <span class="type">long</span> <span class="variable">nowMillis</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">Date</span> <span class="variable">now</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>(nowMillis);</span><br><span class="line">        <span class="keyword">if</span> (ttlMillis == <span class="literal">null</span>) &#123;</span><br><span class="line">            ttlMillis = JwtUtil.JWT_TTL;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">long</span> <span class="variable">expMillis</span> <span class="operator">=</span> nowMillis + ttlMillis;</span><br><span class="line">        <span class="type">Date</span> <span class="variable">expDate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>(expMillis);</span><br><span class="line">        <span class="keyword">return</span> Jwts.builder()</span><br><span class="line">                .setId(uuid)              <span class="comment">//唯一的ID</span></span><br><span class="line">                .setSubject(subject)   <span class="comment">// 主题  可以是JSON数据</span></span><br><span class="line">                .setIssuer(<span class="string">&quot;sg&quot;</span>)     <span class="comment">// 签发者</span></span><br><span class="line">                .setIssuedAt(now)      <span class="comment">// 签发时间</span></span><br><span class="line">                .signWith(signatureAlgorithm, secretKey) <span class="comment">//使用HS256对称加密算法签名, 第二个参数为秘钥</span></span><br><span class="line">                .setExpiration(expDate);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建token</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subject</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ttlMillis</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">createJWT</span><span class="params">(String id, String subject, Long ttlMillis)</span> &#123;</span><br><span class="line">        <span class="type">JwtBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> getJwtBuilder(subject, ttlMillis, id);<span class="comment">// 设置过期时间</span></span><br><span class="line">        <span class="keyword">return</span> builder.compact();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> <span class="string">&quot;eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiJjYWM2ZDVhZi1mNjVlLTQ0MDAtYjcxMi0zYWEwOGIyOTIwYjQiLCJzdWIiOiJzZyIsImlzcyI6InNnIiwiaWF0IjoxNjM4MTA2NzEyLCJleHAiOjE2MzgxMTAzMTJ9.JVsSbkP94wuczb4QryQbAke3ysBDIL5ou8fWsbt_ebg&quot;</span>;</span><br><span class="line">        <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> parseJWT(token);</span><br><span class="line">        System.out.println(claims);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成加密后的秘钥 secretKey</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SecretKey <span class="title function_">generalKey</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] encodedKey = Base64.getDecoder().decode(JwtUtil.JWT_KEY);</span><br><span class="line">        <span class="type">SecretKey</span> <span class="variable">key</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SecretKeySpec</span>(encodedKey, <span class="number">0</span>, encodedKey.length, <span class="string">&quot;AES&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jwt</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Claims <span class="title function_">parseJWT</span><span class="params">(String jwt)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">SecretKey</span> <span class="variable">secretKey</span> <span class="operator">=</span> generalKey();</span><br><span class="line">        <span class="keyword">return</span> Jwts.parser()</span><br><span class="line">                .setSigningKey(secretKey)</span><br><span class="line">                .parseClaimsJws(jwt)</span><br><span class="line">                .getBody();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
              </div>
            </details>

<details class="folding-tag" cyan><summary> FastJson序列化Redis </summary>
              <div class='content'>
              <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.adalucky.utils.redis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.serializer.SerializerFeature;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.JavaType;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.type.TypeFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.RedisSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.SerializationException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ada</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> JDK17</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> FastJson序列化Redis    https://blog.51cto.com/binghe001/5211167</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2022/4/22 00:21</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FastJsonRedisSerializer</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">RedisSerializer</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Charset</span> <span class="variable">DEFAULT_CHARSET</span> <span class="operator">=</span> Charset.forName(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">    <span class="keyword">private</span> Class&lt;T&gt; clazz;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FastJsonRedisSerializer</span><span class="params">(Class&lt;T&gt; clazz)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">        <span class="built_in">this</span>.clazz = clazz;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] serialize(T t) <span class="keyword">throws</span> SerializationException &#123;</span><br><span class="line">        <span class="keyword">if</span> (t == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> JSON.toJSONString(t, SerializerFeature.WriteClassName).getBytes(DEFAULT_CHARSET);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">deserialize</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> SerializationException &#123;</span><br><span class="line">        <span class="keyword">if</span> (bytes == <span class="literal">null</span> || bytes.length &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(bytes, DEFAULT_CHARSET);</span><br><span class="line">        <span class="keyword">return</span> JSON.parseObject(str, clazz);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> JavaType <span class="title function_">getJavaType</span><span class="params">(Class&lt;?&gt; clazz)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> TypeFactory.defaultInstance().constructType(clazz);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
              </div>
            </details>


<details class="folding-tag" cyan><summary> RedisTemplate工具类 </summary>
              <div class='content'>
              <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.adalucky.utils.redis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.BoundSetOperations;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.HashOperations;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.ValueOperations;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ada</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> JDK17</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> RedisTemplate工具类，通过 <span class="doctag">@Autowired</span> 注入 RedisCache 即可完成调用</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2022/4/22 00:46</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings(value = &#123;&quot;unchecked&quot;, &quot;rawtypes&quot;&#125;)</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisCache</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 缓存基本的对象，Integer、String、实体类等</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   缓存的键值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 缓存的值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">setCacheObject</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> T value)</span> &#123;</span><br><span class="line">        redisTemplate.opsForValue().set(key, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 缓存基本的对象，Integer、String、实体类等</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key      缓存的键值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value    缓存的值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> timeout  时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> timeUnit 时间颗粒度</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">setCacheObject</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> T value, <span class="keyword">final</span> Integer timeout, <span class="keyword">final</span> TimeUnit timeUnit)</span> &#123;</span><br><span class="line">        redisTemplate.opsForValue().set(key, value, timeout, timeUnit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置有效时间</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key     Redis键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> timeout 超时时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true=设置成功；false=设置失败</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">expire</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> <span class="type">long</span> timeout)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> expire(key, timeout, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置有效时间</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key     Redis键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> timeout 超时时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> unit    时间单位</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true=设置成功；false=设置失败</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">expire</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> <span class="type">long</span> timeout, <span class="keyword">final</span> TimeUnit unit)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.expire(key, timeout, unit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获得缓存的基本对象。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 缓存键值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 缓存键值对应的数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">getCacheObject</span><span class="params">(<span class="keyword">final</span> String key)</span> &#123;</span><br><span class="line">        ValueOperations&lt;String, T&gt; operation = redisTemplate.opsForValue();</span><br><span class="line">        <span class="keyword">return</span> operation.get(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除单个对象</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">deleteObject</span><span class="params">(<span class="keyword">final</span> String key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.delete(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除集合对象</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> collection 多个对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">deleteObject</span><span class="params">(<span class="keyword">final</span> Collection collection)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.delete(collection);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 缓存List数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key      缓存的键值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataList 待缓存的List数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 缓存的对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="type">long</span> <span class="title function_">setCacheList</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> List&lt;T&gt; dataList)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">count</span> <span class="operator">=</span> redisTemplate.opsForList().rightPushAll(key, dataList);</span><br><span class="line">        <span class="keyword">return</span> count == <span class="literal">null</span> ? <span class="number">0</span> : count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获得缓存的list对象</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 缓存的键值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 缓存键值对应的数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; List&lt;T&gt; <span class="title function_">getCacheList</span><span class="params">(<span class="keyword">final</span> String key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForList().range(key, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 缓存Set</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key     缓存键值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataSet 缓存的数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 缓存数据的对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; BoundSetOperations&lt;String, T&gt; <span class="title function_">setCacheSet</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> Set&lt;T&gt; dataSet)</span> &#123;</span><br><span class="line">        BoundSetOperations&lt;String, T&gt; setOperation = redisTemplate.boundSetOps(key);</span><br><span class="line">        Iterator&lt;T&gt; it = dataSet.iterator();</span><br><span class="line">        <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">            setOperation.add(it.next());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> setOperation;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获得缓存的set</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; Set&lt;T&gt; <span class="title function_">getCacheSet</span><span class="params">(<span class="keyword">final</span> String key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForSet().members(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 缓存Map</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataMap</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">setCacheMap</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> Map&lt;String, T&gt; dataMap)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (dataMap != <span class="literal">null</span>) &#123;</span><br><span class="line">            redisTemplate.opsForHash().putAll(key, dataMap);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获得缓存的Map</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; Map&lt;String, T&gt; <span class="title function_">getCacheMap</span><span class="params">(<span class="keyword">final</span> String key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForHash().entries(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 往Hash中存入数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   Redis键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> hKey  Hash键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">setCacheMapValue</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> String hKey, <span class="keyword">final</span> T value)</span> &#123;</span><br><span class="line">        redisTemplate.opsForHash().put(key, hKey, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取Hash中的数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key  Redis键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> hKey Hash键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Hash中的对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">getCacheMapValue</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> String hKey)</span> &#123;</span><br><span class="line">        HashOperations&lt;String, String, T&gt; opsForHash = redisTemplate.opsForHash();</span><br><span class="line">        <span class="keyword">return</span> opsForHash.get(key, hKey);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除Hash中的数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> hkey</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delCacheMapValue</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> String hkey)</span> &#123;</span><br><span class="line">        <span class="type">HashOperations</span> <span class="variable">hashOperations</span> <span class="operator">=</span> redisTemplate.opsForHash();</span><br><span class="line">        hashOperations.delete(key, hkey);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取多个Hash中的数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   Redis键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> hKeys Hash键集合</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Hash对象集合</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; List&lt;T&gt; <span class="title function_">getMultiCacheMapValue</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> Collection&lt;Object&gt; hKeys)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForHash().multiGet(key, hKeys);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获得缓存的基本对象列表</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pattern 字符串前缀</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 对象列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;String&gt; <span class="title function_">keys</span><span class="params">(<span class="keyword">final</span> String pattern)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.keys(pattern);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
              </div>
            </details>


<details class="folding-tag" cyan><summary> respons工具类 </summary>
              <div class='content'>
              <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.adalucky.utils.web;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ada</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> JDK17</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> respons 工具类 往响应中快速写内容</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2022/4/22 00:52</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebUtils</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将字符串渲染到客户端</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response 渲染对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string   待渲染的字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">renderString</span><span class="params">(HttpServletResponse response, String string)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            response.setStatus(<span class="number">200</span>);</span><br><span class="line">            response.setContentType(<span class="string">&quot;application/json&quot;</span>);</span><br><span class="line">            response.setCharacterEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">            response.getWriter().print(string);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
              </div>
            </details>


<h2 id="数据库配置"><a href="#数据库配置" class="headerlink" title="数据库配置"></a>数据库配置</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># spring 相关集成配置</span><br><span class="line">spring:</span><br><span class="line">  # 数据源配置</span><br><span class="line">  datasource:</span><br><span class="line">    driver-<span class="keyword">class</span>-name: com.p6spy.engine.spy.P6SpyDriver</span><br><span class="line">    url: jdbc:p6spy:mysql:<span class="comment">//192.168.1.115:3306/data_auto_endpoint?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=GMT%2B8&amp;useSSL=false</span></span><br><span class="line">    username: root</span><br><span class="line">    password: <span class="number">123456</span></span><br><span class="line">  redis:</span><br><span class="line">    # Redis本地服务器地址，注意要开启redis服务</span><br><span class="line">    host: <span class="number">192.168</span><span class="number">.1</span><span class="number">.115</span></span><br><span class="line">    # Redis服务器端口,默认为<span class="number">6379.</span>若有改动按改动后的来</span><br><span class="line">    port: <span class="number">6379</span></span><br><span class="line">    #Redis服务器连接密码，默认为空，若有设置按设置的来</span><br><span class="line">    password: <span class="number">123456</span></span><br><span class="line">    jedis:</span><br><span class="line">      pool:</span><br><span class="line">        # 连接池最大连接数，若为负数则表示没有任何限制</span><br><span class="line">        max-active: <span class="number">8</span></span><br><span class="line">        # 连接池最大阻塞等待时间，若为负数则表示没有任何限制</span><br><span class="line">        max-wait: -<span class="number">1</span></span><br><span class="line">        # 连接池中的最大空闲连接</span><br><span class="line">        max-idle: <span class="number">8</span></span><br></pre></td></tr></table></figure>



<h1 id="核心代码实现"><a href="#核心代码实现" class="headerlink" title="核心代码实现"></a>核心代码实现</h1><h2 id="库表创建"><a href="#库表创建" class="headerlink" title="库表创建"></a>库表创建</h2><p>建立 user 表（密码前先展示用 {noop} ）</p>
<h2 id="重写接口的方法"><a href="#重写接口的方法" class="headerlink" title="重写接口的方法"></a>重写接口的方法</h2><ol>
<li>实现 <strong>UserDetails</strong> 接口，重写里面的方法</li>
<li>重写 <strong>UserDetailsService</strong> 接口下的 <em>loadUserByUsername</em> 方法，因为这个方法默认是从内存中查的用户信息，我们需要改为去数据库查询</li>
</ol>
<details class="folding-tag" cyan><summary> 实现 UserDetails 接口 </summary>
              <div class='content'>
              <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.adalucky.modules.system.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.adalucky.modules.system.model.entity.SysUser;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.GrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ada</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> JDK17</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> LoginUser 将用户封装成 UserDetails 对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2022/4/22 21:30</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginUser</span> <span class="keyword">implements</span> <span class="title class_">UserDetails</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> SysUser sysUser;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> SysUser <span class="title function_">getSysUser</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sysUser;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSysUser</span><span class="params">(SysUser sysUser)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.sysUser = sysUser;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LoginUser</span><span class="params">(SysUser sysUser)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.sysUser = sysUser;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取权限</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回权限资源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; getAuthorities() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取密码</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回密码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPassword</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sysUser.getPassword();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取账号</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回登录账户</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUsername</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sysUser.getUserName();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断账户是否未过期</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 未过期返回 true,过期返回 false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonExpired</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 方法用于判断账户是否未锁定</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 未锁定返回 true 锁定返回 false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonLocked</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用于判断用户凭证是否没过期，即密码是否未过期</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 没过期返回 true 过期返回 false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isCredentialsNonExpired</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 方法用于判断用户是否可用</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 可用返回 true 不可用返回 false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEnabled</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
              </div>
            </details>


<details class="folding-tag" cyan><summary> 重写loadUserByUsername方法 </summary>
              <div class='content'>
              <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.adalucky.modules.system.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.adalucky.handler.BusinessException;</span><br><span class="line"><span class="keyword">import</span> com.adalucky.modules.system.mapper.SysUserMapper;</span><br><span class="line"><span class="keyword">import</span> com.adalucky.modules.system.model.entity.SysUser;</span><br><span class="line"><span class="keyword">import</span> com.adalucky.response.ResultCode;</span><br><span class="line"><span class="keyword">import</span> com.adalucky.utils.str.StringUtils;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UsernameNotFoundException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ada</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> JDK17</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 重新 loadUserByUsername 方法，实现去数据库查询</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2022/4/22 20:29</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDetailServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserDetailsService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    SysUserMapper mapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String userName)</span> <span class="keyword">throws</span> UsernameNotFoundException &#123;</span><br><span class="line">        <span class="comment">//查询用户信息 如果参数无效抛出自定义异常</span></span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEffective(userName)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(</span><br><span class="line">                    ResultCode.PARAM_IS_BLANK.getCode(),</span><br><span class="line">                    ResultCode.PARAM_IS_BLANK.getMessage()</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        LambdaQueryWrapper&lt;SysUser&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">        queryWrapper.eq(SysUser::getUserName, userName);</span><br><span class="line">        <span class="type">var</span> <span class="variable">user</span> <span class="operator">=</span> mapper.selectOne(queryWrapper);</span><br><span class="line">        <span class="comment">//TODO 查询用户权限</span></span><br><span class="line">        <span class="comment">//查询成功后 封装到 UserDetails 对象</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LoginUser</span>(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
              </div>
            </details>



<h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><ol>
<li>重写了上面的方法后我们可以启动一下进行测试，这个时候就需要输入我们数据的用户名和密码了</li>
<li>如果数据库直接是明文存储的话这里就会抛出 <code>There is no PasswordEncoder mapped for the id &quot;null&quot;</code></li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://automation-manage.oss-cn-shanghai.aliyuncs.com/blog/image-20220422221248112.png" alt="测试"></p>
<h3 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h3><p>Spring Security 的用户认证流程<br>1️⃣ 把前端传过来的用户名去数据查询对应的用户 <code>也就是调用我们重写的loadUserByUsername(String userName) 方法</code><br>2️⃣ 查询到以后通过 <code>return new LoginUser(user)</code> 封装用户信息到 <code>UserDetails</code><br>3️⃣ 会自动调用 <code>UserDetails</code> 的实现类，也就是我们这里的 <code>LoginUser</code> 的 getPassword() 获取用户的密码<br>4️⃣ 按照 默认或者我们指定的加密方式去和 getPassword() 获取用户的密码 比对<br>5️⃣ 比对通过登录成功，默认返回用户名或密码错误提示</p>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><div class="tabs" id="解决方案"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#解决方案-1">方案一</button></li><li class="tab"><button type="button" data-href="#解决方案-2">方案二</button></li><li class="tab"><button type="button" data-href="#解决方案-3">启动验证</button></li><li class="tab"><button type="button" data-href="#解决方案-4">t注册时密码加密</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="解决方案-1"><ol>
<li>告诉 Spring Security 我就是要用明文存，你就用明文比对就行了其它的安全不安全，泄露不泄露，与你不相干</li>
<li>这种方式比较粗暴，直接直接再数据库的密码前面加上 <strong>{noop}</strong> 例如 <strong>123456 –&gt; {noop}123456</strong></li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://automation-manage.oss-cn-shanghai.aliyuncs.com/blog/image-20220422225512161.png" alt="方案一"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div><div class="tab-item-content" id="解决方案-2"><details class="folding-tag" cyan open><summary> 简介 </summary>
              <div class='content'>
              <ol><li>实际项目中我们不会把密码明文存储在数据库中，采用密码加密存储方式，也就是在我们注册用户的时候把明文密码以 Spring Security 的加密方式进行加密，存储在数据库里面，验证的时候就把前端的明文再按照之前的加密方式加密一般和数据库返回的用户密码比较一次，一样的话密码就是正确的，校验通过</li><li>默认使用的PasswordEncoder要求数据库中的密码格式为：{id}password 。它会根据id去判断密码的加密方式。但是我们一般不会采用这种方式。所以就需要替换PasswordEncoder。（也就是要像上面写成 {noop}password ）</li><li>我们一般使用SpringSecurity为我们提供的BCryptPasswordEncoder。</li><li>我们只需要使用把BCryptPasswordEncoder对象注入Spring容器中，SpringSecurity就会使用该PasswordEncoder来进行密码校验。</li><li>我们可以定义一个SpringSecurity的配置类，SpringSecurity要求这个配置类要继承WebSecurityConfigurerAdapte</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.adalucky.auth;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ada</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> JDK17</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> Spring Security 配置类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2022/3/7 21:37</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//创建 CryptPasswordEncoder 注入到容器中，让 Spring Sercurity 默认以该方式进行加密</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
              </div>
            </details>

<details class="folding-tag" cyan><summary> 代码测试 </summary>
              <div class='content'>
              <ol><li><p>PasswordEncoder 加密<code>encode()</code>  </p></li><li><p>从下面图片可以看出来，同一个明文通过同一种方式最后加密的结果不一样，究其原因就是每次使用的 <code>盐值</code> 不一样</p></li><li><p>$2a$10$tSn8ALjHUOtWPUziO8xIM.Auer5&#x2F;yLLWsZspo3tsWI5OyBDea5mRS<br>1️⃣ <code>$2a$10$</code> + <code>22位盐值</code> + <code>加密后的密文</code><br>2️⃣ <code>$2a</code> 是 BCrypt 的版本<br>3️⃣ <code>$10</code> 是 10 次哈希</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.adalucky.auth;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WebSecurityConfigTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    PasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">passwordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">encode</span> <span class="operator">=</span> passwordEncoder.encode(<span class="string">&quot;123456&quot;</span>);</span><br><span class="line">        <span class="type">var</span> <span class="variable">encode1</span> <span class="operator">=</span> passwordEncoder.encode(<span class="string">&quot;123456&quot;</span>);</span><br><span class="line">        System.out.println(encode);</span><br><span class="line">        System.out.println(encode1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://automation-manage.oss-cn-shanghai.aliyuncs.com/blog/image-20220422235539413.png" alt="encode加密"></p></li><li><p>PasswordEncoder.matches(rawPassword,encodedPassword) 认证密码</p></li><li><p>密码认证结果返回布尔值</p></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.adalucky.auth;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WebSecurityConfigTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    PasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">passwordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(passwordEncoder.matches(<span class="string">&quot;123456&quot;</span>, <span class="string">&quot;$2a$10$tSn8ALjHUOtWPUziO8xIM.Auer5/yLLWsZspo3tsWI5OyBDea5mRS&quot;</span>));</span><br><span class="line">        System.out.println(passwordEncoder.matches(<span class="string">&quot;123654&quot;</span>, <span class="string">&quot;$2a$10$tSn8ALjHUOtWPUziO8xIM.Auer5/yLLWsZspo3tsWI5OyBDea5mRS&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://automation-manage.oss-cn-shanghai.aliyuncs.com/blog/image-20220423000827706.png" alt="matches 认证"></p>
              </div>
            </details><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div><div class="tab-item-content" id="解决方案-3"><ol>
<li>找一个刚才加密后密文替换数据库之前的 {noop}123456</li>
<li>重启项目用明文进行登录即可</li>
</ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div><div class="tab-item-content" id="解决方案-4"><p>其实很简单，就是在实体类的构造方法中对 密码进行一次加密即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">SysUser</span><span class="params">(UserDto userDto)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userId = userDto.userId();</span><br><span class="line">        <span class="built_in">this</span>.username = userDto.username();</span><br><span class="line">        <span class="built_in">this</span>.nikename = userDto.nikename();</span><br><span class="line">        <span class="built_in">this</span>.email = userDto.email();</span><br><span class="line">        <span class="built_in">this</span>.phone = userDto.phone();</span><br><span class="line">        <span class="built_in">this</span>.sex = userDto.sex();</span><br><span class="line">        <span class="built_in">this</span>.avatar = userDto.avatar();</span><br><span class="line">        <span class="built_in">this</span>.password = <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>().encode(userDto.password());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div></div>




<h2 id="登录接口实现"><a href="#登录接口实现" class="headerlink" title="登录接口实现"></a>登录接口实现</h2><p>注意：登录 登出的接口地址不要用默认的 <strong>&#x2F;login</strong> <strong>&#x2F;logout</strong> 会和 Spring Security 的重合防止出现一些意向不到的错误，可以命名为 <strong>&#x2F;user&#x2F;login</strong> 这种 </p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><ol>
<li>再理一下思路，上面我们的 登录认证流程详解图中: 前端请求登录 –&gt; 默认用 <code>AbstractAuthenticationProcessingFilter</code> 的实现类 <code>UsernamePasswordAuthenticationFilter</code>  会去封装前端的账户和密码 –&gt; 调用 <code>ProviderManager</code> 的 <code>authentication</code> 方法认证  –&gt; xxx… –&gt; 调用重写的 UserDetailsService 接口下的 loadUserByUsername 去数据库查询用户 —&gt; 封装到 UserDetails 的实现类 LoginUser –&gt; 返回给 <code>authentication</code></li>
<li>在接口中我们通过 AuthenticationManager 的 authenticate 方法来进行用户认证,所以需要在 SecurityConfig 中配置 <code>把AuthenticationManager注入容器</code>。</li>
<li>登录接口实现类注入 AuthenticationManager <code>调用 authenticate 方法进行认证</code></li>
<li>调用认证时需要传入 Authentication 对象，所以我们用 new UsernamePasswordAuthenticationToken() 把前端传过来的数据封装成 Authentication 对象，<strong>调用 authenticate 方法进行认证</strong> 时候就传这个对象 </li>
<li>认证返回的结果不是空的就表示有用户信息认证写进去了，这个写入 Redis 和返回 JWT 给前端即可即可</li>
<li>如果认证通过生成jwt写入Redis</li>
<li>那么我们只要重写实现类，在接口登录的时候调用即可</li>
<li>在登录接口需要放行，包括注册接口，主要涉及到一些不需要用户进行登录就能操作的接口 都需要进行放行</li>
<li>接下我们需要自定义登陆接口，然后让SpringSecurity对这个<code>接口放行</code>,让用户访问这个接口的时候不用登录也能访问。</li>
<li>认证成功的话要生成一个jwt，放入响应中返回。并且为了让用户下回请求时能通过jwt识别出具体的是哪个用户，我们需要把<code>用户信息存入redis</code>，可以把用户id作为key。</li>
</ol>
<h3 id="配置类-1"><a href="#配置类-1" class="headerlink" title="配置类"></a>配置类</h3><ol>
<li>重写这个认证方法 <strong>authenticationManagerBean()</strong> 注入到容器中</li>
<li>配置请求放行等操作</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.adalucky.auth;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.http.SessionCreationPolicy;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ada</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> JDK17</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> SpringBoot Security自动配置类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2022/3/7 21:37</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">/*@EnableWebSecurity</span></span><br><span class="line"><span class="comment">@EnableGlobalMethodSecurity(prePostEnabled = true)*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//创建 CryptPasswordEncoder 注入到容器中，让 Spring Sercurity 默认以该方式进行加密</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> AuthenticationManager <span class="title function_">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//重写这个认证方法，返回父类的认证方法，也就是逻辑还是原来的逻辑，目的是为了注入到 bean 后我们可以在登录的时候去调用这个对象的认证方法</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.authenticationManagerBean();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http</span><br><span class="line">                <span class="comment">//关闭csrf</span></span><br><span class="line">                .csrf().disable()</span><br><span class="line">                <span class="comment">//不通过Session获取SecurityContext</span></span><br><span class="line">                .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)</span><br><span class="line">                .and()</span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                <span class="comment">// 对于登录接口、注册接口 允许匿名访问</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/user/login&quot;</span>, <span class="string">&quot;/user/register&quot;</span>).anonymous()</span><br><span class="line">                <span class="comment">// 除上面外的所有请求全部需要鉴权认证</span></span><br><span class="line">                .anyRequest().authenticated();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><ol>
<li>登录接口实现：1️⃣ <strong>new UsernamePasswordAuthenticationToken()</strong> 封装前端的传参 2️⃣调用注入容器中的 <strong>authenticate</strong> 认证 3️⃣ 返回的结果不为空后写入 Redis 缓存和生成 JWT 返回给前端</li>
<li>@Autowired <code>分别注入 AuthenticationManager  RedisCache</code><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 登录</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> userDto 前端传入的账号和密码</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> 封装的统一返回</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> Result <span class="title function_">login</span><span class="params">(UserDto userDto)</span> &#123;</span><br><span class="line">       <span class="comment">//把前端传过来的用户名和密码封装成 authenticate 认证时候需要的 Authentication 对象</span></span><br><span class="line">       <span class="comment">//UsernamePasswordAuthenticationToken  继承了 AbstractAuthenticationToken  AbstractAuthenticationToken又实现了 Authentication</span></span><br><span class="line">       <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authenticationToken</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(userDto.username(), userDto.password());</span><br><span class="line">       <span class="comment">//调用 authenticate 方法认证就会去调用后面的 ProviderManager 后面会走到我们自己重写的 loadUserByUsername 方法去数据库查询用户信息进行认证</span></span><br><span class="line">       <span class="comment">//loadUserByUsername方法 里面会把用户信息封装到 我们自己重写的 UserDetails 的实现类 LoginUser</span></span><br><span class="line">       <span class="comment">//authenticate 认证方法的返回对象就会包含这个 LoginUser 的信息</span></span><br><span class="line">       <span class="type">var</span> <span class="variable">authenticate</span> <span class="operator">=</span> authenticationManager.authenticate(authenticationToken);</span><br><span class="line">       <span class="keyword">if</span> (Objects.isNull(authenticate)) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;认证失败,用户名或密码错误&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="type">var</span> <span class="variable">user</span> <span class="operator">=</span> (LoginUser) authenticate.getPrincipal();</span><br><span class="line">       <span class="type">var</span> <span class="variable">userId</span> <span class="operator">=</span> user.getSysUser().getUserId().toString();</span><br><span class="line">       redisCache.setCacheObject(<span class="string">&quot;login&quot;</span> + userId, user);</span><br><span class="line">       <span class="keyword">return</span> Result.ok().message(<span class="string">&quot;登录成功&quot;</span>).data(<span class="string">&quot;token&quot;</span>, JwtUtil.createJWT(userId));</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://automation-manage.oss-cn-shanghai.aliyuncs.com/blog/image-20220423152850585.png" alt="DEBUG 分析"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://automation-manage.oss-cn-shanghai.aliyuncs.com/blog/image-20220423161233725.png" alt="Redis 写入情况"></p>
<h1 id="JWT认证过滤器"><a href="#JWT认证过滤器" class="headerlink" title="JWT认证过滤器"></a>JWT认证过滤器</h1><ol>
<li>上面的我们已经生成了JWT返回给前端了，那么前端请求未放行的接口我们就要去解析 token 1️⃣ 是否是正确有效的 2️⃣ 请求的用户是谁 3️⃣ 根据解析的用户 id 去 Redis中查询用户的信息存入 SecurityContextHolder</li>
<li>为什么叫 JWT 认证过滤器呢，因为 Spring Security 框架有自带的过滤器链，然后我们在某个过滤器前面或者后面加入一个自己的过滤器，组成一个新的过滤器链</li>
</ol>
<h2 id="创建认证过滤器"><a href="#创建认证过滤器" class="headerlink" title="创建认证过滤器"></a>创建认证过滤器</h2><ol>
<li>这个过滤器的作用是为了拦截请求 校验用户的身份 1️⃣ 如果 token 为空的话就放行，因为可能是登录接口，或者注册接口，这里放行了后面拦截器中发现不是 登录或者注册接口又没有用户信息传过来就认证失败 403 2️⃣ 如果 token 解析失败证明就是非法的请求，抛出异常用户未登录 3️⃣ 解析成功了的话就去根据用户 ID 在 Redis 中取数据</li>
<li>注意事项：1️⃣ 登录成功那个接口写入的 key 和这里取时候的 key 要一致 2️⃣ 登录成功写入的数据类型和这里取时候接收的数据类型要兼容最好一致</li>
<li>过滤器尽量<code>不要用 implements Filter</code> 实现,因为这种方式可能在不同得 Severlet 版本中，一个请求过来过滤器会被调用多次，用 <code>extends OncePerRequestFilter</code></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.adalucky.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.adalucky.modules.system.model.entity.SysUser;</span><br><span class="line"><span class="keyword">import</span> com.adalucky.utils.redis.RedisCache;</span><br><span class="line"><span class="keyword">import</span> com.adalucky.utils.str.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.filter.OncePerRequestFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.adalucky.utils.jwt.JwtUtil.parseJWT;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ada</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> JDK17</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 自定义的 Jwt 认证过滤器，插入到 Spring Security 的过滤器链</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2022/4/23 20:34</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span>    <span class="comment">//一般的过滤器可能会去 implements Filter 实现,但是这种方式可能在不同得 Severlet 版本中，一个请求过来过滤器会被调用多次</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtAuthenticationTokenFilter</span> <span class="keyword">extends</span> <span class="title class_">OncePerRequestFilter</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RedisCache redisCache;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="comment">//    获取 token,前端 Header 头必须要有这个 token 这个参数</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEffective(token)) &#123;</span><br><span class="line">            <span class="comment">//如果 token 为空就放行不去做 解析/读Redis/ 写入SecurityContextHolder，这里的放行只是当前拦截器放行，后面的拦截器还是会去走对应的逻辑</span></span><br><span class="line">            filterChain.doFilter(request, response);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//    解析 token</span></span><br><span class="line">        String userid;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            userid = parseJWT(token).getSubject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;token非法&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//    Redis 取数据</span></span><br><span class="line">        <span class="type">SysUser</span> <span class="variable">user</span> <span class="operator">=</span> redisCache.getCacheObject(<span class="string">&quot;login&quot;</span> + userid);</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(user)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;用户未登录&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//存入SecurityContextHolder</span></span><br><span class="line">        <span class="comment">//TODO 获取权限信息封装到Authentication，第三个参数就是权限</span></span><br><span class="line">        <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authenticationToken</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(user, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        SecurityContextHolder.getContext().setAuthentication(authenticationToken);</span><br><span class="line">        <span class="comment">//放行到下一个过滤器</span></span><br><span class="line">        filterChain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="添加JWT-认证过滤器"><a href="#添加JWT-认证过滤器" class="headerlink" title="添加JWT 认证过滤器"></a>添加JWT 认证过滤器</h2><ol>
<li>将我们写的过滤器添加到 Spring Security 的过滤器链里面</li>
<li>添加的位置根据具体的业务逻辑而定，我们这里就需要在最前面添加，<strong>UsernamePasswordAuthenticationFilter</strong> 之前</li>
<li>在 <strong>WebSecurityConfig</strong> 这个配置类中<code>.addFilterBefore(jwtAuthenticationTokenFilter, UsernamePasswordAuthenticationFilter.class);</code><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http</span><br><span class="line">                <span class="comment">//关闭csrf</span></span><br><span class="line">                .csrf().disable()</span><br><span class="line">                <span class="comment">//不通过Session获取SecurityContext</span></span><br><span class="line">                .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)</span><br><span class="line">                .and()</span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                <span class="comment">// 对于登录接口、注册接口 允许匿名访问</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/user/login&quot;</span>, <span class="string">&quot;/user/register&quot;</span>).anonymous()</span><br><span class="line">                <span class="comment">// 除上面外的所有请求全部需要鉴权认证</span></span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                <span class="comment">// 在UsernamePasswordAuthenticationFilter 过滤器前添加我们的自己写的 JWT 认证过滤器</span></span><br><span class="line">                .addFilterBefore(jwtAuthenticationTokenFilter, UsernamePasswordAuthenticationFilter.class);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><ol>
<li>到这里为止我们的期望是当前端传过token 有效后我们去解析 userId，然后去 Redis 中获取用户的信息，并把查询存到SecurityContextHolder 中</li>
<li>写入 SecurityContextHolder 的时候需要用 new UsernamePasswordAuthenticationToken 构造对应的对象 authentication 对象</li>
<li>这个 new 构造函数用两个参数和三个参数的，两个参数是用来构造账号+密码用于认证的，我们用的三个参数的</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://automation-manage.oss-cn-shanghai.aliyuncs.com/blog/image-20220423231016910.png" alt="写入到SecurityContextHolder"></p>
<h1 id="登出操作"><a href="#登出操作" class="headerlink" title="登出操作"></a>登出操作</h1><ol>
<li>注意接口命名之前也提过了不要和自带的重名了</li>
<li>这一步当我们登出的时候需要做的事情: 删 Redis 里面的用户信息</li>
<li>注意： 1️⃣ 调用这个接口不需要传参，只需要前端传 Token 2️⃣ 前端调用这个接口时候最先会走我们的 JWT 认证过滤器，这个时候认证通过会把我们的用户信息存在 SecurityContextHolder 没认证通过的话接口根本访问不到这里直接就会抛出 403 或者其它异常 3️⃣ 删除 Redis 缓存的时候也就是从 SecurityContextHolder 获取到用户 ID 然后拼接以后删除<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 登出</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> 封装的 Result</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> Result <span class="title function_">logout</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="comment">//退出登录的接口不需要传参，因为会携带 token(没带的话过滤器会拦截) SecurityContextHolder 中获取到 authentication 里面有用户信息（来源就是 JWT 认证过滤器存进去的）</span></span><br><span class="line">       <span class="type">var</span> <span class="variable">authentication</span> <span class="operator">=</span> SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line">       <span class="type">var</span> <span class="variable">user</span> <span class="operator">=</span> (SysUser) authentication.getPrincipal();</span><br><span class="line">       <span class="comment">//删除 Redis 中的缓存</span></span><br><span class="line">       redisCache.deleteObject(<span class="string">&quot;login&quot;</span> + user.getUserId());</span><br><span class="line">       <span class="keyword">return</span> Result.ok().message(<span class="string">&quot;退出登录成功&quot;</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://automation-manage.oss-cn-shanghai.aliyuncs.com/blog/image-20220424204016280.png" alt="DEBUG 说明"></li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://automation-manage.oss-cn-shanghai.aliyuncs.com/blog/image-20220424204918891.png" alt="缓存删除成功"></p>
<h1 id="配置项简介"><a href="#配置项简介" class="headerlink" title="配置项简介"></a>配置项简介</h1><ol>
<li>我们之前重写了 SecurityConfig 配置类，这里做一个配置项，configure 的一些粗浅简介</li>
<li>重写这个不需要注入到 Bean 中，我估摸这这个配置类重写以后 Security 就会调用我们自己的配置类算是一种多态吧</li>
<li>上层调用会传入一个 HttpSecurity 对象，那么我们就可以对用对用的方法进行设置了，具体还有那些配置需要用的时候再 Baidu 一下</li>
<li>下列示例中的没一行表示一个配置项的结束 返回的还是一个 HttpSecurity 所以还是可以继续调用设置</li>
<li>and() 方法可以理解为一组设置结束，返回的还是一个 HttpSecurity 对象，可以继续设置 这是我们常见的链式编程</li>
<li>设置 <code>.antMatchers(&quot;/user/login&quot;, &quot;/user/register&quot;).anonymous()</code> <strong>对于登录接口、注册接口 允许匿名访问</strong> 注意<code>不带 token 才能正常访问</code>，<code>带了反而会抛异常</code> ，这就匿名访问</li>
<li><code>.antMatchers(&quot;/user/login&quot;, &quot;/user/register&quot;).permitAll()</code> 下面这种 <strong>permitAll()</strong> 带不带 token 都可以访问</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">       http</span><br><span class="line">               <span class="comment">//关闭csrf</span></span><br><span class="line">               .csrf().disable()</span><br><span class="line">               <span class="comment">//不通过Session获取SecurityContext</span></span><br><span class="line">               .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)</span><br><span class="line">               .and()</span><br><span class="line">               .authorizeRequests()</span><br><span class="line">               <span class="comment">//对于登录接口、注册接口 允许匿名访问</span></span><br><span class="line">               .antMatchers(<span class="string">&quot;/user/login&quot;</span>, <span class="string">&quot;/user/register&quot;</span>).anonymous()</span><br><span class="line">               <span class="comment">//其它的请求，任意用户认证通过后都可访问</span></span><br><span class="line">               .anyRequest().authenticated()</span><br><span class="line">               .and()</span><br><span class="line">               <span class="comment">//在UsernamePasswordAuthenticationFilter 过滤器前添加我们的自己写的 JWT 认证过滤器</span></span><br><span class="line">               .addFilterBefore(jwtAuthenticationTokenFilter, UsernamePasswordAuthenticationFilter.class);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h1 id="权限"><a href="#权限" class="headerlink" title="权限"></a>权限</h1><h2 id="权限系统的作用"><a href="#权限系统的作用" class="headerlink" title="权限系统的作用"></a>权限系统的作用</h2><ol>
<li>例如一个学校图书馆的管理系统，如果是普通学生登录就能看到借书还书相关的功能，不可能让他看到并且去使用添加书籍信息，删除书籍信息等功能。但是如果是一个图书馆管理员的账号登录了，应该就能看到并使用添加书籍信息，删除书籍信息等功能。</li>
<li>总结起来就是<strong>不同的用户可以使用不同的功能</strong>。这就是权限系统要去实现的效果。</li>
<li>我们<code>不能只依赖前端去判断用户的权限来选择显示哪些菜单哪些按钮</code>。因为如果只是这样，如果有人知道了对应功能的接口地址就可以不通过前端，直接去发送请求来实现相关功能操作。</li>
<li>所以我们还需要在后台进行用户权限的判断，判断当前用户是否有相应的权限，必须具有所需权限才能进行相应的操作。</li>
</ol>
<h2 id="授权基本流程"><a href="#授权基本流程" class="headerlink" title="授权基本流程"></a>授权基本流程</h2><ol>
<li>在SpringSecurity中，会使用默认的FilterSecurityInterceptor来进行权限校验。在FilterSecurityInterceptor中会从SecurityContextHolder获取其中的Authentication，然后获取其中的权限信息，然后确认当前用户是否拥有访问当前资源所需的权限，如果有权限的话 FilterSecurityInterceptor 才会放行</li>
<li>所以我们项目在登录的时候需要把用户的权限信息也存入 Authentication 对象，最后写入到 Redis 中。</li>
<li>其它接口进行请求时经过 JWT 认证锅炉器，去 Redis 取用户信息和和拥有的资源权限 并写入到 SecurityContextHolder</li>
</ol>
<h2 id="授权实现"><a href="#授权实现" class="headerlink" title="授权实现"></a>授权实现</h2><ol>
<li>这里记录一下授权的实现，采用自顶向下编写代码</li>
<li>这里先采用写死权限的方式快速体验下，后面用权限模型优化代码</li>
</ol>
<h3 id="接口限制访问权限"><a href="#接口限制访问权限" class="headerlink" title="接口限制访问权限"></a>接口限制访问权限</h3><ol>
<li>就是对我们的 API 接口做权限校验，当你需要有某个权限的时候我才让你访问我的接口，没有这个权限的话，不好意思，你谁啊，403 拜拜</li>
<li>这里所谓的权限我们就是采用一个字符串来标识，当你有这个标识的时候那我就给你放行，让你请求我的接口</li>
<li>一般实现的方式有两种：1️⃣ 基于配置的方案（这种一般是针对静态资源，也就是 springboot 项目下的静态资源）2️⃣ 基于注解的方案（现在前后端分离的项目都是用这种）</li>
<li>具体实现：1️⃣ 在 Spring Security 的配置类上添加一个注解 <code>@EnableGlobalMethodSecurity(prePostEnabled = true)</code> 开启对应的功能   2️⃣ 在接口上添加注解<code>@PreAuthorize(&quot;hasAuthority(&#39;你的权限关键字&#39;)&quot;)</code> Spring Security 在运行的时候会去读取这个注解里面的参数当做一个表达式，读取到了 <strong>hasAuthority()</strong> 后就会去调用这个方法，然后传入你自己的权限关键字去 SecurityContextHolder 的权限里面比对有没有一模一样的关键字，最后返回一个布尔值确定你是否能访问这个接口<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Spring Security 配置类中开启注解</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity(prePostEnabled = true)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//接口上添加权限访问控制注解，写入表达式和关键字（这个关键字只要是一个字符串都行 ）</span></span><br><span class="line"><span class="meta">@PreAuthorize(&quot;hasAuthority(&#x27;system:user:list&#x27;)&quot;)</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://automation-manage.oss-cn-shanghai.aliyuncs.com/blog/image-20220424230730279.png" alt="接口限制访问权限"></p>
<h3 id="封装权限信息"><a href="#封装权限信息" class="headerlink" title="封装权限信息"></a>封装权限信息</h3><ol>
<li>思路：在登录的时候我们就需要去数据库查询出来一些封装给用户对象，然后写入 Redis，（这里先写死，不去数据查询）</li>
<li>注意事项：我们是用一个集合来接受，最好是用一个不能重复的集合，并且在数据查询的时候也需要去重双重保障吧（后面查数据库权限的时候会再记录）</li>
<li>涉及变动：之前我的代码往 Redis 中存的都是 SysUser 的对象，现在加了一个 权限对象 <code>Set&lt;String&gt; permissions</code> 所以存的时候只能把拥有这两个对象的 <code>LoginUser</code> 存进去了， <code>SysUser</code> 和 <code>Set&lt;String&gt; permissions</code> 都是这个对象的属性<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.adalucky.modules.system.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.adalucky.handler.BusinessException;</span><br><span class="line"><span class="keyword">import</span> com.adalucky.modules.system.mapper.SysUserMapper;</span><br><span class="line"><span class="keyword">import</span> com.adalucky.modules.system.model.entity.SysUser;</span><br><span class="line"><span class="keyword">import</span> com.adalucky.response.ResultCode;</span><br><span class="line"><span class="keyword">import</span> com.adalucky.utils.str.StringUtils;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UsernameNotFoundException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ada</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> JDK17</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 重新 loadUserByUsername 方法，实现去数据库查询</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2022/4/22 20:29</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDetailServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserDetailsService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    SysUserMapper mapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException &#123;</span><br><span class="line">        <span class="comment">//查询用户信息 如果参数无效抛出自定义异常</span></span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEffective(username)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(</span><br><span class="line">                    ResultCode.PARAM_IS_BLANK.getCode(),</span><br><span class="line">                    ResultCode.PARAM_IS_BLANK.getMessage()</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//限制数据库只能有一条，因为手机号唯一，如果不止一条 getOne 就会抛异常，catch 捕获了就抛出自定义异常</span></span><br><span class="line">        LambdaQueryWrapper&lt;SysUser&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">        queryWrapper.eq(SysUser::getUsername, username);</span><br><span class="line">        SysUser user;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            user = mapper.selectOne(queryWrapper);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(</span><br><span class="line">                    ResultCode.USER_REPEAT.getCode(),</span><br><span class="line">                    ResultCode.USER_REPEAT.getMessage()</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//查询数据不为空后 构造到 LoginUser 中(也就是封装到 UserDetails 的对象)</span></span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(user)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(</span><br><span class="line">                    ResultCode.PARAM_IS_BLANK.getCode(),</span><br><span class="line">                    ResultCode.PARAM_IS_BLANK.getMessage()</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//List&lt;String&gt; menu = new ArrayList&lt;&gt;(Arrays.asList(&quot;system:user:list&quot;));</span></span><br><span class="line">        Set&lt;String&gt; permissions = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;String&gt;(Arrays.asList(<span class="string">&quot;system:user:list&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LoginUser</span>(user, permissions);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 登录</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> userDto 前端传入的账号和密码</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 封装的统一返回</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">login</span><span class="params">(UserDto userDto)</span> &#123;</span><br><span class="line">    <span class="comment">//把前端传过来的用户名和密码封装成 authenticate 认证时候需要的 Authentication 对象</span></span><br><span class="line">    <span class="comment">//UsernamePasswordAuthenticationToken  继承了 AbstractAuthenticationToken  AbstractAuthenticationToken又实现了 Authentication</span></span><br><span class="line">    <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authenticationToken</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(userDto.username(), userDto.password());</span><br><span class="line">    <span class="comment">//调用 authenticate 方法认证就会去调用后面的 ProviderManager 后面会走到我们自己重写的 loadUserByUsername 方法去数据库查询用户信息进行认证</span></span><br><span class="line">    <span class="comment">//loadUserByUsername方法 里面会把用户信息封装到 我们自己重写的 UserDetails 的实现类 LoginUser</span></span><br><span class="line">    <span class="comment">//authenticate 认证方法的返回对象就会包含这个 LoginUser 的信息</span></span><br><span class="line">    <span class="type">var</span> <span class="variable">authenticate</span> <span class="operator">=</span> authenticationManager.authenticate(authenticationToken);</span><br><span class="line">    <span class="keyword">if</span> (Objects.isNull(authenticate)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;认证失败,用户名或密码错误&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">var</span> <span class="variable">loginUser</span> <span class="operator">=</span> (LoginUser) authenticate.getPrincipal();</span><br><span class="line">    <span class="type">var</span> <span class="variable">user</span> <span class="operator">=</span> loginUser.getSysUser();</span><br><span class="line">    <span class="type">var</span> <span class="variable">userId</span> <span class="operator">=</span> user.getUserId().toString();</span><br><span class="line">    <span class="comment">//写入 loginUser 时， permissions 必须要有对应的 get set 方法</span></span><br><span class="line">    redisCache.setCacheObject(<span class="string">&quot;login&quot;</span> + userId, loginUser);</span><br><span class="line">    <span class="keyword">return</span> Result.ok().message(<span class="string">&quot;登录成功&quot;</span>).data(<span class="string">&quot;token&quot;</span>, JwtUtil.createJWT(userId));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.adalucky.modules.system.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.adalucky.modules.system.model.entity.SysUser;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.annotation.JSONField;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.GrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.authority.SimpleGrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ada</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> JDK17</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> LoginUser 将用户封装成 UserDetails 对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2022/4/22 21:30</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginUser</span> <span class="keyword">implements</span> <span class="title class_">UserDetails</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> SysUser sysUser;</span><br><span class="line">    <span class="comment">//存储权限集合</span></span><br><span class="line">    <span class="keyword">private</span> Set&lt;String&gt; permissions;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> SysUser <span class="title function_">getSysUser</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sysUser;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSysUser</span><span class="params">(SysUser sysUser)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.sysUser = sysUser;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Set&lt;String&gt; <span class="title function_">getPermissions</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> permissions;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPermissions</span><span class="params">(Set&lt;String&gt; permissions)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.permissions = permissions;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAuthorities</span><span class="params">(Set&lt;SimpleGrantedAuthority&gt; authorities)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.authorities = authorities;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LoginUser</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构造 UserDetails</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user        SysUser 对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> permissions 用户的权限资源集合</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LoginUser</span><span class="params">(SysUser user, Set&lt;String&gt; permissions)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.sysUser = user;</span><br><span class="line">        <span class="built_in">this</span>.permissions = permissions;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// fastjson 的注解，不进行序列化，因为这个是 Security 提供的序列化会报错 我们存在 Redis 中 存Set&lt;String&gt; permissions 对象</span></span><br><span class="line">    <span class="meta">@JSONField(serialize = false)</span></span><br><span class="line">    <span class="keyword">private</span> Set&lt;SimpleGrantedAuthority&gt; authorities;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取权限</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回权限资源集合 (将 permissions 集合中的 String 标识存入后返回，只有第一次为空的时候才会写，不为空直接返回权限集合)</span></span><br><span class="line"><span class="comment">     * 如果修改了用户权限需要删除 Redis 重新登录一次或者重写写一次权限不然这里权限不为空就获取不到最新的权限了</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; getAuthorities() &#123;</span><br><span class="line">        <span class="comment">//这里优化一些代码加个 if 判断，当权限为空的时候先去把权限写入到 Set&lt;SimpleGrantedAuthority&gt; authorities 中，如果不为空直接返回这个权限，不然每次认证权限的时候调用一次 getAuthorities() 方法都会重复写同样的东西</span></span><br><span class="line">        <span class="keyword">if</span> (authorities != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> authorities;</span><br><span class="line">        &#125;</span><br><span class="line">       <span class="comment">/*</span></span><br><span class="line"><span class="comment">        Set&lt;GrantedAuthority&gt;  authorities = new HashSet&lt;&gt;();</span></span><br><span class="line"><span class="comment">        permissions.forEach(permission-&gt;authorities.add(new SimpleGrantedAuthority(permission)));</span></span><br><span class="line"><span class="comment">        return authorities;</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="comment">//函数式编程: 先把 permissions 转换成一个流，然后里面的值到一个 map 里，里面的每一个对象调用一次 SimpleGrantedAuthority 的构造方法，最后再调用 collect() 方法收集成一个 Set 集合</span></span><br><span class="line">        <span class="comment">//把permissions中String类型的权限信息封装成SimpleGrantedAuthority对象</span></span><br><span class="line">        authorities = permissions.stream().map(SimpleGrantedAuthority::<span class="keyword">new</span>).collect(Collectors.toSet());</span><br><span class="line">        <span class="keyword">return</span> authorities;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取密码</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回密码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPassword</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sysUser.getPassword();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取账号</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回登录账户</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUsername</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sysUser.getUsername();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断账户是否未过期</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 未过期返回 true,过期返回 false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonExpired</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 方法用于判断账户是否未锁定</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 未锁定返回 true 锁定返回 false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonLocked</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用于判断用户凭证是否没过期，即密码是否未过期</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 没过期返回 true 过期返回 false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isCredentialsNonExpired</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 方法用于判断用户是否可用</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 可用返回 true 不可用返回 false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEnabled</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="RBAC权限模型"><a href="#RBAC权限模型" class="headerlink" title="RBAC权限模型"></a>RBAC权限模型</h1><h2 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h2><p>RBAC权限模型（Role-Based Access Control）即：基于角色的权限控制。这是目前最常被开发者使用也是相对易用、通用权限模型。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://automation-manage.oss-cn-shanghai.aliyuncs.com/blog/image-20220426164615643.png" alt="RBAC 权限模型"></p>
<h2 id="建表"><a href="#建表" class="headerlink" title="建表"></a>建表</h2><p>按照简介所示图，一个我们需要 5 张表进行组成一个基本的 RBAC 的模型</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">-- 创建用户表</span><br><span class="line">DROP TABLE IF EXISTS `sys_user`;</span><br><span class="line">CREATE TABLE `sys_user`</span><br><span class="line">(</span><br><span class="line">    `user_id`     int                                                    NOT NULL AUTO_INCREMENT COMMENT &#x27;用户ID&#x27;,</span><br><span class="line">    `dept_id`     int                                                         DEFAULT NULL COMMENT &#x27;部门ID&#x27;,</span><br><span class="line">    `username`    varchar(11) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL COMMENT &#x27;登录账号&#x27;,</span><br><span class="line">    `nikename`    varchar(10) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL COMMENT &#x27;用户昵称&#x27;,</span><br><span class="line">    `type`        varchar(2) CHARACTER SET utf8 COLLATE utf8_general_ci       DEFAULT &#x27;00&#x27; COMMENT &#x27;用户类型（00系统用户）&#x27;,</span><br><span class="line">    `email`       varchar(50)                                                 DEFAULT &#x27;&#x27; COMMENT &#x27;用户邮箱&#x27;,</span><br><span class="line">    `phone`       varchar(20) CHARACTER SET utf8 COLLATE utf8_general_ci      DEFAULT &#x27;&#x27; COMMENT &#x27;手机号码&#x27;,</span><br><span class="line">    `sex`         int                                                         DEFAULT &#x27;2&#x27; COMMENT &#x27;用户性别（0女 1男 2保密）&#x27;,</span><br><span class="line">    `avatar`      varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci     DEFAULT &#x27;https://www.adalucky.com/medias/16229390604952.png&#x27; COMMENT &#x27;头像路径&#x27;,</span><br><span class="line">    `password`    varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci     DEFAULT &#x27;&#x27; COMMENT &#x27;密码&#x27;,</span><br><span class="line">    `status`      int                                                         DEFAULT &#x27;0&#x27; COMMENT &#x27;帐号状态（0 启用  1 禁用）&#x27;,</span><br><span class="line">    `deleted`     int                                                         DEFAULT &#x27;0&#x27; COMMENT &#x27;删除标志（0代表未删除 1代表已删除）&#x27;,</span><br><span class="line">    `project_id`  int                                                         DEFAULT NULL COMMENT &#x27;默认项目ID&#x27;,</span><br><span class="line">    `login_ip`    varchar(50)                                                 DEFAULT &#x27;&#x27; COMMENT &#x27;最后登陆IP&#x27;,</span><br><span class="line">    `login_date`  datetime                                                    DEFAULT NULL COMMENT &#x27;最后登陆时间&#x27;,</span><br><span class="line">    `create_by`   varchar(30) CHARACTER SET utf8 COLLATE utf8_general_ci      DEFAULT NULL COMMENT &#x27;创建者&#x27;,</span><br><span class="line">    `create_time` timestamp                                              NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;创建时间&#x27;,</span><br><span class="line">    `update_by`   varchar(30) CHARACTER SET utf8 COLLATE utf8_general_ci      DEFAULT NULL COMMENT &#x27;更新者&#x27;,</span><br><span class="line">    `update_time` timestamp                                              NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT &#x27;更新时间&#x27;,</span><br><span class="line">    `version`     int                                                         DEFAULT &#x27;1&#x27; COMMENT &#x27;Mybatis-Plus 乐观锁标记&#x27;,</span><br><span class="line">    `remark`      varchar(500)                                                DEFAULT &#x27;&#x27; COMMENT &#x27;备注&#x27;,</span><br><span class="line">    PRIMARY KEY (`user_id`)</span><br><span class="line">) ENGINE = InnoDB</span><br><span class="line">  DEFAULT CHARSET = utf8mb4 COMMENT =&#x27;用户信息表&#x27;;</span><br><span class="line"></span><br><span class="line">-- 创建权限表</span><br><span class="line">DROP TABLE IF EXISTS `sys_menu`;</span><br><span class="line">CREATE TABLE `sys_menu`</span><br><span class="line">(</span><br><span class="line">    `id`          bigint(20)  NOT NULL AUTO_INCREMENT,</span><br><span class="line">    `menu_name`   varchar(64) NOT NULL DEFAULT &#x27;NULL&#x27; COMMENT &#x27;菜单名&#x27;,</span><br><span class="line">    `path`        varchar(200)         DEFAULT NULL COMMENT &#x27;路由地址&#x27;,</span><br><span class="line">    `component`   varchar(255)         DEFAULT NULL COMMENT &#x27;组件路径&#x27;,</span><br><span class="line">    `visible`     char(1)              DEFAULT &#x27;0&#x27; COMMENT &#x27;菜单状态（0显示 1隐藏）&#x27;,</span><br><span class="line">    `status`      char(1)              DEFAULT &#x27;0&#x27; COMMENT &#x27;菜单状态（0正常 1停用）&#x27;,</span><br><span class="line">    `perms`       varchar(100)         DEFAULT NULL COMMENT &#x27;权限标识&#x27;,</span><br><span class="line">    `icon`        varchar(100)         DEFAULT &#x27;#&#x27; COMMENT &#x27;菜单图标&#x27;,</span><br><span class="line">    `create_by`   bigint(20)           DEFAULT NULL,</span><br><span class="line">    `create_time` datetime             DEFAULT NULL,</span><br><span class="line">    `update_by`   bigint(20)           DEFAULT NULL,</span><br><span class="line">    `update_time` datetime             DEFAULT NULL,</span><br><span class="line">    `deleted`     int(11)              DEFAULT &#x27;0&#x27; COMMENT &#x27;删除标志（0代表未删除 1代表已删除）&#x27;,</span><br><span class="line">    `remark`      varchar(500)         DEFAULT NULL COMMENT &#x27;备注&#x27;,</span><br><span class="line">    PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE = InnoDB</span><br><span class="line">  AUTO_INCREMENT = 2</span><br><span class="line">  DEFAULT CHARSET = utf8mb4 COMMENT =&#x27;菜单表&#x27;;</span><br><span class="line"></span><br><span class="line">-- 创建角色表</span><br><span class="line">DROP TABLE IF EXISTS `sys_role`;</span><br><span class="line"></span><br><span class="line">CREATE TABLE `sys_role`</span><br><span class="line">(</span><br><span class="line">    `id`          bigint(20) NOT NULL AUTO_INCREMENT,</span><br><span class="line">    `name`        varchar(128) DEFAULT NULL,</span><br><span class="line">    `role_key`    varchar(100) DEFAULT NULL COMMENT &#x27;角色权限字符串&#x27;,</span><br><span class="line">    `status`      char(1)      DEFAULT &#x27;0&#x27; COMMENT &#x27;角色状态（0正常 1停用）&#x27;,</span><br><span class="line">    `del_flag`    int(1)       DEFAULT &#x27;0&#x27; COMMENT &#x27;del_flag&#x27;,</span><br><span class="line">    `create_by`   bigint(200)  DEFAULT NULL,</span><br><span class="line">    `create_time` datetime     DEFAULT NULL,</span><br><span class="line">    `update_by`   bigint(200)  DEFAULT NULL,</span><br><span class="line">    `update_time` datetime     DEFAULT NULL,</span><br><span class="line">    `remark`      varchar(500) DEFAULT NULL COMMENT &#x27;备注&#x27;,</span><br><span class="line">    PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE = InnoDB</span><br><span class="line">  AUTO_INCREMENT = 3</span><br><span class="line">  DEFAULT CHARSET = utf8mb4 COMMENT =&#x27;角色表&#x27;;</span><br><span class="line"></span><br><span class="line">-- 创建角色权限中间表</span><br><span class="line"></span><br><span class="line">DROP TABLE IF EXISTS `sys_role_menu`;</span><br><span class="line"></span><br><span class="line">CREATE TABLE `sys_role_menu`</span><br><span class="line">(</span><br><span class="line">    `role_id` bigint(200) NOT NULL AUTO_INCREMENT COMMENT &#x27;角色ID&#x27;,</span><br><span class="line">    `menu_id` bigint(200) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;菜单id&#x27;,</span><br><span class="line">    PRIMARY KEY (`role_id`, `menu_id`)</span><br><span class="line">) ENGINE = InnoDB</span><br><span class="line">  AUTO_INCREMENT = 2</span><br><span class="line">  DEFAULT CHARSET = utf8mb4 COMMENT =&#x27;角色权限中间表&#x27;;</span><br><span class="line"></span><br><span class="line">-- 创建用户角色中间表</span><br><span class="line">DROP TABLE IF EXISTS `sys_user_role`;</span><br><span class="line"></span><br><span class="line">CREATE TABLE `sys_user_role`</span><br><span class="line">(</span><br><span class="line">    `user_id` bigint(200) NOT NULL AUTO_INCREMENT COMMENT &#x27;用户id&#x27;,</span><br><span class="line">    `role_id` bigint(200) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;角色id&#x27;,</span><br><span class="line">    PRIMARY KEY (`user_id`, `role_id`)</span><br><span class="line">) ENGINE = InnoDB</span><br><span class="line">  DEFAULT CHARSET = utf8mb4 COMMENT =&#x27;用户角色中间表&#x27;;</span><br></pre></td></tr></table></figure>



<h2 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a>实现</h2><ol>
<li>实现思路：新建一个 sys_menu 的实体类、Mapper 接口、xml</li>
<li>编写查询用户权限的 SQL 放在 xml 中，Mapper 中声明对应的方法</li>
<li>Mapper 传入的参数类型需要和 实体类中的 userId 兼容</li>
<li>生成 xml 文件和自定义 SQL 可在类上合方法上进行提示填充（MybatisX 插件）</li>
<li>最后把我们写死的权限换成查询的（Mapper 的 bean 要注入）<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Set&lt;String&gt; permissions = new HashSet&lt;String&gt;(Arrays.asList(&quot;system:user:list&quot;));</span></span><br><span class="line"><span class="type">var</span> <span class="variable">permissions</span> <span class="operator">=</span> sysMenuMapper.selectPermsByUserId(user.getUserId());</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LoginUser</span>(user, permissions);</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.adalucky.modules.system.model.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.FieldFill;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.IdType;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.TableField;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.TableId;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.TableName;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModel;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModelProperty;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ada</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> JDK17</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 菜单表 实体类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2022-04-26 00:06:11</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@TableName(&quot;sys_menu&quot;)</span></span><br><span class="line"><span class="meta">@ApiModel(value = &quot;SysMenu对象&quot;, description = &quot;菜单表&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SysMenu</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableId(value = &quot;id&quot;, type = IdType.AUTO)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;菜单名&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String menuName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;路由地址&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String path;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;组件路径&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String component;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;菜单状态（0显示 1隐藏）&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String visible;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;菜单状态（0正常 1停用）&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String status;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;权限标识&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String perms;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;菜单图标&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String icon;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long createBy;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(fill = FieldFill.INSERT)</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long updateBy;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(fill = FieldFill.INSERT_UPDATE)</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime updateTime;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;删除标志（0代表未删除 1代表已删除）&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer deleted;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;备注&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String remark;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.adalucky.modules.system.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.adalucky.modules.system.model.entity.SysMenu;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ada</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> JDK17</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 菜单表 Mapper 接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2022-04-26 00:06:11</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SysMenuMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;SysMenu&gt; &#123;</span><br><span class="line">    Set&lt;String&gt; <span class="title function_">selectPermsByUserId</span><span class="params">(Integer id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span><br><span class="line">&lt;mapper namespace=&quot;com.adalucky.modules.system.mapper.SysMenuMapper&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;select id=&quot;selectPermsByUserId&quot; resultType=&quot;java.lang.String&quot;&gt;</span><br><span class="line">        SELECT DISTINCT M.perms</span><br><span class="line">        FROM `sys_user_role` UR</span><br><span class="line">                 LEFT JOIN `sys_role` R ON UR.role_id = R.id</span><br><span class="line">                 LEFT JOIN `sys_role_menu` RM ON UR.role_id = RM.role_id</span><br><span class="line">                 LEFT JOIN `sys_menu` M ON RM.menu_id = M.id</span><br><span class="line">        WHERE UR.user_id = #&#123;id&#125;</span><br><span class="line">          AND M.`status` = &#x27;0&#x27;</span><br><span class="line">          AND R.`status` = &#x27;0&#x27;</span><br><span class="line">    &lt;/select&gt;</span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure>



<h1 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h1><h2 id="简介-2"><a href="#简介-2" class="headerlink" title="简介"></a>简介</h2><ol>
<li>我们还希望在认证失败或者是授权失败的情况下也能和我们的接口一样返回相同结构的json，这样可以让前端能对响应进行统一的处理。要实现这个功能我们需要知道SpringSecurity的异常处理机制。</li>
<li>在SpringSecurity中，如果我们在认证或者授权的过程中<code>出现了异常会被ExceptionTranslationFilter捕获到</code>。在<code>ExceptionTranslationFilter中会去判断</code>是认证失败还是授权失败出现的异常。</li>
<li>如果是<code>认证过程中出现的异常</code>会被封装成AuthenticationException然后<code>调用AuthenticationEntryPoint</code>对象的方法去进行异常处理。</li>
<li>如果是<code>授权过程中出现的异常</code>会被封装成AccessDeniedException然后调用<code>AccessDeniedHandle</code>对象的方法去进行异常处理。</li>
<li>所以如果我们需要自定义异常处理，我们只需要自定义AuthenticationEntryPoint和AccessDeniedHandler然后配置给SpringSecurity即可。</li>
</ol>
<h2 id="自定义实现"><a href="#自定义实现" class="headerlink" title="自定义实现"></a>自定义实现</h2><ol>
<li>需要重写两个实现类</li>
<li>注意如果有全局异常处理，并且捕获的异常类型为 <code>Exception</code> 或者包含了下面实现类抛出的异常，全局的异常捕获会覆盖掉当前的自定义，给你的感觉就像是没有生效</li>
<li><strong>记得要注入到容器</strong><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.adalucky.handler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.adalucky.response.Result;</span><br><span class="line"><span class="keyword">import</span> com.adalucky.utils.web.WebUtils;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.AuthenticationException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.AuthenticationEntryPoint;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ada</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> JDK17</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 自定义用户认证失败异常</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2022/4/27 21:37</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthenticationEntryPointImpl</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationEntryPoint</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commence</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException authException)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">result</span> <span class="operator">=</span> Result.error(<span class="literal">false</span>, HttpStatus.UNAUTHORIZED.value(), <span class="string">&quot;用户认证失败,请重新登录&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> JSON.toJSONString(result);</span><br><span class="line">        <span class="comment">//处理异常</span></span><br><span class="line">        WebUtils.renderString(response, json);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.adalucky.handler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.adalucky.response.Result;</span><br><span class="line"><span class="keyword">import</span> com.adalucky.utils.web.WebUtils;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.access.AccessDeniedException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.access.AccessDeniedHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ada</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> JDK17</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 自定义权限认证失败异常</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2022/4/27 21:40</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccessDeniedHandlerImpl</span> <span class="keyword">implements</span> <span class="title class_">AccessDeniedHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AccessDeniedException accessDeniedException)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">result</span> <span class="operator">=</span> Result.error(<span class="literal">false</span>, HttpStatus.FORBIDDEN.value(), <span class="string">&quot;您的权限不足,请联系管理员开通权限&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> JSON.toJSONString(result);</span><br><span class="line">        <span class="comment">//处理异常</span></span><br><span class="line">        WebUtils.renderString(response, json);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="配置类-2"><a href="#配置类-2" class="headerlink" title="配置类"></a>配置类</h2><p>在之前的配置类中加入配置容器中要注入接口 <code>AuthenticationEntryPoint</code> <code>AccessDeniedHandler</code> 然后调用 <code>http.exceptionHandling()</code> 下对应的配置项</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.adalucky.auth;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.adalucky.filter.JwtAuthenticationTokenFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.http.SessionCreationPolicy;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.AuthenticationEntryPoint;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.access.AccessDeniedHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ada</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> JDK17</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> SpringBoot Security自动配置类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2022/3/7 21:37</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity(prePostEnabled = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> JwtAuthenticationTokenFilter jwtAuthenticationTokenFilter;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AuthenticationEntryPoint authenticationEntryPoint;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AccessDeniedHandler accessDeniedHandler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WebSecurityConfig</span><span class="params">(JwtAuthenticationTokenFilter jwtAuthenticationTokenFilter, AuthenticationEntryPoint authenticationEntryPoint, AccessDeniedHandler accessDeniedHandler)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.jwtAuthenticationTokenFilter = jwtAuthenticationTokenFilter;</span><br><span class="line">        <span class="built_in">this</span>.authenticationEntryPoint = authenticationEntryPoint;</span><br><span class="line">        <span class="built_in">this</span>.accessDeniedHandler = accessDeniedHandler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//创建 CryptPasswordEncoder 注入到容器中，让 Spring Sercurity 默认以该方式进行加密</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> AuthenticationManager <span class="title function_">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//重写这个认证方法，返回父类的认证方法，也就是逻辑还是原来的逻辑，目的是为了注入到 bean 后我们可以在登录的时候去调用这个对象的认证方法</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.authenticationManagerBean();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http</span><br><span class="line">                <span class="comment">//关闭csrf</span></span><br><span class="line">                .csrf().disable()</span><br><span class="line">                <span class="comment">//不通过Session获取SecurityContext</span></span><br><span class="line">                .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)</span><br><span class="line">                .and()</span><br><span class="line">                <span class="comment">//开始设置请求认证规则</span></span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                <span class="comment">//对于登录接口、注册接口 允许匿名访问</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/user/login&quot;</span>, <span class="string">&quot;/user/register&quot;</span>).anonymous()</span><br><span class="line">                <span class="comment">//其它的请求，任意用户认证通过后都可访问</span></span><br><span class="line">                .anyRequest().authenticated();</span><br><span class="line">        <span class="comment">//在UsernamePasswordAuthenticationFilter 过滤器前添加我们的自己写的 JWT 认证过滤器</span></span><br><span class="line">        http.addFilterBefore(jwtAuthenticationTokenFilter, UsernamePasswordAuthenticationFilter.class);</span><br><span class="line">        <span class="comment">//配置异常处理器</span></span><br><span class="line">        http.exceptionHandling()</span><br><span class="line">                <span class="comment">//配置认证失败、授权失败处理器 </span></span><br><span class="line">                .authenticationEntryPoint(authenticationEntryPoint)</span><br><span class="line">                .accessDeniedHandler(accessDeniedHandler);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="跨域"><a href="#跨域" class="headerlink" title="跨域"></a>跨域</h1><h2 id="简介-3"><a href="#简介-3" class="headerlink" title="简介"></a>简介</h2><ol>
<li>浏览器出于安全的考虑，使用 XMLHttpRequest对象发起 HTTP请求时必须遵守同源策略，否则就是跨域的HTTP请求，默认情况下是被禁止的。 同源策略要求源相同才能正常进行通信，即协议、域名、端口号都完全一致。 </li>
<li>前后端分离项目，前端项目和后端项目一般都不是同源的，所以肯定会存在跨域请求的问题。</li>
<li>所以我们就要处理一下，让前端能进行跨域请求，总体分两步：1️⃣ 配置 SpringBoot 的跨域策略  2️⃣ Security 配置开启允许跨域(由于我们的资源都会收到Spring Security的保护，所以想要跨域访问还要让Spring Security允许跨域访问。)</li>
</ol>
<h2 id="SpringBoot跨域配置"><a href="#SpringBoot跨域配置" class="headerlink" title="SpringBoot跨域配置"></a>SpringBoot跨域配置</h2><p>当前我的版本为 SpringBoot 2.6.4</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.adalucky.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.cors.CorsConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.cors.UrlBasedCorsConfigurationSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.filter.CorsFilter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ada</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> JDK17</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 新跨域配置方案不然 SpringBoot2.6.x 访问会有一些报错</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2022/3/19 19:34</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CrosConfig</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> CorsConfiguration <span class="title function_">corsConfig</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">CorsConfiguration</span> <span class="variable">corsConfiguration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorsConfiguration</span>();</span><br><span class="line">        corsConfiguration.addAllowedOriginPattern(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">        corsConfiguration.addAllowedHeader(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">        corsConfiguration.addAllowedMethod(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">        corsConfiguration.setAllowCredentials(<span class="literal">true</span>);</span><br><span class="line">        corsConfiguration.setMaxAge(<span class="number">3600L</span>);</span><br><span class="line">        <span class="keyword">return</span> corsConfiguration;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CorsFilter <span class="title function_">corsFilter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">UrlBasedCorsConfigurationSource</span> <span class="variable">source</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UrlBasedCorsConfigurationSource</span>();</span><br><span class="line">        source.registerCorsConfiguration(<span class="string">&quot;/**&quot;</span>, corsConfig());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CorsFilter</span>(source);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Spring-Security跨域开启"><a href="#Spring-Security跨域开启" class="headerlink" title="Spring Security跨域开启"></a>Spring Security跨域开启</h2><p>实际发现我上面的配置以后这里不开启也是能跨域的，估计和版本以及我上面注入了那个 Bean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//允许跨域</span></span><br><span class="line">http.cors();</span><br></pre></td></tr></table></figure>

<h1 id="其它权限认证方式"><a href="#其它权限认证方式" class="headerlink" title="其它权限认证方式"></a>其它权限认证方式</h1><h2 id="简介-4"><a href="#简介-4" class="headerlink" title="简介"></a>简介</h2><ol>
<li>在上面我们想认证一个用户是否有接口的访问权限，我们的方式是在入Spring Security 的配置类上添加一个注解 <code>@EnableGlobalMethodSecurity(prePostEnabled = true)</code> 然后在接口上添加注解<code>@PreAuthorize(&quot;hasAuthority(&#39;你的权限关键字&#39;)&quot;)</code> 来进行实现的，这里的本质是一种 <code>SPEL</code> 的表达式</li>
<li>我们前面都是使用@PreAuthorize注解，然后在在其中使用的是hasAuthority方法进行校验。SpringSecurity还为我们提供了其它方法例如：hasAnyAuthority，hasRole，hasAnyRole等。</li>
<li>可以通过 DEBUG 去理解hasAuthority的原理，hasAuthority方法实际是执行到了SecurityExpressionRoot的hasAuthority，大家只要断点调试既可知道它内部的校验原理。</li>
<li>它内部其实是调用authentication的getAuthorities方法获取用户的权限列表。然后判断我们存入的方法参数数据在权限列表中。</li>
<li>hasAuthority 还是最好用的</li>
</ol>
<h2 id="hasAnyAuthority"><a href="#hasAnyAuthority" class="headerlink" title="hasAnyAuthority"></a>hasAnyAuthority</h2><p>hasAnyAuthority方法可以传入多个权限，只有用户有其中任意一个权限都可以访问对应资源</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PreAuthorize(&quot;hasAnyAuthority(&#x27;admin&#x27;,&#x27;test&#x27;,&#x27;system:dept:list&#x27;)&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="hasRole"><a href="#hasRole" class="headerlink" title="hasRole"></a>hasRole</h2><ol>
<li>hasRole 要求有对应的角色才可以访问，但是它内部会把我们传入的参数拼接上 <strong>ROLE_</strong> 后再去比较。所以这种情况下要用用户对应的权限也要有 <strong>ROLE_</strong> 这个前缀才可以。</li>
<li>也就是说如果使用这个方法做权限校验，那么在我们数据库存储的权限标识符 <code>system:dept:list</code> –&gt; <code>ROLE_system:dept:list</code><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PreAuthorize(&quot;hasRole(&#x27;system:dept:list&#x27;)&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="hasAnyRole"><a href="#hasAnyRole" class="headerlink" title="hasAnyRole"></a>hasAnyRole</h2><p>hasAnyRole 有任意的角色就可以访问。它内部也会把我们传入的参数拼接上 <strong>ROLE_</strong> 后再去比较。所以这种情况下要用用户对应的权限也要有 <strong>ROLE_</strong> 这个前缀才可以。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PreAuthorize(&quot;hasAnyRole(&#x27;admin&#x27;,&#x27;system:dept:list&#x27;)&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="自定义认证方法"><a href="#自定义认证方法" class="headerlink" title="自定义认证方法"></a>自定义认证方法</h2><h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><ol>
<li>上面的原理就是在@PreAuthorize注解中加入 Spring Security自带的认证方法，然后传入一个或者多个参数</li>
<li>那么我们也可以定义自己的权限校验方法，在@PreAuthorize注解中使用我们的方法</li>
</ol>
<h3 id="方法实现"><a href="#方法实现" class="headerlink" title="方法实现"></a>方法实现</h3><ol>
<li>Component 需要起一个别名，到时候获取这个 Bean 的时候就通过这个别名来引用</li>
<li>这个里面只是一个简单的示例，可以以把 集合是否包含换成模糊匹配最终返回一个布尔值，比如接口中定义调用的时候传入的是  system:* 那么就表示 这个用户有 sytem 下的所有权限（大概就是这种，有可能会用到，我这里暂时不涉及就不实现了）<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component(&quot;automation&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExpressionRoot</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasAuthority</span><span class="params">(String authority)</span>&#123;</span><br><span class="line">        <span class="comment">//获取当前用户的权限</span></span><br><span class="line">        <span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line">        <span class="type">LoginUser</span> <span class="variable">loginUser</span> <span class="operator">=</span> (LoginUser) authentication.getPrincipal();</span><br><span class="line">        Set&lt;String&gt; permissions = loginUser.getPermissions();</span><br><span class="line">        <span class="comment">//判断用户权限集合中是否存在authority</span></span><br><span class="line">        <span class="keyword">return</span> permissions.contains(authority);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h3><p>在SPEL表达式中使用 @automation 相当于获取容器中bean的名字为 automation 的对象。然后再调用这个对象的hasAuthority方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line"><span class="meta">@PreAuthorize(&quot;@automation.hasAuthority(&#x27;system:dept:list&#x27;)&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="配置文件认证"><a href="#配置文件认证" class="headerlink" title="配置文件认证"></a>配置文件认证</h3><ol>
<li>上面我们都是通过注解来实现，之前也提到过认证一般有两种，一种是注解，一种是配置，配置一般用于对静态文件，但是也可以对接口进行这样的权限认证</li>
<li>示例如下，这里可以把所有需要权限校验的接口都配上，看个人喜好，可以在这里全配上或者在接口加注解<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http.authorizeRequests().antMatchers(<span class="string">&quot;/user/list&quot;</span>).hasAuthority(<span class="string">&quot;system:user:list&quot;</span>);</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h1><h2 id="CSRF"><a href="#CSRF" class="headerlink" title="CSRF"></a>CSRF</h2><ol>
<li>CSRF是指跨站请求伪造（Cross-site request forgery），是web常见的攻击之一</li>
<li>SpringSecurity去防止CSRF攻击的方式就是通过csrf_token。后端会生成一个csrf_token，前端发起请求的时候需要携带这个csrf_token,后端会有过滤器进行校验，如果没有携带或者是伪造的就不允许访问。</li>
<li>我们可以发现CSRF攻击依靠的是cookie中所携带的认证信息。但是在前后端分离的项目中我们的认证信息其实是token，而token并不是存储中cookie中，并且需要前端代码去把token设置到请求头中才可以，所以CSRF攻击也就不用担心了。所以我们就关掉了，因为我们请求的时候也没带 csrf_token 不关闭反而认证不通过</li>
</ol>
<h2 id="自定义处理器"><a href="#自定义处理器" class="headerlink" title="自定义处理器"></a>自定义处理器</h2><p>以下的这些方案的前是不采用我们上面哪一套设计方案，因为我们上面那一套方案重新了很多过滤器的方法，调用的和默认的不一样，所以在这里可能就无效了，没有去执行父类的 super 默认配置项</p>
<h3 id="认证成功处理器"><a href="#认证成功处理器" class="headerlink" title="认证成功处理器"></a>认证成功处理器</h3><ol>
<li>实际上在UsernamePasswordAuthenticationFilter进行登录认证的时候，如果登录成功了是会调用AuthenticationSuccessHandler的方法进行认证成功后的处理的。AuthenticationSuccessHandler就是登录成功处理器。</li>
<li>我们也可以自己去自定义成功处理器进行成功后的相应处理。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SGSuccessHandler</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationSuccessHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAuthenticationSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;认证成功了&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationSuccessHandler successHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.formLogin().successHandler(successHandler);</span><br><span class="line"></span><br><span class="line">        http.authorizeRequests().anyRequest().authenticated();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="认证失败处理器"><a href="#认证失败处理器" class="headerlink" title="认证失败处理器"></a>认证失败处理器</h3><ol>
<li>实际上在UsernamePasswordAuthenticationFilter进行登录认证的时候，如果认证失败了是会调用AuthenticationFailureHandler的方法进行认证失败后的处理的。AuthenticationFailureHandler就是登录失败处理器。</li>
<li>我们也可以自己去自定义失败处理器进行失败后的相应处理。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SGFailureHandler</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationFailureHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAuthenticationFailure</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;认证失败了&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationSuccessHandler successHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationFailureHandler failureHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.formLogin()</span><br><span class="line"><span class="comment">//                配置认证成功处理器</span></span><br><span class="line">                .successHandler(successHandler)</span><br><span class="line"><span class="comment">//                配置认证失败处理器</span></span><br><span class="line">                .failureHandler(failureHandler);</span><br><span class="line"></span><br><span class="line">        http.authorizeRequests().anyRequest().authenticated();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="登出成功处理器"><a href="#登出成功处理器" class="headerlink" title="登出成功处理器"></a>登出成功处理器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SGLogoutSuccessHandler</span> <span class="keyword">implements</span> <span class="title class_">LogoutSuccessHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onLogoutSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;注销成功&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationSuccessHandler successHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationFailureHandler failureHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LogoutSuccessHandler logoutSuccessHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.formLogin()</span><br><span class="line"><span class="comment">//                配置认证成功处理器</span></span><br><span class="line">                .successHandler(successHandler)</span><br><span class="line"><span class="comment">//                配置认证失败处理器</span></span><br><span class="line">                .failureHandler(failureHandler);</span><br><span class="line"></span><br><span class="line">        http.logout()</span><br><span class="line">                <span class="comment">//配置注销成功处理器</span></span><br><span class="line">                .logoutSuccessHandler(logoutSuccessHandler);</span><br><span class="line"></span><br><span class="line">        http.authorizeRequests().anyRequest().authenticated();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.3001.net/images/20210606/16229390604952.png" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.3001.net/images/20210606/16229390604952.png" title="头像" alt="头像"></a><div class="post-copyright__author_name">Ada</div><div class="post-copyright__author_desc"></div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://adalucky.github.io/worker/Backender/SpringSecurity/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://adalucky.github.io/worker/Backender/SpringSecurity/')">Spring Security 5.X</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="https://automation-manage.oss-cn-shanghai.aliyuncs.com/blog/wechat.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://automation-manage.oss-cn-shanghai.aliyuncs.com/blog/wechat.png" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="https://automation-manage.oss-cn-shanghai.aliyuncs.com/blog/alipay.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://automation-manage.oss-cn-shanghai.aliyuncs.com/blog/alipay.png" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://adalucky.github.io/worker/Backender/SpringSecurity/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=Spring Security 5.X&amp;url=https://adalucky.github.io/worker/Backender/SpringSecurity/&amp;pic=https://automation-manage.oss-cn-shanghai.aliyuncs.com/blog/auto/SpringSecurity.jpg" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="rm.copyPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://adalucky.github.io" target="_blank">Ada</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"></div></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/worker/Backender/OSS/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://automation-manage.oss-cn-shanghai.aliyuncs.com/blog/auto/oss.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">aliOss</div></div></a></div><div class="next-post pull-right"><a href="/worker/Developer/HTML/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://automation-manage.oss-cn-shanghai.aliyuncs.com/blog/auto/HTML5.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">HTML</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-top" title="点击展开"><div class="card-info-avatar"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.3001.net/images/20210606/16229390604952.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div></div></div><div class="author-info__description">我的个人博客</div></div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat" onclick="null"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background: url(https://bu.dusays.com/2023/01/13/63c02edf44033.png) center center / 100% no-repeat"></div><div class="back face" style="background: url(https://automation-manage.oss-cn-shanghai.aliyuncs.com/blog/jqqdgzh.png) center center / 100% no-repeat"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%A7%86%E9%A2%91"><span class="toc-number">1.1.</span> <span class="toc-text">参考视频</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E8%A7%88"><span class="toc-number">2.</span> <span class="toc-text">总览</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81"><span class="toc-number">3.</span> <span class="toc-text">认证</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">4.</span> <span class="toc-text">准备工作</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BE%9D%E8%B5%96%E5%87%86%E5%A4%87"><span class="toc-number">4.1.</span> <span class="toc-text">依赖准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="toc-number">4.2.</span> <span class="toc-text">配置类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="toc-number">4.3.</span> <span class="toc-text">工具类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E9%85%8D%E7%BD%AE"><span class="toc-number">4.4.</span> <span class="toc-text">数据库配置</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.</span> <span class="toc-text">核心代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%93%E8%A1%A8%E5%88%9B%E5%BB%BA"><span class="toc-number">5.1.</span> <span class="toc-text">库表创建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%87%8D%E5%86%99%E6%8E%A5%E5%8F%A3%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">5.2.</span> <span class="toc-text">重写接口的方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8"><span class="toc-number">5.3.</span> <span class="toc-text">启动</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">5.3.1.</span> <span class="toc-text">测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90"><span class="toc-number">5.3.2.</span> <span class="toc-text">问题分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">5.3.3.</span> <span class="toc-text">解决方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E6%8E%A5%E5%8F%A3%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.4.</span> <span class="toc-text">登录接口实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-number">5.4.1.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%B1%BB-1"><span class="toc-number">5.4.2.</span> <span class="toc-text">配置类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.4.3.</span> <span class="toc-text">实现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#JWT%E8%AE%A4%E8%AF%81%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">6.</span> <span class="toc-text">JWT认证过滤器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%AE%A4%E8%AF%81%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">6.1.</span> <span class="toc-text">创建认证过滤器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0JWT-%E8%AE%A4%E8%AF%81%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">6.2.</span> <span class="toc-text">添加JWT 认证过滤器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81"><span class="toc-number">6.3.</span> <span class="toc-text">验证</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%99%BB%E5%87%BA%E6%93%8D%E4%BD%9C"><span class="toc-number">7.</span> <span class="toc-text">登出操作</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E9%A1%B9%E7%AE%80%E4%BB%8B"><span class="toc-number">8.</span> <span class="toc-text">配置项简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9D%83%E9%99%90"><span class="toc-number">9.</span> <span class="toc-text">权限</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E7%B3%BB%E7%BB%9F%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">9.1.</span> <span class="toc-text">权限系统的作用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%88%E6%9D%83%E5%9F%BA%E6%9C%AC%E6%B5%81%E7%A8%8B"><span class="toc-number">9.2.</span> <span class="toc-text">授权基本流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%88%E6%9D%83%E5%AE%9E%E7%8E%B0"><span class="toc-number">9.3.</span> <span class="toc-text">授权实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E9%99%90%E5%88%B6%E8%AE%BF%E9%97%AE%E6%9D%83%E9%99%90"><span class="toc-number">9.3.1.</span> <span class="toc-text">接口限制访问权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%81%E8%A3%85%E6%9D%83%E9%99%90%E4%BF%A1%E6%81%AF"><span class="toc-number">9.3.2.</span> <span class="toc-text">封装权限信息</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RBAC%E6%9D%83%E9%99%90%E6%A8%A1%E5%9E%8B"><span class="toc-number">10.</span> <span class="toc-text">RBAC权限模型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-1"><span class="toc-number">10.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BB%BA%E8%A1%A8"><span class="toc-number">10.2.</span> <span class="toc-text">建表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-1"><span class="toc-number">10.3.</span> <span class="toc-text">实现</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">11.</span> <span class="toc-text">异常处理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-2"><span class="toc-number">11.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AE%9E%E7%8E%B0"><span class="toc-number">11.2.</span> <span class="toc-text">自定义实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%B1%BB-2"><span class="toc-number">11.3.</span> <span class="toc-text">配置类</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B7%A8%E5%9F%9F"><span class="toc-number">12.</span> <span class="toc-text">跨域</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-3"><span class="toc-number">12.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringBoot%E8%B7%A8%E5%9F%9F%E9%85%8D%E7%BD%AE"><span class="toc-number">12.2.</span> <span class="toc-text">SpringBoot跨域配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-Security%E8%B7%A8%E5%9F%9F%E5%BC%80%E5%90%AF"><span class="toc-number">12.3.</span> <span class="toc-text">Spring Security跨域开启</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%B6%E5%AE%83%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81%E6%96%B9%E5%BC%8F"><span class="toc-number">13.</span> <span class="toc-text">其它权限认证方式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-4"><span class="toc-number">13.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#hasAnyAuthority"><span class="toc-number">13.2.</span> <span class="toc-text">hasAnyAuthority</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#hasRole"><span class="toc-number">13.3.</span> <span class="toc-text">hasRole</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#hasAnyRole"><span class="toc-number">13.4.</span> <span class="toc-text">hasAnyRole</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AE%A4%E8%AF%81%E6%96%B9%E6%B3%95"><span class="toc-number">13.5.</span> <span class="toc-text">自定义认证方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF"><span class="toc-number">13.5.1.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E5%AE%9E%E7%8E%B0"><span class="toc-number">13.5.2.</span> <span class="toc-text">方法实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%95%E7%94%A8"><span class="toc-number">13.5.3.</span> <span class="toc-text">引用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AE%A4%E8%AF%81"><span class="toc-number">13.5.4.</span> <span class="toc-text">配置文件认证</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%B6%E5%AE%83"><span class="toc-number">14.</span> <span class="toc-text">其它</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#CSRF"><span class="toc-number">14.1.</span> <span class="toc-text">CSRF</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">14.2.</span> <span class="toc-text">自定义处理器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E6%88%90%E5%8A%9F%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">14.2.1.</span> <span class="toc-text">认证成功处理器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E5%A4%B1%E8%B4%A5%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">14.2.2.</span> <span class="toc-text">认证失败处理器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%99%BB%E5%87%BA%E6%88%90%E5%8A%9F%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">14.2.3.</span> <span class="toc-text">登出成功处理器</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/worker/Toolbox/Hexo/" title="Hexo"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://automation-manage.oss-cn-shanghai.aliyuncs.com/blog/other/hexo.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Hexo"/></a><div class="content"><a class="title" href="/worker/Toolbox/Hexo/" title="Hexo">Hexo</a><time datetime="2023-08-14T16:00:00.000Z" title="发表于 2023-08-15 00:00:00">2023-08-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/worker/Backender/MongoDB/" title="MongoDB"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://automation-manage.oss-cn-shanghai.aliyuncs.com/blog/mongodb.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MongoDB"/></a><div class="content"><a class="title" href="/worker/Backender/MongoDB/" title="MongoDB">MongoDB</a><time datetime="2023-07-04T16:00:00.000Z" title="发表于 2023-07-05 00:00:00">2023-07-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/worker/Ops/Docker%20Compose/" title="Docker Compose"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://automation-manage.oss-cn-shanghai.aliyuncs.com/blog/docker-compose.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Docker Compose"/></a><div class="content"><a class="title" href="/worker/Ops/Docker%20Compose/" title="Docker Compose">Docker Compose</a><time datetime="2023-06-26T16:00:00.000Z" title="发表于 2023-06-27 00:00:00">2023-06-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/worker/Ops/Linux%E5%91%BD%E4%BB%A4/" title="Linux 命令"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://automation-manage.oss-cn-shanghai.aliyuncs.com/blog/linux.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux 命令"/></a><div class="content"><a class="title" href="/worker/Ops/Linux%E5%91%BD%E4%BB%A4/" title="Linux 命令">Linux 命令</a><time datetime="2023-06-26T16:00:00.000Z" title="发表于 2023-06-27 00:00:00">2023-06-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/worker/Ops/asdf%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E7%AE%A1%E7%90%86/" title="asdf"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://automation-manage.oss-cn-shanghai.aliyuncs.com/blog/asdf.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="asdf"/></a><div class="content"><a class="title" href="/worker/Ops/asdf%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E7%AE%A1%E7%90%86/" title="asdf">asdf</a><time datetime="2023-06-13T16:00:00.000Z" title="发表于 2023-06-14 00:00:00">2023-06-14</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2023 By <a class="footer-bar-link" href="/" title="Ada" target="_blank">Ada</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div></div></div><div id="sidebar"><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.3001.net/images/20210606/16229390604952.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">56</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">75</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">8</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/archives/"><span> 总览</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/categories/"><span> 分类</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/tags/"><span> 标签</span></a></div></div></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="chat_btn" type="button" title="聊天"><i class="anzhiyufont anzhiyu-icon-comment-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><a id="switch_commentBarrage" href="javascript:anzhiyu.switchCommentBarrage();" title="开关弹幕"><i class="anzhiyufont anzhiyu-icon-danmu"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.20/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.3.1/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.cbd.int/pangu@4.0.7/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("07/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.5.4",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#3b70fc",
      "",
      "color:#3b70fc",
      "color:#3b70fc",
      "",
      "color:#3b70fc",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 Ada 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="https://cdn.cbd.int/algoliasearch@4.18.0/dist/algoliasearch-lite.umd.js"></script><script src="https://cdn.cbd.int/instantsearch.js@4.56.5/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'HvNn2fnND9DnBkt32cvR8g5x-gzGzoHsz',
      appKey: '1FgE4n7EeWrdtvsJCcB20dfD',
      avatar: 'mp',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.cbd.int/valine@1.5.1/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) anzhiyu.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script src="https://cdn.cbd.int/blueimp-md5@2.19.0/js/md5.min.js"></script><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getIcon = (icon, mail) => {
    if (icon) return icon
    let defaultIcon = '?d=mp'
    let iconUrl = `https://gravatar.loli.net/avatar/${md5(mail.toLowerCase()) + defaultIcon}`
    return iconUrl
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom.innerHTML= result
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = () => {
    const serverURL = 'https://HvNn2fnN.api.lncldglobal.com'

    var settings = {
      "method": "GET",
      "headers": {
        "X-LC-Id": 'HvNn2fnND9DnBkt32cvR8g5x-gzGzoHsz',
        "X-LC-Key": '1FgE4n7EeWrdtvsJCcB20dfD',
        "Content-Type": "application/json"
      },
    }

    fetch(`${serverURL}/1.1/classes/Comment?limit=6&order=-createdAt`,settings)
      .then(response => response.json())
      .then(data => {
        const valineArray = data.results.map(function (e) {
          return {
            'avatar': getIcon(e.QQAvatar, e.mail),
            'content': changeContent(e.comment),
            'nick': e.nick,
            'url': e.url + '#' + e.objectId,
            'date': e.updatedAt,
          }
        })
        saveToLocal.set('valine-newest-comments', JSON.stringify(valineArray), 10/(60*24))
        generateHtml(valineArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.innerHTML= "无法获取评论，请确认相关配置是否正确"
      }) 
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('valine-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script>var visitorMail = "visitor@anheyu.com";</script><script>//动态标题
let leaveTitle = 'w(ﾟДﾟ)w 不要走！再看看嘛！';
let backTitle = '♪(^∇^*)欢迎肥来！';
let OriginTitile = document.title
let titleTime
document.addEventListener('visibilitychange', function () {
  if (document.hidden) {
    //离开当前页面时标签显示内容
    document.title = leaveTitle
    clearTimeout(titleTime)
  } else {
    //返回当前页面时标签显示内容
    document.title = backTitle + OriginTitile
    //两秒后变回正常标题
    titleTime = setTimeout(function () {
      document.title = OriginTitile
    }, 2000)
  }
})</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script>// 初始化函数
let rm = {};

//禁止图片与超链接拖拽
let aElements = document.getElementsByTagName("a");
for (let i = 0; i < aElements.length; i++) {
  aElements[i].setAttribute("draggable", "false");
  let imgElements = aElements[i].getElementsByTagName("img");
  for (let j = 0; j < imgElements.length; j++) {
    imgElements[j].setAttribute("draggable", "false");
  }
}

// 显示菜单
rm.showRightMenu = function (isTrue, x = 0, y = 0) {
  console.info(x, y)
  let rightMenu = document.getElementById("rightMenu");
  rightMenu.style.top = x + "px";
  rightMenu.style.left = y + "px";
  if (isTrue) {
    rightMenu.style.display = "block";
    stopMaskScroll();
  } else {
    rightMenu.style.display = "none";
  }
};

// 隐藏菜单
rm.hideRightMenu = function () {
  rm.showRightMenu(false);
  let rightMenuMask = document.querySelector("#rightmenu-mask");
  rightMenuMask.style.display = "none";
};

// 尺寸
let rmWidth = document.getElementById("rightMenu").offsetWidth;
let rmHeight = document.getElementById("rightMenu").offsetHeight;

// 重新定义尺寸
rm.reloadrmSize = function () {
  rightMenu.style.visibility = "hidden";
  rightMenu.style.display = "block";
  // 获取宽度和高度
  rmWidth = document.getElementById("rightMenu").offsetWidth;
  rmHeight = document.getElementById("rightMenu").offsetHeight;
  rightMenu.style.visibility = "visible";
};

// 获取点击的href
let domhref = "";
let domImgSrc = "";
let globalEvent = null;

var oncontextmenuFunction = function (event) {
  if (document.body.clientWidth > 768) {
    let pageX = event.clientX + 10; //加10是为了防止显示时鼠标遮在菜单上
    let pageY = event.clientY;

    //其他额外菜单
    const $rightMenuOther = document.querySelector(".rightMenuOther");
    const $rightMenuPlugin = document.querySelector(".rightMenuPlugin");
    const $rightMenuCopyText = document.querySelector("#menu-copytext");
    const $rightMenuPasteText = document.querySelector("#menu-pastetext");
    const $rightMenuCommentText = document.querySelector("#menu-commenttext");
    const $rightMenuNewWindow = document.querySelector("#menu-newwindow");
    const $rightMenuNewWindowImg = document.querySelector("#menu-newwindowimg");
    const $rightMenuCopyLink = document.querySelector("#menu-copylink");
    const $rightMenuCopyImg = document.querySelector("#menu-copyimg");
    const $rightMenuDownloadImg = document.querySelector("#menu-downloadimg");
    const $rightMenuSearch = document.querySelector("#menu-search");
    const $rightMenuSearchBaidu = document.querySelector("#menu-searchBaidu");
    const $rightMenuMusicToggle = document.querySelector("#menu-music-toggle");
    const $rightMenuMusicBack = document.querySelector("#menu-music-back");
    const $rightMenuMusicForward = document.querySelector("#menu-music-forward");
    const $rightMenuMusicPlaylist = document.querySelector("#menu-music-playlist");
    const $rightMenuMusicCopyMusicName = document.querySelector("#menu-music-copyMusicName");

    let href = event.target.href;
    let imgsrc = event.target.currentSrc;

    // 判断模式 扩展模式为有事件
    let pluginMode = false;
    $rightMenuOther.style.display = "block";
    globalEvent = event;

    // 检查是否需要复制 是否有选中文本
    if (selectTextNow && window.getSelection()) {
      pluginMode = true;
      $rightMenuCopyText.style.display = "block";
      $rightMenuCommentText.style.display = "block";
      $rightMenuSearch.style.display = "block";
      $rightMenuSearchBaidu.style.display = "block";
    } else {
      $rightMenuCopyText.style.display = "none";
      $rightMenuCommentText.style.display = "none";
      $rightMenuSearchBaidu.style.display = "none";
      $rightMenuSearch.style.display = "none";
    }

    //检查是否右键点击了链接a标签
    if (href) {
      pluginMode = true;
      $rightMenuNewWindow.style.display = "block";
      $rightMenuCopyLink.style.display = "block";
      domhref = href;
    } else {
      $rightMenuNewWindow.style.display = "none";
      $rightMenuCopyLink.style.display = "none";
    }

    //检查是否需要复制图片
    if (imgsrc) {
      pluginMode = true;
      $rightMenuCopyImg.style.display = "block";
      $rightMenuDownloadImg.style.display = "block";
      $rightMenuNewWindowImg.style.display = "block";
      document.getElementById("rightMenu").style.width="12rem"
      domImgSrc = imgsrc;
    } else {
      $rightMenuCopyImg.style.display = "none";
      $rightMenuDownloadImg.style.display = "none";
      $rightMenuNewWindowImg.style.display = "none";
    }

    // 判断是否为输入框
    if (event.target.tagName.toLowerCase() === "input" || event.target.tagName.toLowerCase() === "textarea") {
      pluginMode = true;
      $rightMenuPasteText.style.display = "block";
    } else {
      $rightMenuPasteText.style.display = "none";
    }
    const navMusicEl = document.querySelector("#nav-music");
    //判断是否是音乐
    if (navMusicEl && navMusicEl.contains(event.target)) {
      pluginMode = true;
      $rightMenuMusicToggle.style.display = "block";
      $rightMenuMusicBack.style.display = "block";
      $rightMenuMusicForward.style.display = "block";
      $rightMenuMusicPlaylist.style.display = "block";
      $rightMenuMusicCopyMusicName.style.display = "block";
    } else {
      $rightMenuMusicToggle.style.display = "none";
      $rightMenuMusicBack.style.display = "none";
      $rightMenuMusicForward.style.display = "none";
      $rightMenuMusicPlaylist.style.display = "none";
      $rightMenuMusicCopyMusicName.style.display = "none";
    }

    // 如果不是扩展模式则隐藏扩展模块
    if (pluginMode) {
      $rightMenuOther.style.display = "none";
      $rightMenuPlugin.style.display = "block";
    } else {
      $rightMenuPlugin.style.display = "none";
    }

    rm.reloadrmSize();

    // 鼠标默认显示在鼠标右下方，当鼠标靠右或靠下时，将菜单显示在鼠标左方\上方
    if (pageX + rmWidth > window.innerWidth) {
      pageX -= rmWidth + 10;
    }
    if (pageY + rmHeight > window.innerHeight) {
      pageY -= pageY + rmHeight - window.innerHeight;
    }

    rm.showRightMenu(true, pageY, pageX);
    document.getElementById("rightmenu-mask").style.display = "flex";
    return false;
  }
};

// 监听右键初始化
window.oncontextmenu = oncontextmenuFunction

// 下载图片状态
rm.downloadimging = false;

// 复制图片到剪贴板
rm.writeClipImg = function (imgsrc) {
  console.log("按下复制");
  rm.hideRightMenu();
  anzhiyu.snackbarShow("正在下载中，请稍后", false, 10000);
  if (rm.downloadimging == false) {
    rm.downloadimging = true;
    setTimeout(function () {
      copyImage(imgsrc);
      anzhiyu.snackbarShow("复制成功！图片已添加盲水印，请遵守版权协议");
      rm.downloadimging = false;
    }, "10000");
  }
};

function imageToBlob(imageURL) {
  const img = new Image();
  const c = document.createElement("canvas");
  const ctx = c.getContext("2d");
  img.crossOrigin = "";
  img.src = imageURL;
  return new Promise(resolve => {
    img.onload = function () {
      c.width = this.naturalWidth;
      c.height = this.naturalHeight;
      ctx.drawImage(this, 0, 0);
      c.toBlob(
        blob => {
          // here the image is a blob
          resolve(blob);
        },
        "image/png",
        0.75
      );
    };
  });
}

async function copyImage(imageURL) {
  const blob = await imageToBlob(imageURL);
  const item = new ClipboardItem({ "image/png": blob });
  navigator.clipboard.write([item]);
}

rm.copyUrl = function (id) {
  const input = document.createElement("input"); // Create a new <input> element
  input.id = "copyVal"; // Set the id of the new element to "copyVal"
  document.body.appendChild(input); // Append the new element to the end of the <body> element
  
  const text = id;
  input.value = text;
  input.select();
  input.setSelectionRange(0, input.value.length);
  document.execCommand("copy");
  
  input.remove(); // Remove the <input> element from the DOM
};

function stopMaskScroll() {
  if (document.getElementById("rightmenu-mask")) {
    let xscroll = document.getElementById("rightmenu-mask");
    xscroll.addEventListener(
      "mousewheel",
      function (e) {
        //阻止浏览器默认方法
        rm.hideRightMenu();
        // e.preventDefault();
      },
      { passive: true }
    );
  }
  if (document.getElementById("rightMenu")) {
    let xscroll = document.getElementById("rightMenu");
    xscroll.addEventListener(
      "mousewheel",
      function (e) {
        //阻止浏览器默认方法
        rm.hideRightMenu();
        // e.preventDefault();
      },
      { passive: true }
    );
  }
}

rm.rightmenuCopyText = function (txt) {
  if (navigator.clipboard) {
    navigator.clipboard.writeText(txt);
  }
  rm.hideRightMenu();
};

rm.copyPageUrl = function (url) {
  if (!url) {
    url = window.location.href;
  }
  rm.copyUrl(url);
  anzhiyu.snackbarShow("复制链接地址成功", false, 2000);
  rm.hideRightMenu();
};

rm.sharePage = function () {
  var content = window.location.href;
  rm.copyUrl(url);
  anzhiyu.snackbarShow("复制链接地址成功", false, 2000);
  rm.hideRightMenu();
};

// 复制当前选中文本
var selectTextNow = "";
document.onmouseup = document.ondblclick = selceText;

function selceText() {
  var txt;
  if (document.selection) {
    txt = document.selection.createRange().text;
  } else {
    txt = window.getSelection().toString();
  }
  selectTextNow = txt !== "" ? txt : "";
}

// 读取剪切板
rm.readClipboard = function () {
  if (navigator.clipboard) {
    navigator.clipboard.readText().then(clipText => rm.insertAtCaret(globalEvent.target, clipText));
  }
};

// 粘贴文本到焦点
rm.insertAtCaret = function (elemt, value) {
  const startPos = elemt.selectionStart,
    endPos = elemt.selectionEnd;
  if (document.selection) {
    elemt.focus();
    var sel = document.selection.createRange();
    sel.text = value;
    elemt.focus();
  } else {
    if (startPos || startPos == "0") {
      var scrollTop = elemt.scrollTop;
      elemt.value = elemt.value.substring(0, startPos) + value + elemt.value.substring(endPos, elemt.value.length);
      elemt.focus();
      elemt.selectionStart = startPos + value.length;
      elemt.selectionEnd = startPos + value.length;
      elemt.scrollTop = scrollTop;
    } else {
      elemt.value += value;
      elemt.focus();
    }
  }
};

//粘贴文本
rm.pasteText = function () {
  const result = rm.readClipboard() || "";
  rm.hideRightMenu();
};

//引用到评论
rm.rightMenuCommentText = function (txt) {
  rm.hideRightMenu();
  const postCommentDom = document.getElementById("post-comment");
  var domTop = postCommentDom.offsetTop;
  window.scrollTo(0, domTop - 80);
  if (txt == "undefined" || txt == "null") txt = "好棒！";
  function setText() {
    setTimeout(() => {
      var input = document.getElementsByClassName("el-textarea__inner")[0];
      if (!input) setText();
      let evt = document.createEvent("HTMLEvents");
      evt.initEvent("input", true, true);
      let inputValue = replaceAll(txt, "\n", "\n> ");
      input.value = "> " + inputValue + "\n\n";
      input.dispatchEvent(evt);
      input.focus();
      input.setSelectionRange(-1, -1);
      if (document.getElementById("comment-tips")) {
        document.getElementById("comment-tips").classList.add("show");
      }
    }, 100);
  }
  setText();
};

//替换所有内容
function replaceAll(string, search, replace) {
  return string.split(search).join(replace);
}

// 百度搜索
rm.searchBaidu = function () {
  anzhiyu.snackbarShow("即将跳转到百度搜索", false, 2000);
  setTimeout(function () {
    window.open("https://www.baidu.com/s?wd=" + selectTextNow);
  }, "2000");
  rm.hideRightMenu();
};

//分享链接
rm.copyLink = function () {
  rm.rightmenuCopyText(domhref);
  anzhiyu.snackbarShow("已复制链接地址");
};

function addRightMenuClickEvent() {
  // 添加点击事件
  document.getElementById("menu-backward").addEventListener("click", function () {
  window.history.back();
    rm.hideRightMenu();
  });

  document.getElementById("menu-forward").addEventListener("click", function () {
    window.history.forward();
    rm.hideRightMenu();
  });

  document.getElementById("menu-refresh").addEventListener("click", function () {
    window.location.reload();
  });

  document.getElementById("menu-top").addEventListener("click", function () {
    anzhiyu.scrollToDest(0, 500);
    rm.hideRightMenu();
  });

  const menuLinks = document.querySelectorAll(".menu-link");
  menuLinks.forEach(function (link) {
    link.addEventListener("click", rm.hideRightMenu);
  });

  document.getElementById("menu-darkmode").addEventListener("click", anzhiyu.switchDarkMode);

  document.getElementById("menu-home") && document.getElementById("menu-home").addEventListener("click", function () {
    window.location.href = window.location.origin;
  });

  document.getElementById("menu-randomPost").addEventListener("click", function () {
    toRandomPost();
  });

  document.getElementById("menu-commentBarrage").addEventListener("click", anzhiyu.switchCommentBarrage);

  document.getElementById("rightmenu-mask").addEventListener("click", rm.hideRightMenu);

  document.getElementById("rightmenu-mask").addEventListener("contextmenu", function (event) {
    rm.hideRightMenu();
    event.preventDefault(); // Prevent the default context menu from appearing
  });

  document.getElementById("menu-copy").addEventListener("click", rm.copyPageUrl);

  document.getElementById("menu-pastetext").addEventListener("click", rm.pasteText);

  document.getElementById("menu-copytext").addEventListener("click", function () {
    rm.rightmenuCopyText(selectTextNow);
    anzhiyu.snackbarShow("复制成功，复制和转载请标注本文地址");
  });

  document.getElementById("menu-commenttext").addEventListener("click", function () {
    rm.rightMenuCommentText(selectTextNow);
  });

  document.getElementById("menu-newwindow").addEventListener("click", function () {
    window.open(domhref, "_blank");
    rm.hideRightMenu();
  });

  document.getElementById("menu-copylink").addEventListener("click", rm.copyLink);

  document.getElementById("menu-downloadimg").addEventListener("click", function () {
    anzhiyu.downloadImage(domImgSrc, "anzhiyu");
  });

  document.getElementById("menu-newwindowimg").addEventListener("click", function () {
    window.open(domImgSrc, "_blank");
    rm.hideRightMenu();
  });

  document.getElementById("menu-copyimg").addEventListener("click", function () {
    rm.writeClipImg(domImgSrc);
  });

  document.getElementById("menu-searchBaidu").addEventListener("click", rm.searchBaidu);

  //音乐
  document.getElementById("menu-music-toggle").addEventListener("click", anzhiyu.musicToggle);

  document.getElementById("menu-music-back").addEventListener("click", anzhiyu.musicSkipBack);

  document.getElementById("menu-music-forward").addEventListener("click", anzhiyu.musicSkipForward);

  document.getElementById("menu-music-copyMusicName").addEventListener("click", function () {
    rm.rightmenuCopyText(anzhiyu.musicGetName());
    anzhiyu.snackbarShow("复制歌曲名称成功", false, 3000);
  });

}

addRightMenuClickEvent();</script><script data-pjax>var themeColorMeta = document.querySelector('meta[name="theme-color"]');
var pageHeaderEl = document.getElementById("page-header");
var navMusicEl = document.getElementById("nav-music");
var consoleEl = document.getElementById("console");
// 已随机的歌曲
var selectRandomSong = [];
// 音乐默认声音大小
var musicVolume = 0.8;
// 是否切换了周杰伦音乐列表
var changeMusicListFlag = false;
// 当前默认播放列表
var defaultPlayMusicList = [];

document.getElementById("page-name").innerText = document.title.split(" | Ada")[0];
anzhiyu.initIndexEssay();
anzhiyu.changeTimeInEssay();
anzhiyu.removeBodyPaceClass();
anzhiyu.qrcodeCreate();
anzhiyu.changeTimeInAlbumDetail();
anzhiyu.reflashEssayWaterFall();
anzhiyu.sayhi();
anzhiyu.stopImgRightDrag();
anzhiyu.addNavBackgroundInit();
anzhiyu.setValueToBodyType();
anzhiyu.catalogActive();
anzhiyu.tagsPageActive();
anzhiyu.categoriesBarActive();
anzhiyu.topCategoriesBarScroll();
anzhiyu.switchRightClickMenuHotReview();
anzhiyu.getCustomPlayList();
anzhiyu.addEventListenerConsoleMusicList(false);
setTimeout(() => {if (typeof addFriendLinksInFooter === "function") {addFriendLinksInFooter();}}, 200)</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><script>(function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/51b8faf5.js","daovoice")
</script><script>var isChatBtn = true
daovoice('init', {
  app_id: '51b8faf5',},{
  launcher: { 
     disableLauncherIcon: isChatBtn // 悬浮 ICON 是否显示
  },
});
daovoice('update');

if (isChatBtn) {
  var chatBtnFn = () => {
    var chatBtn = document.getElementById("chat_btn")
    chatBtn.addEventListener("click", function(){
      daovoice('show')
    });
  }
  chatBtnFn()
} else {
  if (false) {
    function chatBtnHide () {
      daovoice('update', {},{
        launcher: { 
        disableLauncherIcon: true // 悬浮 ICON 是否显示
        },
      });
    }
    function chatBtnShow () {
      daovoice('update', {},{
        launcher: { 
        disableLauncherIcon: false // 悬浮 ICON 是否显示
        },
      });
    }
  }
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div><script>(function (w, d, s, id) {
            if (typeof (w.webpushr) !== 'undefined') return; w.webpushr = w.webpushr || function () { (w.webpushr.q = w.webpushr.q || []).push(arguments) }; var js, fjs = d.getElementsByTagName(s)[0]; js = d.createElement(s); js.id = id; js.async = 1; js.src = "https://cdn.webpushr.com/app.min.js";fjs.parentNode.appendChild(js);}(window, document, 'script', 'webpushr-jssdk'));webpushr('setup', { 'key': 'BJjeD4reRc-1D_UEhL5kJQ8sMsvWDWxrZjvv5Wg1G1OHaFJhaKNKofyRr208shfSmbYfP2v8u9hZ7LlTZ0LnXK0' });</script></body></html>